
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Decide Studio | Media Forge</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <style>
        :root { --bg: #050505; --panel: #111; --text: #eee; --accent: #00e676; --border: #333; --code-bg: #1a1a1a; }
        body { background: var(--bg); color: var(--text); font-family: 'Courier New', monospace; padding: 20px; display: flex; flex-direction: column; align-items: center; min-height: 90vh; }
        
        .console { width: 100%; max-width: 700px; background: var(--panel); border: 1px solid var(--border); padding: 30px; border-radius: 12px; box-shadow: 0 20px 50px rgba(0,0,0,0.5); }
        h1 { margin-top: 0; color: var(--accent); font-size: 1.2rem; text-transform: uppercase; letter-spacing: 2px; border-bottom: 1px solid var(--border); padding-bottom: 15px; display: flex; justify-content: space-between; }
        
        .mode-switch { font-size: 0.8rem; opacity: 0.6; cursor: pointer; }
        .mode-switch:hover { opacity: 1; color: #fff; }

        .input-group { margin: 20px 0; }
        label { display: block; color: #888; font-size: 0.7rem; margin-bottom: 8px; text-transform: uppercase; }
        
        textarea { width: 100%; height: 200px; background: var(--code-bg); border: 1px solid var(--border); color: #0f0; padding: 15px; font-family: 'Courier New', monospace; font-size: 0.85rem; border-radius: 6px; box-sizing: border-box; resize: vertical; }
        textarea:focus { outline: none; border-color: var(--accent); }

        .btn-action { width: 100%; padding: 15px; background: var(--text); color: #000; border: none; font-weight: bold; cursor: pointer; border-radius: 6px; margin-top: 10px; transition: 0.2s; letter-spacing: 1px; }
        .btn-action:hover { background: var(--accent); }

        .log-area { margin-top: 20px; border-top: 1px solid var(--border); padding-top: 15px; font-size: 0.75rem; color: #666; }
        .log-item { margin-bottom: 5px; }
        .success { color: var(--accent); }
        .error { color: #ff4444; }
    </style>
</head>
<body>

    <div class="console">
        <h1>
            <span>‚öóÔ∏è Media Forge</span>
            <span class="mode-switch" onclick="location.reload()">[RESET]</span>
        </h1>
        
        <div class="input-group">
            <label>Input Source (JSON Payload)</label>
            <textarea id="jsonInput" placeholder='Paste your Decide OS JSON here... 
Example: [{"title":"Gravity","summary":"..."}]'></textarea>
        </div>

        <div class="input-group" style="display:flex; gap:10px;">
            <div style="flex:1">
                <label>Session ID (Optional)</label>
                <input type="text" id="sessionId" style="width:100%; background:#111; border:1px solid #333; color:white; padding:10px;" placeholder="SES_...">
            </div>
        </div>

        <button class="btn-action" onclick="forgeNotebookPDF()">GENERATE NOTEBOOK SCRIPT üìÑ</button>

        <div class="log-area" id="consoleLog">
            <div class="log-item">> Waiting for data stream...</div>
        </div>
    </div>

<script>
    const ALCHEMIST_BASE = "https://via-decide.github.io/alchemist_app/";

    const log = (msg, type='') => {
        const d = document.getElementById('consoleLog');
        d.innerHTML += `<div class="log-item ${type}">> ${msg}</div>`;
    };

    async function forgeNotebookPDF() {
        const rawInput = document.getElementById('jsonInput').value.trim();
        let sessionID = document.getElementById('sessionId').value.trim();

        if(!rawInput) return log("Error: JSON payload empty.", "error");
        if(!sessionID) sessionID = "SES_" + Math.random().toString(36).substr(2, 6).toUpperCase();

        try {
            log("Parsing Data Stream...");
            
            // 1. Intelligent Parsing (Handles raw array or Sheet wrapper)
            let parsedData;
            try {
                const temp = JSON.parse(rawInput);
                // If it's the full sheet payload, extract the syllabus
                if (temp.syllabus && typeof temp.syllabus === 'string') {
                    // It might be a double-encoded JSON string if coming from sheet
                    try { parsedData = JSON.parse(temp.syllabus); } 
                    catch { parsedData = temp.syllabus; } // Or just raw text
                } 
                else if (temp.syllabus && Array.isArray(temp.syllabus)) {
                     parsedData = temp.syllabus;
                }
                else {
                    parsedData = temp; // Assume it's the raw array
                }
            } catch (e) {
                throw new Error("Invalid JSON format. Please check syntax.");
            }

            // If parsedData is just a string (Stretch Mode), wrap it
            if (typeof parsedData === 'string') {
                parsedData = [{ title: parsedData, summary: "Deep Dive Topic Request." }];
            }

            if (!Array.isArray(parsedData)) throw new Error("Data must be an array of topics.");

            // 2. Initialize PDF Engine
            log("Initializing NotebookLM Template...", "success");
            const { jsPDF } = window.jspdf;
            const doc = new jsPDF();
            const pageWidth = doc.internal.pageSize.getWidth();
            const pageHeight = doc.internal.pageSize.getHeight();
            const margin = 20;
            let cursorY = 20;

            // 3. Header Construction
            doc.setFont("helvetica", "bold");
            doc.setFontSize(10); 
            doc.setTextColor(100);
            doc.text(`AUDIO BRIEFING SCRIPT | ID: ${sessionID}`, margin, cursorY);
            
            cursorY += 15;
            doc.setFontSize(22); 
            doc.setTextColor(0);
            doc.text("RESEARCH BRIEFING", margin, cursorY);
            
            cursorY += 10;
            doc.setFontSize(12);
            doc.setFont("helvetica", "normal");
            doc.text("Input Source: Decide OS Research Module", margin, cursorY);

            // 4. Content Loop
            cursorY += 20;
            
            parsedData.forEach((item, index) => {
                // Page Break Check
                if (cursorY > pageHeight - 60) {
                    doc.addPage();
                    cursorY = 20;
                }

                // Section Title
                doc.setFont("helvetica", "bold");
                doc.setFontSize(14);
                doc.setTextColor(0, 200, 100); // Green Accent
                doc.text(`[SEGMENT ${index + 1}] ${item.title.toUpperCase()}`, margin, cursorY);
                cursorY += 8;

                // Summary Body
                doc.setFont("times", "normal");
                doc.setFontSize(11);
                doc.setTextColor(0);
                
                // Clean text
                const cleanSummary = item.summary ? item.summary.replace(/<[^>]*>?/gm, '') : "No data provided.";
                const lines = doc.splitTextToSize(cleanSummary, pageWidth - (margin * 2));
                doc.text(lines, margin, cursorY);
                
                cursorY += (lines.length * 5) + 15;
            });

            // 5. Footer (The Alchemist Bridge)
            const masterLink = `${ALCHEMIST_BASE}?mode=portal&session=${sessionID}&syllabus=${encodeURIComponent(parsedData[0].title)}`; // Simplified link

            // Always add new page for the call to action to ensure visibility
            doc.addPage();
            
            doc.setFont("helvetica", "bold");
            doc.setFontSize(18);
            doc.setTextColor(0);
            doc.text("MEDIA PRODUCTION NOTES", margin, 30);

            doc.setFontSize(12);
            doc.setFont("courier", "normal");
            doc.text("1. Upload this PDF to NotebookLM.", margin, 50);
            doc.text("2. Generate Audio Overview.", margin, 60);
            doc.text("3. Paste the YouTube Link below into Google Sheet.", margin, 70);

            // The Box
            doc.setFillColor(240, 240, 240);
            doc.rect(margin, 90, pageWidth - (margin*2), 40, 'F');
            
            doc.setTextColor(0, 0, 255);
            doc.setFontSize(10);
            doc.text("USER ACTION LINK (Include in Video Description):", margin + 5, 100);
            
            doc.setTextColor(0);
            doc.setFontSize(11);
            doc.text(masterLink, margin + 5, 115, { maxWidth: pageWidth - 50 });

            // 6. Save
            const fileName = `Notebook_Source_${sessionID}.pdf`;
            doc.save(fileName);
            log(`Successfully exported: ${fileName}`, "success");

        } catch (e) {
            console.error(e);
            log(e.message, "error");
        }
    }
</script>
</body>
</html>
