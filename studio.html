<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>MEDIA FORGE | Studio v4.5 (JSON Engine)</title>

<script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.4.120/pdf.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>

<style>
:root{
  --bg:#09090b;--panel:#121214;--border:#27272a;
  --text:#e4e4e7;--muted:#a1a1aa;
  --green:#22c55e;--blue:#3b82f6;--purple:#a855f7;
  --font:'Courier New',monospace;
}
*{box-sizing:border-box}
body{
  margin:0;padding:20px;background:var(--bg);color:var(--text);
  font-family:var(--font);display:flex;flex-direction:column;align-items:center;
}
.card{
  width:100%;max-width:900px;background:var(--panel);
  border:1px solid var(--border);border-radius:16px;padding:2rem;
  margin-bottom: 20px;
}
.header{display:flex;justify-content:space-between;margin-bottom:1rem;border-bottom:1px solid var(--border);padding-bottom:10px}


/* ZONES */
.grid-zones { display: grid; grid-template-columns: 1fr 1fr; gap: 15px; margin-bottom: 15px; }
.zone{
  border:2px dashed var(--border);border-radius:12px;padding:2rem;
  text-align:center;cursor:pointer;position:relative;display:flex;
  flex-direction:column;justify-content:center;align-items:center;
  min-height: 150px; transition: 0.2s;
}
.zone:hover { border-color: var(--muted); }
.zone input{position:absolute;inset:0;opacity:0;cursor:pointer}
.zone.active{border-color:var(--green);background:rgba(34,197,94,.05)}

/* JSON AREA */
.json-box {
    width: 100%; height: 100px; background: #000; border: 1px solid var(--border);
    color: var(--green); font-family: var(--font); padding: 10px; font-size: 0.7rem;
    resize: none; border-radius: 8px; margin-bottom: 10px;
}
.json-box:focus { outline: 1px solid var(--green); }

/* CONTROLS */
.controls { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; }
button{
  padding:1rem;border-radius:8px;border:none;
  background:#27272a;color:#666;font-weight:800;
  cursor:not-allowed; transition:0.2s; font-family: var(--font);
}
button.ready{background:var(--green);color:#000;cursor:pointer}
button.blue{background:var(--blue);color:#fff;cursor:pointer}
button.purple{background:var(--purple);color:#fff;cursor:pointer}
button:active { transform: scale(0.98); }

/* OUTPUT */
.output{max-width:900px;width:100%;}
.block{
  border:1px solid var(--border);
  border-left:4px solid var(--green);
  border-radius:8px;padding:1rem;margin-bottom:1rem;
  background:#0b0b0e
}
.label{font-size:.65rem;color:var(--muted);margin-bottom:6px;text-transform:uppercase}
.text{white-space:pre-wrap;font-size:.85rem;line-height:1.5}
.actions{display:flex;gap:10px;margin-top:10px;border-top:1px solid #222;padding-top:10px}
.copy-btn{
  padding:.4rem .8rem;border-radius:4px;
  background:#222;color:#aaa;border:1px solid #333;
  cursor:pointer;font-size:.7rem;
}
.copy-btn:hover{color:#fff;border-color:var(--green)}

.status-bar { margin-top: 10px; font-size: 0.75rem; color: var(--muted); text-align: right; }
</style>
</head>

<body>

<div class="card">
  <div class="header">
    <strong>‚öóÔ∏è MEDIA FORGE STUDIO v4.5</strong>
    <span id="system-status">System Ready</span>
  </div>

  <div class="grid-zones">
      <div class="zone" id="zone">
        <input type="file" id="file" accept=".pdf" multiple>
        <div style="font-size:2rem;margin-bottom:10px">üìÑ</div>
        <strong>UPLOAD PDF</strong>
        <div style="font-size:0.7rem;color:#666;margin-top:5px">Multi-file supported</div>
      </div>

      <div style="display:flex; flex-direction:column;">
          <textarea id="json-input" class="json-box" placeholder="PASTE JSON PAYLOAD HERE..."></textarea>
          <button id="load-json" class="blue" style="margin-top:0; padding:0.5rem">LOAD JSON PAYLOAD</button>
      </div>
  </div>

  <div class="controls">
      <button id="gen">1. GENERATE SCRIPT</button>
      <button id="export-json" class="purple">2. EXPORT DATA JSON</button>
      <button id="pdf-script">3. SAVE SCRIPT PDF</button>
      <button id="pdf-source">4. REGEN USER PDF</button>
  </div>
  
  <div class="status-bar" id="status">Waiting for data...</div>
</div>

<div class="output" id="out"></div>

<script>
pdfjsLib.GlobalWorkerOptions.workerSrc = 'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.4.120/pdf.worker.min.js';

/* --- DOM ELEMENTS --- */
const fileInput = document.getElementById('file');
const jsonInput = document.getElementById('json-input');
const status = document.getElementById('status');
const out = document.getElementById('out');

const btnGen = document.getElementById('gen');
const btnJson = document.getElementById('export-json');
const btnPdfScript = document.getElementById('pdf-script');
const btnPdfSource = document.getElementById('pdf-source');
const btnLoadJson = document.getElementById('load-json');

/* --- STATE --- */
let ALL_NODES = [];
let SCRIPT_TEXTS = [];

/* --- 1. PDF INGESTION --- */
fileInput.onchange = async e => {
  const files = [...e.target.files];
  if(!files.length) return;

  status.textContent = `Processing ${files.length} documents...`;
  ALL_NODES = [];

  for(const file of files){
    try {
        const buf = await file.arrayBuffer();
        const pdf = await pdfjsLib.getDocument({data:buf}).promise;
        let text = '';

        for(let i=1; i<=pdf.numPages; i++){
            const p = await pdf.getPage(i);
            const c = await p.getTextContent();
            text += c.items.map(x=>x.str).join(' ') + '\n';
        }
        extractNodes(text, file.name);
    } catch(err) {
        console.error(err);
        status.textContent = "Error reading PDF";
    }
  }

  finishLoad();
};

/* --- 2. JSON INGESTION --- */
btnLoadJson.onclick = () => {
    try {
        const raw = jsonInput.value.trim();
        if(!raw) return alert("Paste JSON code first");
        
        const data = JSON.parse(raw);
        if(Array.isArray(data)) {
            ALL_NODES = data;
            status.textContent = `Payload Loaded: ${ALL_NODES.length} Nodes`;
            finishLoad();
        } else {
            alert("Invalid JSON Format (Must be Array)");
        }
    } catch(e) {
        alert("JSON Parse Error");
    }
};

/* --- LOGIC: NODE PARSER --- */
function extractNodes(t, source){
  // Simple regex to split by "NODE X" or assume full doc
  const parts = t.split(/NODE\s*\d+/i);
  
  if(parts.length > 1) {
      parts.forEach((p,i)=>{
        if(i===0) return; // skip pre-match
        p = p.trim();
        if(p.length < 20) return;
        ALL_NODES.push({
          id: `NODE_${Date.now()}_${i}`,
          title: p.slice(0, 50).replace(/[^a-zA-Z0-9 ]/g, "").toUpperCase(),
          body: p,
          source: source
        });
      });
  } else {
      // Fallback for non-formatted docs
      ALL_NODES.push({
          id: `DOC_${Date.now()}`,
          title: `FULL DOC (${source})`,
          body: t.slice(0, 5000), // Cap at 5k chars for safety
          source: source
      });
  }
}

function finishLoad() {
    status.textContent = `Ready: ${ALL_NODES.length} data nodes loaded.`;
    btnGen.classList.add('ready');
    btnGen.disabled = false;
    btnJson.disabled = false;
    
    // Auto-fill JSON box for safety
    jsonInput.value = JSON.stringify(ALL_NODES, null, 2);
}

/* --- 3. GENERATE SCRIPT --- */
btnGen.onclick = () => {
  out.innerHTML = '';
  SCRIPT_TEXTS = [];
  let totalTime = 0;

  if(ALL_NODES.length === 0) return alert("No data loaded!");

  ALL_NODES.forEach((n, i) => {
    // Logic: 150 words = ~1 minute (avg speaking)
    const words = n.body.split(/\s+/).length;
    const seconds = Math.min(60, Math.max(15, Math.round(words / 2.5))); 
    totalTime += seconds;

    const scriptBlock = 
`SCENE ${i+1} [${n.title}]
SOURCE: ${n.source}
TIMING: ${seconds}s Est.

VISUAL CUE:
Minimalist kinetic type, dark background, green accent.

NARRATION:
"${trim(n.body, 400)}"
`;

    SCRIPT_TEXTS.push(scriptBlock);
    renderUIBlock(scriptBlock, i);
  });

  // Enable Exports
  btnPdfScript.classList.add('ready');
  btnPdfScript.disabled = false;
  btnPdfSource.classList.add('ready');
  btnPdfSource.disabled = false;
  
  status.textContent = `Generated ${SCRIPT_TEXTS.length} scenes. Total runtime: ~${Math.round(totalTime/60)} mins.`;
};

/* --- UI RENDERER --- */
function renderUIBlock(text, idx){
  const d = document.createElement('div');
  d.className = 'block';
  d.innerHTML = 
    `<div class="label">SCENE ${idx+1} // GENERATED</div>
     <div class="text">${text}</div>
     <div class="actions">
       <button class="copy-btn" onclick="copyToClip(${idx})">COPY TEXT</button>
     </div>`;
  out.appendChild(d);
}

function copyToClip(i) {
    navigator.clipboard.writeText(SCRIPT_TEXTS[i]);
    alert("Copied to clipboard");
}

function trim(str, n) {
    return (str.length > n) ? str.substr(0, n-1) + '...' : str;
}

/* --- 4. EXPORT HANDLERS --- */

// A. EXPORT JSON (The Payload)
btnJson.onclick = () => {
    const payload = JSON.stringify(ALL_NODES, null, 2);
    navigator.clipboard.writeText(payload);
    jsonInput.value = payload;
    alert("JSON Payload Copied! Save this text file to reload later.");
};

// B. EXPORT SCRIPT PDF
btnPdfScript.onclick = () => {
    const { jsPDF } = window.jspdf;
    const doc = new jsPDF();
    
    doc.setFont("courier", "bold");
    doc.setFontSize(16);
    doc.text("MEDIA FORGE // STUDIO SCRIPT", 20, 20);
    
    doc.setFontSize(10);
    doc.setFont("courier", "normal");
    
    let y = 30;
    
    SCRIPT_TEXTS.forEach((txt, i) => {
        if(y > 250) { doc.addPage(); y = 20; }
        
        doc.text(`--- SCENE ${i+1} ---`, 20, y);
        y += 7;
        
        const lines = doc.splitTextToSize(txt, 170);
        doc.text(lines, 20, y);
        y += (lines.length * 5) + 10;
    });
    
    doc.save("Studio_Script_Output.pdf");
};

// C. REGENERATE USER PDF (Source Reconstruction)
btnPdfSource.onclick = () => {
    const { jsPDF } = window.jspdf;
    const doc = new jsPDF();
    let y = 20;

    doc.setFont("helvetica", "bold");
    doc.setFontSize(18);
    doc.text("RECONSTRUCTED SOURCE DOCUMENT", 20, y);
    y += 15;

    doc.setFont("times", "normal");
    doc.setFontSize(11);

    ALL_NODES.forEach((n, i) => {
        if(y > 270) { doc.addPage(); y = 20; }

        // Header
        doc.setFont("helvetica", "bold");
        doc.text(`[NODE ${i+1}] ${n.title}`, 20, y);
        y += 7;

        // Body
        doc.setFont("times", "normal");
        const lines = doc.splitTextToSize(n.body, 170);
        doc.text(lines, 20, y);
        y += (lines.length * 5) + 10;
        
        // Separator
        doc.setDrawColor(200);
        doc.line(20, y-5, 190, y-5);
        y += 5;
    });

    doc.save("Reconstructed_Source.pdf");
};

</script>
</body>
</html>
