<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>MEDIA FORGE | Studio v3.1 (Debug)</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.4.120/pdf.min.js"></script>
    <style>
        :root {
            --bg: #09090b;
            --panel: #121214;
            --border: #27272a;
            --text-main: #e4e4e7;
            --text-muted: #a1a1aa;
            --accent-green: #22c55e;
            --accent-green-dim: rgba(34, 197, 94, 0.1);
            --accent-orange: #f59e0b;
            --font: 'Courier New', monospace;
        }

        * { box-sizing: border-box; }

        body {
            background-color: var(--bg);
            color: var(--text-main);
            font-family: var(--font);
            display: flex;
            flex-direction: column;
            align-items: center;
            min-height: 100vh;
            margin: 0;
            padding: 20px;
        }

        .studio-card {
            width: 100%;
            max-width: 600px;
            background: var(--panel);
            border: 1px solid var(--border);
            border-radius: 16px;
            padding: 2rem;
            box-shadow: 0 20px 50px -10px rgba(0,0,0,0.5);
        }

        /* HEADER */
        .header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 2rem;
            border-bottom: 1px solid var(--border);
            padding-bottom: 1rem;
        }
        .brand { font-size: 1.2rem; font-weight: 800; letter-spacing: -1px; }
        .version { font-size: 0.7rem; background: var(--border); padding: 4px 8px; border-radius: 4px; color: var(--text-muted); }

        /* DROP ZONE */
        .drop-zone {
            border: 2px dashed var(--border);
            border-radius: 12px;
            padding: 3rem;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s ease;
            position: relative;
            background: rgba(255,255,255,0.01);
        }
        .drop-zone:hover { border-color: var(--text-muted); background: rgba(255,255,255,0.03); }
        .drop-zone.active { border-color: var(--accent-green); background: var(--accent-green-dim); }
        .drop-zone.error { border-color: #ef4444; background: rgba(239, 68, 68, 0.1); }
        
        .drop-zone input { position: absolute; inset: 0; opacity: 0; cursor: pointer; }
        .icon { font-size: 2.5rem; margin-bottom: 1rem; opacity: 0.7; }

        /* STATUS & DEBUG */
        .status-bar {
            margin-top: 1.5rem;
            padding: 1rem;
            background: #000;
            border: 1px solid var(--border);
            border-radius: 8px;
            display: flex;
            align-items: center;
            gap: 12px;
            font-size: 0.8rem;
        }
        .light { width: 10px; height: 10px; border-radius: 50%; background: #333; transition: 0.3s; }
        .light.green { background: var(--accent-green); box-shadow: 0 0 10px var(--accent-green); }
        .light.orange { background: var(--accent-orange); box-shadow: 0 0 10px var(--accent-orange); }
        .status-text { text-transform: uppercase; letter-spacing: 1px; color: var(--text-muted); flex-grow: 1; }

        .debug-log {
            margin-top: 10px;
            font-size: 0.7rem;
            color: #666;
            height: 60px;
            overflow-y: auto;
            border-top: 1px solid var(--border);
            padding-top: 5px;
            display: none; /* Hidden by default unless error */
        }
        .debug-log.show { display: block; }

        /* BUTTON */
        .export-btn {
            width: 100%;
            margin-top: 1.5rem;
            padding: 1.2rem;
            border: none;
            border-radius: 8px;
            background: var(--border);
            color: #666;
            font-family: var(--font);
            font-weight: 800;
            font-size: 1rem;
            text-transform: uppercase;
            cursor: not-allowed;
            transition: 0.3s;
        }
        .export-btn.ready {
            background: var(--accent-green);
            color: #000;
            cursor: pointer;
            box-shadow: 0 0 20px var(--accent-green-dim);
        }
        .export-btn.ready:hover { transform: translateY(-2px); box-shadow: 0 0 30px var(--accent-green-dim); }

        /* SCRIPT OUTPUT */
        .script-display {
            width: 100%;
            max-width: 600px;
            margin-top: 20px;
            display: none;
        }
        .script-display.show { display: block; }

        .line-block { margin-bottom: 1rem; padding: 1rem; background: #121214; border: 1px solid var(--border); border-radius: 6px; border-left: 3px solid #333; }
        .line-block.HOST { border-color: var(--accent-green); }
        .line-block.AI { border-color: var(--accent-orange); }
        .role { font-weight: bold; font-size: 0.7rem; margin-bottom: 0.5rem; opacity: 0.6; }
        .text { font-size: 0.9rem; line-height: 1.5; color: #fff; }

    </style>
</head>
<body>

<div class="studio-card">
    <div class="header">
        <div class="brand">‚öóÔ∏è MEDIA FORGE</div>
        <div class="version">v3.1</div>
    </div>

    <div class="drop-zone" id="dropArea">
        <input type="file" id="fileInput" accept=".pdf,.json">
        <div class="icon">üìÇ</div>
        <div id="dropText"><strong>CLICK TO UPLOAD PDF</strong></div>
        <div class="hint" style="font-size:0.7rem; color:#666; margin-top:5px;">Supports 'Decide_Journey.pdf'</div>
    </div>

    <div class="status-bar">
        <div class="light" id="statusLight"></div>
        <div class="status-text" id="statusText">SYSTEM IDLE</div>
    </div>
    
    <div class="debug-log" id="debugLog"></div>

    <button class="export-btn" id="exportBtn" onclick="generateScript()">GENERATE SCRIPT</button>
</div>

<div class="script-display" id="scriptOutput"></div>

<script>
    // --- V3.1 CORE ---
    // Explicit Worker Setting
    pdfjsLib.GlobalWorkerOptions.workerSrc = 'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.4.120/pdf.worker.min.js';

    const fileInput = document.getElementById('fileInput');
    const statusText = document.getElementById('statusText');
    const statusLight = document.getElementById('statusLight');
    const exportBtn = document.getElementById('exportBtn');
    const dropArea = document.getElementById('dropArea');
    const debugLog = document.getElementById('debugLog');
    
    let PARSED_DATA = null;

    function log(msg) {
        console.log(msg);
        debugLog.innerHTML += `> ${msg}<br>`;
        debugLog.scrollTop = debugLog.scrollHeight;
    }

    function setStatus(state, msg) {
        statusText.innerText = msg;
        statusLight.className = 'light'; 
        exportBtn.className = 'export-btn';
        exportBtn.disabled = true;
        dropArea.className = 'drop-zone';

        if(state === 'loading') {
            statusLight.classList.add('orange');
            debugLog.classList.add('show');
        } else if(state === 'ready') {
            statusLight.classList.add('green');
            exportBtn.classList.add('ready');
            exportBtn.disabled = false;
            dropArea.classList.add('active');
            document.getElementById('dropText').innerHTML = "<strong>FILE LOCKED & LOADED</strong>";
        } else if(state === 'error') {
            dropArea.classList.add('error');
            debugLog.classList.add('show');
        }
    }

    fileInput.addEventListener('change', async (e) => {
        const file = e.target.files[0];
        if(!file) return;

        setStatus('loading', 'INITIALIZING READER...');
        log(`File selected: ${file.name} (${file.type})`);

        if(file.type === 'application/pdf') {
            await parsePDF(file);
        } else if (file.name.endsWith('.json') || file.type === 'application/json') {
            await parseJSON(file);
        } else {
            setStatus('error', 'INVALID FILE FORMAT');
            log("Error: Please upload .pdf or .json");
        }
    });

    async function parsePDF(file) {
        const reader = new FileReader();
        reader.onload = async function() {
            try {
                log("Binary read complete. Loading PDF.js...");
                const pdf = await pdfjsLib.getDocument(new Uint8Array(this.result)).promise;
                log(`PDF Loaded. Pages: ${pdf.numPages}`);
                
                let fullText = "";
                for(let i=1; i<=pdf.numPages; i++) {
                    setStatus('loading', `READING PAGE ${i}/${pdf.numPages}...`);
                    const page = await pdf.getPage(i);
                    const txt = await page.getTextContent();
                    fullText += txt.items.map(s => s.str).join(" ") + "\n";
                }
                
                log("Text extraction complete. Parsing Nodes...");
                extractNodes(fullText);

            } catch(err) {
                setStatus('error', 'PDF READ FAILED');
                log("CRITICAL ERROR: " + err.message);
            }
        };
        reader.readAsArrayBuffer(file);
    }

    function extractNodes(text) {
        const nodes = [];
        
        // üîß FUZZY PARSER V3.1
        // Finds "NODE" followed by digits, allows for missing brackets
        // Captures everything until the next "NODE" or End of File
        // Regex: /\[?NODE\s*\d+\]?/gi
        
        // Strategy: Split by the word NODE followed by numbers
        const parts = text.split(/NODE\s*\d+/i);

        parts.forEach((part, idx) => {
            if(idx === 0) return; // Intro text
            
            let chunk = part.trim();
            // Remove leftover brackets or "]" at start
            chunk = chunk.replace(/^[\]\)\s]+/, "");

            // Heuristic: The Title is the first sentence or chunk before a newline
            // If PDF.js ate newlines, we look for capitalization changes or length
            let titleEnd = chunk.indexOf('\n');
            if(titleEnd === -1 || titleEnd > 60) titleEnd = 50; 

            let title = chunk.substring(0, titleEnd).trim().toUpperCase();
            let body = chunk.substring(titleEnd).trim();

            // Clean artifacts
            body = body.replace(/\/g, "");
            title = title.replace(/\/g, "");

            if(body.length > 20) {
                nodes.push({ title, summary: body });
                log(`Found Node: ${title.substring(0, 15)}...`);
            }
        });

        if(nodes.length > 0) {
            PARSED_DATA = nodes;
            setStatus('ready', `READY: ${nodes.length} NODES EXTRACTED`);
            log("Success: Data structure valid.");
        } else {
            setStatus('error', 'NO DATA FOUND');
            log("Parser Error: Regex found no matches. Is the PDF empty?");
            // Fallback: Treat whole text as one node
            if(text.length > 100) {
                PARSED_DATA = [{title: "FULL DOCUMENT", summary: text}];
                setStatus('ready', 'FALLBACK: RAW TEXT MODE');
                log("Switched to Raw Text mode.");
            }
        }
    }

    async function parseJSON(file) {
        const reader = new FileReader();
        reader.onload = function(e) {
            try {
                const json = JSON.parse(e.target.result);
                if(Array.isArray(json)) {
                    PARSED_DATA = json;
                    setStatus('ready', `JSON IMPORT: ${json.length} ITEMS`);
                } else {
                    throw new Error("JSON is not an array");
                }
            } catch(err) {
                setStatus('error', 'INVALID JSON');
                log(err.message);
            }
        };
        reader.readAsText(file);
    }

    function generateScript() {
        if(!PARSED_DATA) return;
        
        const out = document.getElementById('scriptOutput');
        out.innerHTML = "";
        out.classList.add('show');

        // SCROLL TO OUTPUT
        setTimeout(() => out.scrollIntoView({behavior: "smooth"}), 100);

        addBlock("HOST", "System Online. Let's analyze the data path.");

        PARSED_DATA.forEach((node, i) => {
            // Clean up body text for script
            let cleanBody = node.summary.replace(/\s+/g, ' ').trim();
            if(cleanBody.length > 350) cleanBody = cleanBody.substring(0, 350) + "...";

            addBlock("AI_ASSISTANT", `Processing Node ${i+1}: ${node.title}`);
            addBlock("HOST", "What's the core concept here?");
            addBlock("AI_ASSISTANT", cleanBody);
            
            if(i < PARSED_DATA.length - 1) {
                addBlock("HOST", "Connect this to the next node.");
            }
        });

        addBlock("HOST", "Analysis complete. Save to archives.");
    }

    function addBlock(role, text) {
        const div = document.createElement('div');
        div.className = `line-block ${role}`;
        div.innerHTML = `<div class="role">${role}</div><div class="text">${text}</div>`;
        document.getElementById('scriptOutput').appendChild(div);
    }

</script>
</body>
</html>
