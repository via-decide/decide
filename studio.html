<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>MEDIA FORGE | Studio v4.5 (JSON Engine)</title>

<script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.4.120/pdf.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>

<style>
:root{
  --bg:#09090b;--panel:#121214;--border:#27272a;
  --text:#e4e4e7;--muted:#a1a1aa;
  --green:#22c55e;--blue:#3b82f6;--purple:#a855f7;--red:#ef4444;
  --font:'Courier New',monospace;
}
*{box-sizing:border-box}
body{
  margin:0;padding:20px;background:var(--bg);color:var(--text);
  font-family:var(--font);display:flex;flex-direction:column;align-items:center;
}
.card{
  width:100%;max-width:900px;background:var(--panel);
  border:1px solid var(--border);border-radius:16px;padding:2rem;
  margin-bottom: 20px;
}
.header{display:flex;justify-content:space-between;margin-bottom:1rem;border-bottom:1px solid var(--border);padding-bottom:10px}

/* ZONES */
.grid-zones { display: grid; grid-template-columns: 1fr 1fr; gap: 15px; margin-bottom: 15px; }
.zone{
  border:2px dashed var(--border);border-radius:12px;padding:2rem;
  text-align:center;cursor:pointer;position:relative;display:flex;
  flex-direction:column;justify-content:center;align-items:center;
  min-height: 150px; transition: 0.2s;
}
.zone:hover { border-color: var(--muted); }
.zone input{position:absolute;inset:0;opacity:0;cursor:pointer}
.zone.active{border-color:var(--green);background:rgba(34,197,94,.05)}

/* JSON AREA */
.json-box {
    width: 100%; height: 100px; background: #000; border: 1px solid var(--border);
    color: var(--green); font-family: var(--font); padding: 10px; font-size: 0.7rem;
    resize: none; border-radius: 8px; margin-bottom: 10px;
}
.json-box:focus { outline: 1px solid var(--green); }

/* CONTROLS */
.controls { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; }
button{
  padding:1rem;border-radius:8px;border:none;
  background:#27272a;color:#666;font-weight:800;
  cursor:not-allowed; transition:0.2s; font-family: var(--font);
}
button.ready{background:var(--green);color:#000;cursor:pointer}
button.blue{background:var(--blue);color:#fff;cursor:pointer}
button.purple{background:var(--purple);color:#fff;cursor:pointer}
button.red{background:var(--red);color:#fff;cursor:pointer}
button:active { transform: scale(0.98); }

/* OUTPUT */
.output{max-width:900px;width:100%;}
.block{
  border:1px solid var(--border);
  border-left:4px solid var(--green);
  border-radius:8px;padding:1rem;margin-bottom:1rem;
  background:#0b0b0e
}
.label{font-size:.65rem;color:var(--muted);margin-bottom:6px;text-transform:uppercase}
.text{white-space:pre-wrap;font-size:.85rem;line-height:1.5}
.actions{display:flex;gap:10px;margin-top:10px;border-top:1px solid #222;padding-top:10px}
.copy-btn{
  padding:.4rem .8rem;border-radius:4px;
  background:#222;color:#aaa;border:1px solid #333;
  cursor:pointer;font-size:.7rem;
}
.copy-btn:hover{color:#fff;border-color:var(--green)}

.status-bar { margin-top: 10px; font-size: 0.75rem; color: var(--muted); text-align: right; }
</style>
</head>

<body>

<div class="card">
  <div class="header">
    <strong>‚öóÔ∏è MEDIA FORGE STUDIO v4.5</strong>
    <span id="system-status">System Ready</span>
  </div>

  <div class="grid-zones">
      <div class="zone" id="zone">
        <input type="file" id="file" accept=".pdf" multiple>
        <div style="font-size:2rem;margin-bottom:10px">üìÑ</div>
        <strong>UPLOAD PDF</strong>
        <div style="font-size:0.7rem;color:#666;margin-top:5px">Multi-file supported</div>
      </div>

      <div style="display:flex; flex-direction:column;">
          <textarea id="json-input" class="json-box" placeholder="PASTE JSON FROM DECIDE ENGINE..."></textarea>
          <button id="load-json" class="blue" style="margin-top:0; padding:0.5rem">LOAD JSON PAYLOAD</button>
      </div>
  </div>

  <div class="controls">
      <button id="gen">1. GENERATE SCRIPT</button>
      <button id="yt" class="red">2. YOUTUBE POST</button>
      <button id="pdf-script">3. SAVE SCRIPT PDF</button>
      <button id="export-json" class="purple">4. EXPORT DATA</button>
  </div>
  
  <div class="status-bar" id="status">Waiting for data...</div>
</div>

<div class="output" id="out"></div>

<script>
pdfjsLib.GlobalWorkerOptions.workerSrc = 'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.4.120/pdf.worker.min.js';

/* --- DOM ELEMENTS --- */
const fileInput = document.getElementById('file');
const jsonInput = document.getElementById('json-input');
const status = document.getElementById('status');
const out = document.getElementById('out');

const btnGen = document.getElementById('gen');
const btnYt = document.getElementById('yt');
const btnJson = document.getElementById('export-json');
const btnPdfScript = document.getElementById('pdf-script');
const btnLoadJson = document.getElementById('load-json');

/* --- STATE --- */
let ALL_NODES = [];
let SCRIPT_TEXTS = [];
let SESSION_ID = "SID-" + Math.random().toString(36).slice(2,6).toUpperCase();

/* --- 1. PDF INGESTION --- */
fileInput.onchange = async e => {
  const files = [...e.target.files];
  if(!files.length) return;

  status.textContent = `Processing ${files.length} documents...`;
  ALL_NODES = [];

  for(const file of files){
    try {
        const buf = await file.arrayBuffer();
        const pdf = await pdfjsLib.getDocument({data:buf}).promise;
        let text = '';

        for(let i=1; i<=pdf.numPages; i++){
            const p = await pdf.getPage(i);
            const c = await p.getTextContent();
            text += c.items.map(x=>x.str).join(' ') + '\n';
        }
        extractNodes(text, file.name);
    } catch(err) {
        console.error(err);
        status.textContent = "Error reading PDF";
    }
  }

  finishLoad();
};

/* --- 2. JSON INGESTION --- */
btnLoadJson.onclick = () => {
    try {
        const raw = jsonInput.value.trim();
        if(!raw) return alert("Paste JSON code first");
        
        const data = JSON.parse(raw);
        if(Array.isArray(data)) {
            ALL_NODES = data;
            status.textContent = `Payload Loaded: ${ALL_NODES.length} Nodes from Decide Engine`;
            finishLoad();
        } else {
            alert("Invalid JSON Format (Must be Array)");
        }
    } catch(e) {
        alert("JSON Parse Error");
    }
};

/* --- LOGIC: NODE PARSER --- */
function extractNodes(t, source){
  const parts = t.split(/NODE\s*\d+/i);
  
  if(parts.length > 1) {
      parts.forEach((p,i)=>{
        if(i===0) return;
        p = p.trim();
        if(p.length < 20) return;
        ALL_NODES.push({
          id: `NODE_${Date.now()}_${i}`,
          title: p.slice(0, 50).replace(/[^a-zA-Z0-9 ]/g, "").toUpperCase(),
          body: p,
          source: source
        });
      });
  } else {
      ALL_NODES.push({
          id: `DOC_${Date.now()}`,
          title: `FULL DOC (${source})`,
          body: t.slice(0, 5000),
          source: source
      });
  }
}

function finishLoad() {
    status.textContent = `Ready: ${ALL_NODES.length} research nodes loaded.`;
    btnGen.classList.add('ready');
    btnGen.disabled = false;
    btnJson.disabled = false;
    jsonInput.value = JSON.stringify(ALL_NODES, null, 2);
}

/* --- 3. GENERATE SCRIPT --- */
btnGen.onclick = () => {
  out.innerHTML = '';
  SCRIPT_TEXTS = [];
  let totalTime = 0;

  if(ALL_NODES.length === 0) return alert("No data loaded!");

  ALL_NODES.forEach((n, i) => {
    const words = n.body.split(/\s+/).length;
    const seconds = Math.min(60, Math.max(15, Math.round(words / 2.5))); 
    totalTime += seconds;

    const scriptBlock = 
`SCENE ${i+1} [${n.title || 'RESEARCH'}]
SOURCE: ${n.source}
TIMING: ${seconds}s Est.

VISUAL CUE:
Minimalist kinetic type, dark background, green accent.

NARRATION:
"${trim(n.body, 400)}"
`;

    SCRIPT_TEXTS.push(scriptBlock);
    renderUIBlock(scriptBlock, i);
  });

  btnPdfScript.classList.add('ready');
  btnPdfScript.disabled = false;
  btnYt.disabled = false;
  btnYt.classList.add('ready'); // Red button active
  
  status.textContent = `Generated ${SCRIPT_TEXTS.length} scenes. Runtime: ~${Math.round(totalTime/60)}m.`;
};

/* --- 4. YOUTUBE POST GENERATOR --- */
btnYt.onclick = () => {
  if (!ALL_NODES.length) return alert("Generate script first");

  const topic = inferTopic(ALL_NODES);
  const bullets = inferBullets(ALL_NODES);

  const ytPost = `
TITLE:
${topic.main}

ALT TITLES:
${topic.alt.join('\n')}

---

DESCRIPTION:

${topic.hook}

In this video, we break down:

${bullets.map(b => `‚Ä¢ ${b}`).join('\n')}

This video was generated using a research-driven studio engine that converts
multi-source documents into a scene-based visual narrative.

---

üîó Explore the Engine Behind This Video

üß† Interactive Research Engine  
https://viadecide.com/

üé¨ Engine Walkthrough & Updates  
https://www.youtube.com/@decide.engine

üìÑ Research ‚Üí Script ‚Üí Video Pipeline  
Session ID: ${SESSION_ID}  
Multi-PDF merged research  
Scene-timed narration system  

---

üß™ How this video was made

Wikipedia + scientific context extraction  
Multi-PDF merge into a single narrative  
Scene timing + voice pacing calibration  
Converted into a studio-ready script  

This is not animation-first content.  
This is thinking-first video.

---

PINNED COMMENT:

This video was built using a research ‚Üí script ‚Üí video engine.

üß† Try the interactive engine  
https://viadecide.com/

üé¨ See how these videos are generated  
https://www.youtube.com/@decide.engine

üìÑ Research Session ID: ${SESSION_ID}

Reply "${topic.cta}" if you want more like this.
`;

  renderUIBlock(ytPost, -1); // -1 marks special block
};

/* --- HELPERS --- */
function inferTopic(nodes){
  const text = nodes.map(n => n.body).join(' ').toLowerCase();

  if (text.includes('sun') || text.includes('fusion')) {
    return {
      main: "What Actually Happens Inside the Sun? (Fusion, Flares & Solar Storms Explained)",
      alt: ["The Sun Is Not What You Think", "Inside the Sun: Physics Powering Solar System"],
      hook: "The Sun is not just a glowing ball in the sky. It is a self-regulating nuclear engine.",
      cta: "SUN"
    };
  }
  if (text.includes('system') || text.includes('feedback')) {
    return {
      main: "Systems Thinking: How Everything is Connected",
      alt: ["Why Feedback Loops Rule the World", "Cybernetics Explained"],
      hook: "From biology to economics, the same hidden laws govern everything.",
      cta: "SYSTEMS"
    };
  }

  return {
    main: "Deep Dive Research Analysis",
    alt: ["Explaining Complex Topics", "Visual Research Breakdown"],
    hook: "Breaking down complex systems using structured research data.",
    cta: "MORE"
  };
}

function inferBullets(nodes){
  const keywords = ["fusion", "sunspots", "flare", "wind", "magnetic", "feedback", "cybernetics", "agent", "simulation"];
  const found = new Set();
  nodes.forEach(n => {
    keywords.forEach(k => {
      if (n.body && n.body.toLowerCase().includes(k)) found.add(k);
    });
  });
  return [...found].map(k => "Understanding " + k.toUpperCase());
}

function renderUIBlock(text, idx){
  const d = document.createElement('div');
  d.className = 'block';
  d.innerHTML = 
    `<div class="label">${idx === -1 ? 'YOUTUBE METADATA' : `SCENE ${idx+1}`}</div>
     <div class="text">${text}</div>
     <div class="actions">
       <button class="copy-btn" onclick="copyToClip('${encodeURIComponent(text)}')">COPY TEXT</button>
     </div>`;
  out.appendChild(d);
}

function copyToClip(text) {
    navigator.clipboard.writeText(decodeURIComponent(text));
    alert("Copied to clipboard");
}

function trim(str, n) {
    return (str && str.length > n) ? str.substr(0, n-1) + '...' : str;
}

/* --- EXPORTS --- */
btnJson.onclick = () => {
    const payload = JSON.stringify(ALL_NODES, null, 2);
    navigator.clipboard.writeText(payload);
    alert("JSON Payload Copied!");
};

btnGen.onclick = () => {
  out.innerHTML = '';
  SCRIPT_TEXTS = [];
  let totalTime = 0;

  if (ALL_NODES.length === 0) {
    alert("No data loaded!");
    return;
  }

  // 1. Normalize & cluster nodes
  const clusters = buildNarrativeClusters(ALL_NODES);

  // 2. Build scenes from clusters
  clusters.forEach((cluster, i) => {
    const body = cluster.text;
    const words = body.split(/\s+/).length;

    // Narrative pacing (slower, explainer-grade)
    const seconds = clamp(Math.round(words / 2.2), 25, 55);
    const pace = Math.round((words / seconds) * 60);
    totalTime += seconds;

    const script =
`SCENE ${i + 1}: ${cluster.title}
ROLE: ${cluster.role}
DURATION: ${seconds}s
VOICE PACE: ${pace} WPM

VISUAL DIRECTION:
Dark studio background
Minimal kinetic typography
One concept per screen
Slow camera push, no stock footage

NARRATION:
${body}
`;

    SCRIPT_TEXTS.push(script);
    renderUIBlock(script, i);
  });

  renderUIBlock(
`STRUCTURE SUMMARY
Scenes: ${SCRIPT_TEXTS.length}
Estimated Runtime: ~${Math.round(totalTime / 60)} minutes

This script is optimized for:
‚Ä¢ Explainer videos
‚Ä¢ Knowledge retention
‚Ä¢ Canva / NotebookLM narration
`,
-2);

  btnPdfScript.classList.add('ready');
  btnPdfScript.disabled = false;
  btnYt.classList.add('ready');
  btnYt.disabled = false;

  status.textContent =
    `Narrative script generated (${SCRIPT_TEXTS.length} scenes, ~${Math.round(totalTime / 60)} min).`;
};</script>
</body>
</html>
