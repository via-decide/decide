<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>Decide Engine | Neutral ONDC Discovery</title>
    <meta name="theme-color" content="#000000">
    <link rel="manifest" href="manifest.json">
    
    <meta name="description" content="The Neutral Decision Engine for the ONDC Era. Compare products and research topics with transparent, unbundled logic.">
    
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.31/jspdf.plugin.autotable.min.js"></script>
    <script src="https://html2canvas.hertzen.com/dist/html2canvas.min.js"></script>

    <style>
        /* =========================================
           DECIDE OS | PRO UI (v93.0)
           ========================================= */
        :root {
            --brand-orange: #ff671f;
            --brand-gold: #ffb700;
            --brand-dark: #050505;
            --glass-surface: rgba(20, 20, 20, 0.85);
            --glass-border: rgba(255, 255, 255, 0.15);
            --text-main: #ffffff;
            --text-muted: #a0a0a0;
            --accent-go: #00e676; 
            --accent-skip: #ff3333;
            --font-tech: 'Courier New', monospace;
            --font-ui: -apple-system, BlinkMacSystemFont, "SF Pro Display", "Segoe UI", Roboto, sans-serif;
            --ease-elastic: cubic-bezier(0.19, 1, 0.22, 1);
        }

        html, body { margin: 0; padding: 0; height: 100%; width: 100%; background-color: var(--brand-dark); color: var(--text-main); font-family: var(--font-ui); overflow: hidden; touch-action: none; user-select: none; -webkit-font-smoothing: antialiased; }
        
        /* Aurora Background */
        .aurora-bg { position: fixed; top: -50%; left: -50%; width: 200%; height: 200%; background: radial-gradient(circle at 50% 50%, #1a1a2e 0%, #000000 70%); z-index: -1; animation: drift 25s infinite alternate ease-in-out; opacity: 0.8; pointer-events: none; will-change: transform; }
        @keyframes drift { 0% { transform: translate3d(0,0,0) scale(1); } 100% { transform: translate3d(-20px, -20px, 0) scale(1.05); } }

        #master-container { height: 100vh; width: 100vw; position: relative; overflow: hidden; }

        /* Slide System */
        .main-slide { height: 100vh; width: 100vw; position: absolute; top: 0; left: 0; display: flex; flex-direction: column; transition: transform 0.5s var(--ease-elastic), opacity 0.4s ease; will-change: transform, opacity; background: transparent; }
        .main-slide.prev { transform: translateY(-100%) scale(0.95); opacity: 0; pointer-events: none; }
        .main-slide.active { transform: translateY(0) scale(1); opacity: 1; z-index: 10; pointer-events: auto; }
        .main-slide.next { transform: translateY(100%) scale(0.95); opacity: 0; z-index: 20; pointer-events: none; }

        /* Components */
        .slide-header { padding: 0 24px; height: 70px; display: flex; align-items: center; justify-content: space-between; position: absolute; top: 0; left: 0; right: 0; z-index: 100; background: linear-gradient(180deg, rgba(0,0,0,0.9) 0%, rgba(0,0,0,0) 100%); pointer-events: none; }
        .slide-header > * { pointer-events: auto; }
        .header-title { font-family: var(--font-tech); font-size: 0.7rem; color: var(--brand-orange); letter-spacing: 2px; font-weight: 700; text-transform: uppercase; background: rgba(255, 103, 31, 0.1); padding: 6px 12px; border-radius: 4px; border: 1px solid rgba(255, 103, 31, 0.2); display: flex; align-items: center; gap: 8px; }
        .status-dot { width: 6px; height: 6px; background: var(--accent-go); border-radius: 50%; box-shadow: 0 0 5px var(--accent-go); transition: background 0.3s; }
        .status-dot.offline { background: var(--accent-skip); box-shadow: 0 0 5px var(--accent-skip); }
        .exit-btn { padding: 8px 16px; border: 1px solid rgba(255,255,255,0.3); border-radius: 20px; background: rgba(0,0,0,0.6); color: #fff; font-family: var(--font-tech); font-size: 0.7rem; font-weight: bold; cursor: pointer; backdrop-filter: blur(10px); text-transform: uppercase; }

        /* Lobby */
        .lobby-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 12px; padding: 24px; margin-top: 20px; overflow-y: auto; padding-bottom: 120px; box-sizing: border-box; height: 100%; align-content: start; padding-top: 80px; }
        .lobby-container { display: flex; flex-direction: column; gap: 15px; padding: 24px; height: 100%; overflow-y: auto; justify-content: flex-start; padding-top: 80px; box-sizing: border-box; }
        .grid-btn { background: rgba(255,255,255,0.03); border: 1px solid var(--glass-border); border-radius: 16px; padding: 20px; display: flex; flex-direction: column; align-items: center; justify-content: center; gap: 8px; aspect-ratio: 1.15; transition: all 0.2s; cursor: pointer; backdrop-filter: blur(10px); }
        .grid-btn:active { transform: scale(0.96); background: rgba(255,255,255,0.08); }
        .grid-icon { font-size: 1.8rem; }
        .grid-label { font-weight: 700; font-size: 0.85rem; color: #fff; text-align: center; }
        .grid-status { font-family: var(--font-tech); font-size: 0.6rem; color: var(--accent-go); opacity: 0.8; letter-spacing: 1px; }
        .full-width-btn { grid-column: span 2; aspect-ratio: auto; padding: 18px; flex-direction: row; gap: 15px; }
        .btn-fuel { border-color: var(--brand-gold); background: rgba(255, 183, 0, 0.05); }

        /* Cards */
        .carousel-viewport { position: relative; flex-grow: 1; width: 100%; height: 100%; margin-top: 70px; perspective: 1000px; }
        .sub-slide { position: absolute; inset: 20px; bottom: 100px; padding: 30px; display: flex; flex-direction: column; justify-content: center; background: var(--glass-surface); backdrop-filter: blur(20px); border: 1px solid var(--glass-border); border-radius: 24px; opacity: 0; pointer-events: none; transform: translateY(20px) scale(0.95); transition: all 0.4s var(--ease-elastic); box-shadow: 0 20px 50px rgba(0,0,0,0.5); }
        .sub-slide.opt-active, .sub-slide.static { opacity: 1; pointer-events: auto; transform: translateY(0) scale(1); z-index: 30; }
        .sub-slide.opt-hidden { opacity: 0; pointer-events: none; transform: translateY(-20px) scale(0.95); }
        
        h1 { font-family: var(--font-ui); font-size: 2rem; font-weight: 700; margin: 0 0 15px 0; letter-spacing: -0.03em; line-height: 1.1; background: linear-gradient(to right, #fff, #ccc); -webkit-background-clip: text; -webkit-text-fill-color: transparent; }
        .role-label { font-family: var(--font-tech); font-size: 0.65rem; color: var(--brand-orange); margin-bottom: 10px; display: flex; align-items: center; gap: 8px; font-weight: 700; letter-spacing: 1px; }
        .role-label::before { content: ''; width: 8px; height: 8px; background: var(--brand-orange); border-radius: 50%; box-shadow: 0 0 10px var(--brand-orange); }
        .nav-hint { margin-top: 25px; border-top: 1px solid rgba(255,255,255,0.1); padding-top: 15px; display: flex; justify-content: space-between; font-family: var(--font-tech); font-size: 0.7rem; color: #555; }
        .skip-btn-clickable { cursor: pointer; padding: 6px 12px; background: rgba(255,255,255,0.1); border-radius: 20px; font-weight: bold; color: #aaa; }

        /* Buttons & Forms */
        .cuisine-btn { background: rgba(20,20,20,0.6); border: 1px solid var(--glass-border); color: #888; padding: 20px; font-size: 1rem; font-weight: 600; border-radius: 12px; transition: all 0.3s; width: 100%; text-align: left; margin-bottom: 10px; }
        .cuisine-btn.selected { background: rgba(255, 103, 31, 0.15); color: var(--brand-orange); border-color: var(--brand-orange); }
        .btn { background: rgba(255,255,255,0.05); color: #fff; border: 1px solid rgba(255,255,255,0.1); padding: 18px; border-radius: 12px; font-weight: 600; cursor: pointer; width: 100%; margin-top: 15px; }
        .btn-primary { background: var(--brand-orange); color: #000; border: none; font-weight: 800; }
        .search-wrapper { position: relative; margin-bottom: 20px; }
        #search-input { width: 100%; padding: 20px; border-radius: 16px; border: 1px solid var(--glass-border); background: rgba(0,0,0,0.3); color: #fff; font-family: var(--font-ui); font-size: 1.1rem; box-sizing: border-box; }

        /* Toast & Overlays */
        .toast-msg { position: fixed; bottom: 40px; left: 50%; transform: translateX(-50%); background: #111; color: var(--accent-go); border: 1px solid #333; padding: 12px 24px; border-radius: 30px; opacity: 0; transition: opacity 0.3s; font-family: var(--font-tech); z-index: 9999; font-weight: bold; pointer-events: none; }
        .toast-msg.visible { opacity: 1; }
        .video-bg { position: absolute; top: 0; left: 0; width: 100%; height: 100%; object-fit: cover; z-index: -1; opacity: 0.4; mix-blend-mode: screen; }
        .winner-container { flex-grow: 1; display: flex; flex-direction: column; justify-content: flex-end; padding: 30px; padding-bottom: 120px; background: linear-gradient(to top, #000 95%, transparent); }
        
        .wiki-summary { max-height: 250px; overflow-y: auto; color: var(--text-muted); line-height: 1.5; margin-bottom: 10px; }
        .topic-grid { display: grid; grid-template-columns: 1fr; gap: 10px; margin-top: 20px; }
        .topic-card { background: rgba(255,255,255,0.03); border: 1px solid var(--glass-border); padding: 15px; border-radius: 12px; cursor: pointer; }
        .topic-title { font-weight: bold; color: #fff; font-size: 0.85rem; margin-bottom: 4px; font-family: var(--font-tech); }
        .topic-desc { font-size: 0.75rem; color: #888; display: -webkit-box; -webkit-line-clamp: 2; -webkit-box-orient: vertical; overflow: hidden; }
        
        /* Share Card Hidden Canvas */
        #share-card-canvas { position: fixed; top: -200vh; left: 0; width: 360px; padding: 40px 30px; background: linear-gradient(145deg, #111, #050505); border: 2px solid var(--brand-orange); border-radius: 24px; text-align: center; color: #fff; display: flex; flex-direction: column; align-items: center; justify-content: center; box-sizing: border-box; z-index: 9000; }
        iframe { width: 100%; height: 100%; border: none; background: #000; }
        .close-iframe { position: fixed; top: 20px; right: 20px; z-index: 200; background: #000; border: 1px solid #333; color: #fff; padding: 10px 20px; border-radius: 20px; font-weight: bold; cursor: pointer; }
    </style>
</head>
<body>

<div class="aurora-bg"></div>
<div id="master-container"></div>
<div id="toast" class="toast-msg"></div>

<div id="share-card-canvas">
    <div style="font-family:var(--font-tech); color:var(--brand-orange); font-size:0.8rem; letter-spacing:2px; margin-bottom:20px;">DECIDE ENGINE</div>
    <div style="font-size:0.7rem; color:#888; text-transform:uppercase;">THE WINNER IS</div>
    <h1 id="share-winner-name" style="font-size:2.5rem; margin:15px 0; line-height:1; color:#fff; word-wrap:break-word;">WINNER</h1>
    <div id="share-winner-price" style="font-size:1.5rem; color:var(--accent-go); font-weight:bold;">‚Çπ0</div>
    <div style="margin-top:30px; font-size:0.7rem; color:#666; border-top:1px solid #333; padding-top:15px; width:100%;">viadecide.com</div>
</div>

<script>
    /* =========================================
       DECIDE OS | v93.0 PRO
       ========================================= */
    
    // --- CONFIGURATION ---
    const BACKEND_URL = "https://script.google.com/macros/s/AKfycbzT3MWODY9r0UlyBscZtr5BdF_upkjrpcng7xl07WsAixLTwKxIKWEoXEwhDoGTOIDk/exec"; 
    const PHONE_REVIEW_URL = "https://youtu.be/W28-2z9IZbA?si=nJDuPcmTsaUcao9d";
    const AUDIO_REVIEW_URL = "https://youtu.be/ceuEz96MMEY";
    const YOUTUBE_CHANNEL = "https://www.youtube.com/@decide.engine"; 
    const AMZN_TAG = "decideos-21";
    const WINNER_VIDEO = "https://static.videezy.com/system/resources/previews/000/012/628/original/Abstract_Blue_Background.mp4";

    // --- GLOBAL DATA ---
    let PHONE_DB = {};
    let AUDIO_DB = {};
    let ENGINE_STATE = { 
        currentDomain: null, items_detected: {}, active_filters: [], 
        session_weights: {}, researchPath: [], triviaMode: false, sessionID: "",
        DECISION_LOG: null
    };
    let slideElements = [];
    let currentIdx = 0;

    // --- MODULES ---
    const MODULES = {
        smartphones: { 
            label: "SMARTPHONES", database: PHONE_DB, review: PHONE_REVIEW_URL, 
            init: () => renderEcosystemGate(), 
            categories: [
                { label: "CAMERA-FIRST", type: "cam", items: [] }, 
                { label: "PRO GAMER", type: "gam", items: [] }, 
                { label: "CLEAN UI", type: "ui", items: [] },
                { label: "BATTERY KING", type: "bat", items: [] }
            ] 
        },
        earbuds: { 
            label: "EARBUDS", database: AUDIO_DB, review: AUDIO_REVIEW_URL, 
            init: () => { ENGINE_STATE.active_filters=[]; renderSubLobby('earbuds'); }, 
            categories: [
                { label: "AUDIOPHILE", type: "snd", items: [] }, 
                { label: "SILENCE (ANC)", type: "anc", items: [] },
                { label: "LOW LATENCY", type: "lat", items: [] }
            ] 
        },
        trivia: { label: "TRIVIA", init: () => renderTriviaGate() },
        research: { label: "RESEARCH", init: () => renderSearchSlide() },
        food: { label: "DINING", init: () => renderExternalModule("https://via-decide.github.io/food.decider/") },
        custom: { label: "CUSTOM REQ", init: () => renderExternalModule('https://via-decide.github.io/food.decide-custom/') },
        review: { label: "ENGINE REVIEW ‚Üó", init: () => window.open(YOUTUBE_CHANNEL, '_blank') }
    };

    const DEAL_BREAKERS = { "CLEAN UI": "bloatware", "LIGHTWEIGHT": "heavy", "FAST CHARGE": "slow_charge" };
    const CURATED_PATHS = {
        "THE BIG BANG": { title: "The Big Bang", summary: "The prevailing cosmological model explaining the existence of the observable universe.", links: ["Cosmic Inflation", "Nucleosynthesis"] },
        "SYSTEMS THINKING": { title: "Systems Thinking", summary: "A holistic approach to analysis that focuses on the way that a system's constituent parts interrelate.", links: ["Feedback Loops", "Cybernetics"] }
    };
    const VOICE_FEED = [
      { id: "voice_focus_ai", title: "Voice Focus AI ‚Äì Call Clarity", mode: "explain", blocks: [{ text: "Voice Focus AI uses a six-microphone array to isolate human voice." }] },
      { id: "earbuds_buy_wait_2026", title: "Earbuds ‚Äì Buy vs Wait", mode: "decision", blocks: [{ text: "Buy today: Technics AZ100 for work. Wait for Sony WF-1000XM6." }] }
    ];

    // --- ENGINES ---
    const WIKI_ENGINE = {
        async resolveTitle(query) {
            try { const r = await fetch(`https://en.wikipedia.org/w/api.php?origin=*&action=opensearch&search=${encodeURIComponent(query)}&limit=1&format=json`); const d = await r.json(); return d[1]?.[0] || null; } catch(e){return null;}
        },
        async buildKnowledgeNode(query) {
            if(CURATED_PATHS[query.toUpperCase()]) { const c = CURATED_PATHS[query.toUpperCase()]; return { title: c.title, summary: c.summary, description: "Curated Node", links: c.links.map(l => ({name: l})) }; }
            const title = await this.resolveTitle(query);
            if(!title) return null;
            try {
                const [s, l] = await Promise.all([
                    fetch(`https://en.wikipedia.org/api/rest_v1/page/summary/${encodeURIComponent(title)}`).then(r=>r.json()),
                    fetch(`https://en.wikipedia.org/w/api.php?origin=*&action=query&prop=links&titles=${encodeURIComponent(title)}&pllimit=20&format=json`).then(r=>r.json())
                ]);
                const pageId = Object.keys(l.query.pages)[0];
                return { title: s.title, summary: s.extract, description: "Research Topic", links: (l.query.pages[pageId].links || []).slice(0,5).map(x=>({name:x.title})) };
            } catch(e) { return null; }
        }
    };

    const TRIVIA_ENGINE = {
        async fetch(cat = "") { try { const r = await fetch(`https://opentdb.com/api.php?amount=5&type=multiple${cat?'&category='+cat:''}`); const d = await r.json(); return d.results||[]; } catch(e){return [];} }
    };

    // --- CORE: DATA SYNC (THE FIX) ---
    async function syncDatabase() {
        showToast("SYNCING CLOUD DB...");
        try {
            const res = await fetch(`${BACKEND_URL}?type=local`);
            const data = await res.json();
            
            PHONE_DB = {}; AUDIO_DB = {};
            data.forEach(item => {
                const entry = {
                    attr: { cam:Number(item.cam)||0, gam:Number(item.gam)||0, bat:Number(item.bat)||0, ui:Number(item.ui)||0, dis:Number(item.dis)||0, srv:Number(item.srv)||0, thm:Number(item.thm)||0, dur:Number(item.dur)||0 },
                    tags: item.tags ? item.tags.split(',').map(t=>t.trim()) : [],
                    price: Number(item.price)||0, mrp: Number(item.mrp)||0
                };
                if(item.category === 'smartphones') PHONE_DB[item.Name] = entry;
                if(item.category === 'earbuds') AUDIO_DB[item.Name] = entry;
            });

            // CRITICAL: Re-link the database to the modules
            MODULES.smartphones.database = PHONE_DB;
            MODULES.earbuds.database = AUDIO_DB;
            
            showToast("DB LIVE ‚úÖ");
            updateStatus(true);
        } catch(e) {
            console.error(e);
            showToast("OFFLINE MODE");
            updateStatus(false);
        }
    }

    // --- UI RENDERERS ---
    function renderLobby() {
        const container = document.getElementById('master-container');
        container.innerHTML = "";
        const section = document.createElement('section');
        section.className = "main-slide active";
        section.innerHTML = `
            <div class="slide-header"><span class="header-title">DECIDE OS v93.0 <div class="status-dot"></div></span></div>
            <div class="lobby-grid">
                <div class="grid-btn" onclick="loadDomain('smartphones')"><div class="grid-icon">üì±</div><div class="grid-label">PHONES</div><div class="grid-status">LIVE DB</div></div>
                <div class="grid-btn" onclick="loadDomain('earbuds')"><div class="grid-icon">üéß</div><div class="grid-label">AUDIO</div><div class="grid-status">NEUTRAL</div></div>
                <div class="grid-btn" onclick="loadDomain('research')"><div class="grid-icon">üß†</div><div class="grid-label">RESEARCH</div><div class="grid-status">ONDC+</div></div>
                <div class="grid-btn" onclick="loadDomain('trivia')"><div class="grid-icon">üß©</div><div class="grid-label">TRIVIA</div><div class="grid-status">LOGIC</div></div>
                <div class="grid-btn" onclick="openVoiceLobby()"><div class="grid-icon">üéôÔ∏è</div><div class="grid-label">VOICE FEED</div><div class="grid-status">AI READY</div></div>
                <div class="grid-btn full-width-btn" onclick="loadDomain('review')"><div class="grid-icon">‚ñ∂</div><div class="grid-label">ENGINE REVIEW ‚Üó</div></div>
                <div style="grid-column:span 2; text-align:center; opacity:0.3; font-size:0.6rem; margin-top:20px; font-family:var(--font-tech);">SESSION: ${ENGINE_STATE.sessionID}</div>
            </div>`;
        container.appendChild(section);
        slideElements = [section];
        currentIdx = 0;
        let exitBtn = document.getElementById('global-exit');
        if(exitBtn) exitBtn.remove();
    }

    function loadDomain(key) {
        // Safety check if DB is empty for hardware
        if ((key === 'smartphones' || key === 'earbuds') && Object.keys(MODULES[key].database).length === 0) {
            showToast("DB EMPTY. RETRYING...");
            syncDatabase().then(() => {
                if(Object.keys(MODULES[key].database).length > 0) proceedLoad(key);
                else showToast("SERVER ERROR");
            });
        } else {
            proceedLoad(key);
        }
    }

    function proceedLoad(key) {
        ENGINE_STATE.currentDomain = key;
        const container = document.getElementById('master-container');
        while(container.children.length > 1) container.removeChild(container.lastChild);
        slideElements = [slideElements[0]];
        addGlobalExit();
        MODULES[key].init();
    }

    function renderEcosystemGate() {
        const section = document.createElement('section'); section.className = "main-slide next";
        section.innerHTML = `
            <div class="slide-header"><span class="header-title">PHILOSOPHY</span></div>
            <div class="lobby-container"><h1 style="text-align:center">WHAT MATTERS?</h1>
                <div style="display:grid; gap:20px; margin-top:20px;">
                    <button class="cuisine-btn" onclick="selectEcosystem('specs')">üöÄ PURE SPECS</button>
                    <button class="cuisine-btn" onclick="selectEcosystem('peace')">üõ°Ô∏è PEACE OF MIND</button>
                </div>
            </div>`;
        document.getElementById('master-container').appendChild(section); slideElements.push(section); goToSlide(1);
    }

    function selectEcosystem(type) { ENGINE_STATE.ecosystem = type; ENGINE_STATE.active_filters = []; renderSubLobby('smartphones'); }

    function renderSubLobby(domain) {
        const section = document.createElement('section'); section.className = "main-slide next";
        let html = `<div class="slide-header"><span class="header-title">FILTER</span></div><div class="lobby-container"><h1 style="text-align:center">PRIORITIES</h1><div style="display:grid; gap:10px; margin-top:20px;">`;
        MODULES[domain].categories.forEach((cat, idx) => { html += `<button class="cuisine-btn" id="filter-btn-${idx}" onclick="toggleFilter('${cat.label}', ${idx})">${cat.label}</button>`; });
        html += `</div><button class="btn btn-primary" style="margin-top:30px" onclick="startHunt()">HUNT &rarr;</button></div>`;
        section.innerHTML = html; document.getElementById('master-container').appendChild(section); slideElements.push(section); goToSlide(slideElements.length - 1);
    }

    function toggleFilter(label, idx) {
        const btn = document.getElementById(`filter-btn-${idx}`);
        if(ENGINE_STATE.active_filters.includes(label)) { ENGINE_STATE.active_filters = ENGINE_STATE.active_filters.filter(x => x !== label); btn.classList.remove('selected'); } 
        else { ENGINE_STATE.active_filters.push(label); btn.classList.add('selected'); }
    }

    function startHunt() {
        if(ENGINE_STATE.active_filters.length === 0) return showToast("SELECT AT LEAST ONE");
        ENGINE_STATE.session_weights = { cam:0.1, gam:0.1, bat:0.1, ui:0.1, dis:0.1, srv:0.1, thm:0.1, dur:0.1, anc:0.1, snd:0.1, mic:0.1, lat:0.1 };
        buildDeck();
    }

    function calculateVerdict() {
        let DB = MODULES[ENGINE_STATE.currentDomain].database;
        let candidates = [];
        const bannedTags = ENGINE_STATE.active_filters.map(f => DEAL_BREAKERS[f.toUpperCase()]).filter(Boolean);

        for (let name in DB) {
            let item = DB[name];
            if(item.tags && item.tags.some(t => bannedTags.includes(t))) continue; // Elimination logic

            let score = 0;
            if(ENGINE_STATE.ecosystem === 'specs' && (item.tags.includes('performance') || item.tags.includes('value'))) score += 3;
            if(ENGINE_STATE.ecosystem === 'peace' && (item.tags.includes('trust') || item.tags.includes('premium'))) score += 3;
            
            for(let attr in item.attr) score += item.attr[attr] * (ENGINE_STATE.session_weights[attr] || 0.1);
            if(ENGINE_STATE.items_detected[name]) score += 10;
            
            candidates.push({name, score, price: item.price, mrp: item.mrp});
        }
        
        candidates.sort((a, b) => b.score - a.score);
        const winner = candidates[0] || {name: "No Match", price: 0};
        ENGINE_STATE.DECISION_LOG = { winner, priorities: ENGINE_STATE.active_filters, timestamp: new Date().toISOString() };
        return winner;
    }

    function buildDeck() {
        const container = document.getElementById('master-container');
        const targetCats = MODULES[ENGINE_STATE.currentDomain].categories.filter(c => ENGINE_STATE.active_filters.includes(c.label));
        
        // If no categories match, show generic cards
        const catsToShow = targetCats.length > 0 ? targetCats : [{label: "Balanced Choice"}];

        catsToShow.forEach((cat, i) => {
            const el = document.createElement('section'); el.className = "main-slide next";
            el.innerHTML = `<div class="slide-header"><span class="header-title">${cat.label}</span></div><div class="carousel-viewport">
                <div class="sub-slide opt-active" data-val="Generic Choice">
                    <div class="role-label">PROPOSAL</div><h1>Best for ${cat.label}</h1>
                    <div class="nav-hint"><span class="skip-btn-clickable" onclick="manualSkip(this)">SKIP</span><span style="color:var(--accent-go)">SELECT &uarr;</span></div>
                </div></div>`;
            container.appendChild(el); slideElements.push(el);
        });

        const final = document.createElement('section'); final.className = "main-slide next";
        final.innerHTML = `
            <video class="video-bg" autoplay loop muted playsinline><source src="${WINNER_VIDEO}" type="video/mp4"></video>
            <div class="winner-container">
                <div id="final-list"></div>
                <div class="final-actions">
                    <button class="btn btn-primary" onclick="redirect()">CHECK PRICE ‚Üó</button>
                    <button class="btn btn-yt" onclick="openReview()">‚ñ∂ WATCH REVIEW</button>
                    <button class="btn btn-doc" onclick="generateDecisionReport()">üìÑ REPORT</button>
                    <button class="btn btn-share" onclick="generateShareCard()">üì∑ SHARE</button>
                </div>
            </div>`;
        container.appendChild(final); slideElements.push(final); goToSlide(currentIdx + 1);
    }

    function updateFinal() {
        const list = document.getElementById('final-list');
        const winner = calculateVerdict();
        const log = ENGINE_STATE.DECISION_LOG;
        const reason = (log.priorities.length > 0) ? `Optimized for ${log.priorities.join(" + ")}` : "Balanced Performance Score";
        
        let priceHtml = `Est. ‚Çπ${winner.price}`;
        if(winner.mrp > winner.price) {
            const off = Math.round(((winner.mrp - winner.price) / winner.mrp) * 100);
            priceHtml = `‚Çπ${winner.price} <span class="deal-tag">(${off}% OFF)</span>`;
        }

        list.innerHTML = `
            <div style="text-align:left;">
                <span style="color:var(--accent-go); font-size:0.8rem; font-weight:bold; letter-spacing:2px;">THE NEUTRAL CHAMPION</span>
                <div style="font-size:2.8rem; font-weight:900; margin:5px 0; color:#fff; line-height:1.1;">${winner.name}</div>
                <p style="color:var(--brand-orange); font-size:0.7rem; font-family:var(--font-tech); text-transform:uppercase;">${reason}</p>
                <p style="color:#eee; font-size:1.1rem; margin-top:5px;">${priceHtml}</p>
            </div>`;
        
        // Log to Backend
        fetch(BACKEND_URL, { method: 'POST', body: JSON.stringify({ event: "WINNER_FOUND", item: winner.name, session_id: ENGINE_STATE.sessionID }) });
        
        const u = new SpeechSynthesisUtterance(`The winner is ${winner.name}.`);
        window.speechSynthesis.speak(u);
    }

    // --- SEARCH / RESEARCH ---
    async function renderSearchSlide() {
        const section = document.createElement('section'); section.className = "main-slide next";
        let topicsHTML = `<div class="topic-grid">` + Object.keys(CURATED_PATHS).map(k=>`<div class="topic-card" onclick="document.getElementById('search-input').value='${k}';executeSearch()"><div class="topic-title">${CURATED_PATHS[k].title}</div></div>`).join('') + `</div>`;
        section.innerHTML = `<div class="slide-header"><span class="header-title">RESEARCH</span></div><div class="lobby-container"><h1>TOPIC?</h1><div class="search-wrapper"><input type="text" id="search-input" placeholder="e.g. Systems, AI..."></div><button class="btn btn-primary" onclick="executeSearch()">SEARCH &rarr;</button>${topicsHTML}</div>`;
        document.getElementById('master-container').appendChild(section); slideElements.push(section); goToSlide(1);
    }

    async function executeSearch() {
        const q = document.getElementById('search-input').value;
        if(!q) return showToast("ENTER TOPIC");
        showToast("SEARCHING NETWORK...");
        
        fetch(BACKEND_URL, { method: 'POST', body: JSON.stringify({ event: "SEARCH_QUERY", query: q, session_id: ENGINE_STATE.sessionID }) });

        // ONDC Proxy -> Fallback Wiki
        try {
            const response = await fetch(`${BACKEND_URL}?type=search&q=${encodeURIComponent(q)}`);
            const ondcData = await response.json();
            if(ondcData.items) { showToast("PRODUCTS FOUND!"); /* Handle ONDC Items here in v94 */ }
            else {
                const node = await WIKI_ENGINE.buildKnowledgeNode(q);
                if(!node) return showToast("NOT FOUND");
                ENGINE_STATE.researchPath = [node];
                buildResearchDeck(node);
            }
        } catch(e) { showToast("OFFLINE SEARCH"); }
    }

    function buildResearchDeck(context) {
        const section = document.createElement('section'); section.className = "main-slide next";
        section.innerHTML = `<div class="slide-header"><span class="header-title">DEPTH: ${ENGINE_STATE.researchPath.length}</span><div style="display:flex;gap:10px"><button class="skip-btn-clickable" onclick="window.open('https://amazon.in/s?k=${context.title}')">SHOP NODE ‚Üó</button></div></div>
            <div class="carousel-viewport"><div class="sub-slide static"><div class="role-label">KNOWLEDGE NODE</div><h1>${context.title}</h1><div class="wiki-summary">${context.summary}</div><div class="nav-hint"><span>BACK</span><span>DIG DEEPER</span></div></div>
            ${context.links.map(l=>`<div class="sub-slide opt-hidden" data-val="${l.name}"><div class="role-label">RELATED</div><h1>${l.name}</h1><div class="nav-hint"><span class="skip-btn-clickable" onclick="manualSkip(this)">SKIP</span><span style="color:var(--accent-go)">SELECT &uarr;</span></div></div>`).join('')}</div>`;
        document.getElementById('master-container').appendChild(section); slideElements.push(section); goToSlide(slideElements.length - 1);
    }

    // --- TRIVIA & EXTRAS ---
    function renderTriviaGate() {
        const section = document.createElement('section'); section.className = "main-slide next";
        section.innerHTML = `<div class="slide-header"><span class="header-title">TRIVIA</span></div><div class="lobby-container"><h1 style="text-align:center">CATEGORY</h1><div style="display:grid; gap:15px;"><button class="cuisine-btn" onclick="startTrivia(9)">GENERAL</button><button class="cuisine-btn" onclick="startTrivia(18)">COMPUTERS</button><button class="cuisine-btn" onclick="startTrivia(17)">SCIENCE</button></div></div>`;
        document.getElementById('master-container').appendChild(section); slideElements.push(section); goToSlide(1);
    }

    async function startTrivia(cat) {
        showToast("FETCHING Qs...");
        const data = await TRIVIA_ENGINE.fetch(cat);
        if(!data.length) return showToast("ERROR");
        const container = document.getElementById('master-container');
        data.forEach((q, i) => {
            const el = document.createElement('section'); el.className = "main-slide next";
            const answers = [...q.incorrect_answers, q.correct_answer].sort(() => Math.random() - 0.5);
            el.innerHTML = `<div class="slide-header"><span class="header-title">Q${i+1}</span></div><div class="carousel-viewport">
                ${answers.map((ans,idx) => `<div class="sub-slide ${idx===0?'opt-active':'opt-hidden'}" data-correct="${ans===q.correct_answer}"><div class="role-label">${q.difficulty.toUpperCase()}</div><h1 style="font-size:1.4rem">${q.question}</h1><div style="margin-top:20px; font-size:1.2rem; color:var(--brand-orange)">${ans}</div><div class="nav-hint"><span class="skip-btn-clickable" onclick="manualSkip(this)">SKIP</span><span style="color:var(--accent-go)">SELECT &uarr;</span></div></div>`).join('')}</div>`;
            container.appendChild(el); slideElements.push(el);
        });
        goToSlide(slideElements.length - data.length);
    }

    function openVoiceLobby() {
        window.speechSynthesis.cancel(); addGlobalExit();
        const section = document.createElement('section'); section.className = "main-slide next";
        section.innerHTML = `<div class="slide-header"><span class="header-title">VOICE MODULE</span></div><div class="lobby-container"><h1>VOICE FEEDS</h1><div class="topic-grid">${VOICE_FEED.map(v=>`<div class="topic-card" onclick="playVoice('${v.id}')"><div class="topic-title">${v.title}</div><div class="topic-desc">${v.mode}</div></div>`).join('')}</div></div>`;
        document.getElementById('master-container').appendChild(section); slideElements.push(section); goToSlide(1);
    }
    function playVoice(id) { const f = VOICE_FEED.find(v=>v.id===id); if(f) { window.speechSynthesis.speak(new SpeechSynthesisUtterance(f.blocks.map(b=>b.text).join('. '))); showToast("PLAYING..."); } }

    function renderExternalModule(url) { addGlobalExit(); const s=document.createElement('section'); s.className="main-slide next"; s.innerHTML=`<iframe src="${url}"></iframe>`; document.getElementById('master-container').appendChild(s); slideElements.push(s); goToSlide(slideElements.length-1); }

    // --- SYSTEM UTILS ---
    function showTutorial() {
        if(localStorage.getItem('tutorial_done')) return;
        const o = document.createElement('div');
        o.style = "position:fixed; inset:0; background:rgba(0,0,0,0.9); z-index:10000; display:flex; flex-direction:column; align-items:center; justify-content:center; text-align:center; color:#fff;";
        o.innerHTML = `<div style="font-size:3rem; margin-bottom:20px;">‚òùÔ∏è</div><h2>SWIPE UP TO SELECT</h2><p style="color:#888;">Swipe Down to go back</p><button class="btn btn-primary" style="width:auto; margin-top:30px; padding:12px 30px;" onclick="this.parentElement.remove(); localStorage.setItem('tutorial_done', true);">GOT IT</button>`;
        document.body.appendChild(o);
    }

    function generateDecisionReport() {
        const log = ENGINE_STATE.DECISION_LOG;
        if(!log) return showToast("NO DATA");
        const { jsPDF } = window.jspdf; const doc = new jsPDF();
        doc.setFontSize(22); doc.setTextColor(255, 103, 31); doc.text("DECISION REPORT", 14, 22);
        doc.setFontSize(10); doc.setTextColor(0); doc.text(`WINNER: ${log.winner.name}`, 14, 40);
        doc.save(`Report_${ENGINE_STATE.sessionID}.pdf`); showToast("DOWNLOADED");
    }

    async function generateShareCard() {
        const w = calculateVerdict();
        document.getElementById('share-winner-name').innerText = w.name;
        document.getElementById('share-winner-price').innerText = "‚Çπ"+w.price;
        const card = document.getElementById('share-card-canvas');
        card.style.top = "0";
        try {
            const canvas = await html2canvas(card, {scale:2});
            card.style.top = "-200vh";
            canvas.toBlob(blob => {
                const file = new File([blob], "Winner.png", {type:"image/png"});
                if(navigator.share) navigator.share({files:[file]});
                else { const l = document.createElement('a'); l.download="Winner.png"; l.href=canvas.toDataURL(); l.click(); }
            });
        } catch(e) { card.style.top = "-200vh"; }
    }

    function addGlobalExit() { if(!document.getElementById('global-exit')) { const b=document.createElement('button'); b.id='global-exit'; b.className='exit-btn'; b.innerText='EXIT'; b.onclick=()=>renderLobby(); b.style.position='fixed'; b.style.top='20px'; b.style.right='20px'; b.style.zIndex='5000'; document.body.appendChild(b); } }
    function goToSlide(idx) { if(idx<0||idx>=slideElements.length)return; slideElements[currentIdx].classList.replace('active', idx>currentIdx?'prev':'next'); currentIdx=idx; slideElements[currentIdx].className="main-slide active"; if(slideElements[currentIdx].querySelector('#final-list')) updateFinal(); }
    function showToast(m) { const t=document.getElementById('toast'); t.innerText=m; t.classList.add('visible'); setTimeout(()=>t.classList.remove('visible'),2000); }
    function updateStatus(is) { const d=document.querySelector('.status-dot'); if(d) is?d.classList.remove('offline'):d.classList.add('offline'); }
    function manualSkip(el) { const v=el.closest('.carousel-viewport'); const a=v.querySelector('.sub-slide.opt-active'); if(!a)return; const sib=Array.from(v.querySelectorAll('.sub-slide:not(.static)')); const n=sib[(sib.indexOf(a)+1)%sib.length]; a.classList.replace('opt-active','opt-hidden'); n.classList.replace('opt-hidden','opt-active'); }
    function redirect() { const i=Object.keys(ENGINE_STATE.items_detected)[0]; if(!i)return showToast("SELECT ITEM"); window.open(`https://www.amazon.in/s?k=${encodeURIComponent(i)}&tag=${AMZN_TAG}`); }

    let tsY=0;
    function initSwipeSystem() {
        document.addEventListener('touchstart', e => tsY=e.touches[0].clientY, {passive:true});
        document.addEventListener('touchend', e => {
            if(e.target.closest('.wiki-summary')) return;
            const view = e.target.closest('.main-slide.active .carousel-viewport');
            if(!view) return;
            const dy = e.changedTouches[0].clientY - tsY;
            const active = view.querySelector('.sub-slide.opt-active') || view.querySelector('.sub-slide.static');
            if(dy < -60) {
                if(active.classList.contains('static')) { active.classList.remove('static'); active.classList.add('opt-hidden'); view.querySelector('.sub-slide:nth-child(2)').classList.add('opt-active'); }
                else if(ENGINE_STATE.triviaMode) { if(active.dataset.correct==="true") { showToast("CORRECT!"); setTimeout(()=>goToSlide(currentIdx+1),800); } else showToast("WRONG!"); }
                else if(active.dataset.val) { if(ENGINE_STATE.currentDomain==='smartphones'||ENGINE_STATE.currentDomain==='earbuds') { ENGINE_STATE.items_detected[active.dataset.val]=true; goToSlide(currentIdx+1); } else diveDeeper(active.dataset.val); }
            } else if(dy > 60) {
                if(ENGINE_STATE.currentDomain==='research' && ENGINE_STATE.researchPath.length>1) { ENGINE_STATE.researchPath.pop(); buildResearchDeck(ENGINE_STATE.researchPath[ENGINE_STATE.researchPath.length-1]); }
                else goToSlide(currentIdx-1);
            }
        });
    }
    
    function boot() { 
        ENGINE_STATE.sessionID = "SID-" + Math.random().toString(36).substr(2,4).toUpperCase();
        syncDatabase(); renderLobby(); initSwipeSystem(); showTutorial();
    }

    boot();
</script>
</body>
</html>
