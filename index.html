<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>| decide.engine |</title>

    <link rel="manifest" href="manifest.json">
    <meta name="theme-color" content="#0a0a0a">
    <meta name="background-color" content="#0a0a0a">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="decide.engine">
    <link rel="apple-touch-icon" href="icons/icon-192.png">
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="application-name" content="decide.engine">
    <meta name="description" content="Voice-first decision engine">

    <style>
        /* =========================================
           CORE SYSTEM | KUTCH AUTOMATION
           ========================================= */
        :root {
            --brand-orange: #ff671f;
            --brand-bg: #0a0a0a;
            --text-main: #f0f0f0;
            --accent-go: #00e676; 
            --accent-skip: #ff3333;
            --accent-zomato: #cb202d;
            --accent-swiggy: #fc8019;
            --accent-blinkit: #f8cb46;
            --font-tech: 'Courier New', monospace;
            --font-ui: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
        }

        html, body {
            margin: 0; padding: 0; height: 100%; width: 100%;
            background-color: var(--brand-bg);
            color: var(--text-main);
            font-family: var(--font-ui);
            overflow: hidden;
            touch-action: none; 
            -webkit-user-select: none;
            user-select: none;
        }

        #master-container { height: 100vh; width: 100vw; position: relative; overflow: hidden; }

        .main-slide {
            height: 100vh; width: 100vw; position: absolute; top: 0; left: 0;
            display: flex; flex-direction: column; background: var(--brand-bg);
            transition: transform 0.5s cubic-bezier(0.2, 0.8, 0.2, 1);
            will-change: transform;
        }

        .main-slide.prev { transform: translateY(-100%); }
        .main-slide.active { transform: translateY(0); z-index: 10; }
        .main-slide.next { transform: translateY(100%); z-index: 20; }

        .slide-header {
            padding: 20px; border-left: 3px solid var(--brand-orange); height: 70px;
            flex-shrink: 0; z-index: 10; display: flex; align-items: center;
        }

        .header-title {
            font-family: var(--font-tech); font-size: 0.75rem; color: var(--brand-orange);
            letter-spacing: 1px; font-weight: 700; text-transform: uppercase;
        }

        .carousel-viewport { position: relative; flex-grow: 1; width: 100%; height: 100%; }

        .sub-slide {
            position: absolute; inset: 0; padding: 25px; display: flex; flex-direction: column;
            justify-content: center; opacity: 0; pointer-events: none; transform: translateX(20px);
            transition: transform 0.3s ease, opacity 0.3s ease;
        }

        .sub-slide.opt-active { z-index: 30; opacity: 1; pointer-events: auto; transform: translateX(0); }
        .sub-slide.opt-hidden { z-index: 0; opacity: 0; pointer-events: none; }
        .sub-slide.static { z-index: 30; opacity: 1; pointer-events: auto; transform: none; }

        h1 { font-size: 1.8rem; margin: 0 0 15px 0; line-height: 1; letter-spacing: -1px; color: var(--brand-orange); }
        .primary-question { font-size: 1.1rem; color: #fff; margin-bottom: 25px; line-height: 1.4; font-weight: 600; }
        
        .role-label {
            font-family: var(--font-tech); font-size: 0.6rem; color: #000;
            background: var(--accent-go); padding: 4px 8px; border-radius: 4px;
            width: fit-content; margin-bottom: 15px; font-weight: bold;
        }

        .nav-hint {
            margin-top: 30px; padding-top: 20px; border-top: 1px solid #333;
            font-family: var(--font-tech); font-size: 0.7rem; color: #666;
            display: flex; justify-content: space-between;
        }

        .input-group { 
            border: 1px solid #333; background: #111; padding: 20px; border-radius: 8px; 
            margin-bottom: 20px; min-height: 100px; max-height: 40vh; overflow-y: auto; 
        }
        
        .input-row { display: flex; justify-content: space-between; border-bottom: 1px dashed #333; padding: 10px 0; font-family: var(--font-tech); font-size: 0.8rem; }
        .input-key { color: #888; text-transform: uppercase; }
        .input-val { color: var(--accent-go); font-weight: bold; text-align: right; }
        
        .final-actions { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-top: 20px; }
        .btn { background: #222; color: #fff; border: 1px solid #333; padding: 15px; border-radius: 8px; font-weight: 600; text-align: center; font-size: 0.8rem; cursor: pointer; display: block; width: 100%; box-sizing: border-box; transition: opacity 0.3s; }
        .btn-full { grid-column: span 2; }
        .btn-wa { background: #25D366; color: #000; border: none; }
        .btn-zomato { background: var(--accent-zomato); border: none; }
        .btn-swiggy { background: var(--accent-swiggy); border: none; }
        .btn-blinkit { background: var(--accent-blinkit); color: #000; border: none; }
        .btn-amazon { background: #232f3e; border: none; color: #ff9900; }
        .btn-auto { background: var(--brand-orange); color: #000; border: none; font-weight: 800; }
        
        .btn.active { box-shadow: 0 0 15px rgba(255,255,255,0.2); border: 1px solid #fff; }

        .lobby-container { display: flex; flex-direction: column; gap: 15px; padding: 30px; height: 100%; justify-content: center; }
        .cuisine-btn { background: #222; border: 1px solid #444; color: #888; padding: 20px; font-size: 1.1rem; font-weight: bold; text-transform: uppercase; border-radius: 12px; transition: all 0.2s; }
        .cuisine-btn.selected { background: var(--brand-orange); color: #000; border-color: var(--brand-orange); }

        #depth-fill { position: fixed; right: 0; top: 0; bottom: 0; width: 4px; background: #333; z-index: 900; height: 0%; transition: height 0.05s linear; }
        
        .toast-msg { position: fixed; bottom: 100px; left: 50%; transform: translateX(-50%); background: #222; color: #00e676; padding: 10px 20px; border: 1px solid #00e676; border-radius: 20px; font-size: 0.8rem; opacity: 0; pointer-events: none; transition: opacity 0.3s; z-index: 3000; font-family: var(--font-tech); }
        .toast-msg.visible { opacity: 1; }

        #mic-toggle { position: fixed; bottom: 20px; left: 20px; width: 50px; height: 50px; background: #111; border-radius: 50%; display: flex; align-items: center; justify-content: center; border: 1px solid #444; z-index: 2000; cursor: pointer; }
        #mic-toggle.listening { border-color: var(--accent-go); box-shadow: 0 0 15px rgba(0,230,118,0.3); }
        #mic-toggle svg { fill: #666; width: 24px; }
        #mic-toggle.listening svg { fill: var(--accent-go); }
    </style>
</head>
<body>

<div id="master-container"></div>
<div id="depth-fill"></div>
<div id="toast" class="toast-msg"></div>

<div id="mic-toggle" onclick="toggleListenMode()">
    <svg viewBox="0 0 24 24"><path d="M12 14c1.66 0 3-1.34 3-3V5c0-1.66-1.34-3-3-3S9 3.34 9 5v6c0 1.66 1.34 3 3 3z"/><path d="M17 11c0 2.76-2.24 5-5 5s-5-2.24-5-5H5c0 3.53 2.61 6.43 6 6.92V21h2v-3.08c3.39-.49 6-3.39 6-6.92h-2z"/></svg>
</div>

<script>
    /* =========================================
       KUTCH AUTOMATION | UNIVERSAL OS v35.0
       ========================================= */
    
    // üß† 1. PHONE TRUTH DATABASE (Scores 1-10)
    const PHONE_DATABASE = {
      "Vivo V60e": { attr: { camera: 9.5, gaming: 5.0, battery: 7.0, ui: 7.0 }, price: 28999 },
      "Xiaomi 14 Civi": { attr: { camera: 9.0, gaming: 6.0, battery: 6.5, ui: 6.0 }, price: 32999 },
      "Poco F7": { attr: { camera: 6.0, gaming: 9.5, battery: 8.0, ui: 4.0 }, price: 29999 },
      "iQOO Neo 10R": { attr: { camera: 6.5, gaming: 9.0, battery: 7.5, ui: 5.0 }, price: 30999 },
      "Nothing 3a Pro": { attr: { camera: 8.0, gaming: 6.0, battery: 7.0, ui: 10.0 }, price: 27999 },
      "Samsung A55": { attr: { camera: 7.5, gaming: 5.0, battery: 6.5, ui: 9.0 }, price: 33999 },
      "Realme GT 7T": { attr: { camera: 5.0, gaming: 8.5, battery: 10.0, ui: 5.0 }, price: 31999 },
      "iQOO Z10": { attr: { camera: 5.5, gaming: 7.0, battery: 9.0, ui: 6.0 }, price: 25999 }
    };

    // üß† 2. AUDIO TRUTH DATABASE
    const AUDIO_DATABASE = {
      "Sony WF-1000XM6": { attr: { anc: 9.8, sound: 9.5, mic: 8.0, latency: 6.0 }, price: 24990 },
      "Nothing Ear (4)": { attr: { anc: 8.0, sound: 8.5, mic: 9.0, latency: 7.0 }, price: 11999 },
      "OnePlus Buds Pro 4": { attr: { anc: 8.5, sound: 9.0, mic: 8.5, latency: 8.0 }, price: 12999 },
      "Realme Buds Air 7": { attr: { anc: 7.5, sound: 7.5, mic: 7.0, latency: 9.0 }, price: 5999 },
      "Samsung Buds 3 Pro": { attr: { anc: 9.0, sound: 9.0, mic: 8.5, latency: 7.5 }, price: 19999 },
      "Razer Hammerhead V3": { attr: { anc: 6.0, sound: 7.0, mic: 7.0, latency: 9.8 }, price: 14999 }
    };

    // üß† 3. FOOD TRUTH DATABASE (New Schema)
    const FOOD_DATABASE = {
        "Paneer Butter Masala": { attr: { comfort: 9.0, heaviness: 8.5, spice: 5.0, protein: 6.0, speed: 4.0 }, price: 240 },
        "Dal Makhani": { attr: { comfort: 9.5, heaviness: 9.0, spice: 4.0, protein: 5.0, speed: 3.0 }, price: 220 },
        "Butter Naan": { attr: { comfort: 8.0, heaviness: 7.0, spice: 1.0, protein: 2.0, speed: 8.0 }, price: 40 },
        "Hakka Noodles": { attr: { comfort: 7.0, heaviness: 5.0, spice: 6.0, protein: 3.0, speed: 9.0 }, price: 200 },
        "Chilli Chicken": { attr: { comfort: 6.0, heaviness: 6.0, spice: 9.0, protein: 9.0, speed: 8.0 }, price: 260 },
        "Coke": { attr: { comfort: 5.0, heaviness: 2.0, spice: 0.0, protein: 0.0, speed: 10.0 }, price: 40 },
        "Chips": { attr: { comfort: 4.0, heaviness: 3.0, spice: 4.0, protein: 1.0, speed: 10.0 }, price: 20 },
        "Grilled Chicken Salad": { attr: { comfort: 3.0, heaviness: 2.0, spice: 3.0, protein: 9.5, speed: 6.0 }, price: 280 }
    };

    const DEEP_LINKS = {
        zomato: { app: q => `intent://search?q=${q}#Intent;scheme=zomato;package=com.application.zomato;end`, web: q => `https://www.zomato.com/search?q=${q}` },
        swiggy: { app: q => `swiggy://explore?query=${q}`, web: q => `https://www.swiggy.com/search?query=${q}` },
        blinkit: { app: _ => `blinkit://`, web: q => `https://blinkit.com/s/?q=${q}` }
    };

    const ECOM_DEEP_LINKS = {
        amazon: { app: q => `intent://www.amazon.in/s?k=${q}#Intent;scheme=https;package=com.amazon.mShop.android.shopping;end`, web: q => `https://www.amazon.in/s?k=${q}` },
        flipkart: { app: q => `flipkart://search?q=${q}`, web: q => `https://www.flipkart.com/search?q=${q}` },
        croma: { app: q => `https://www.croma.com/search/?text=${q}`, web: q => `https://www.croma.com/search/?text=${q}` }
    };

    const FALLBACK_MENU = {
      "smartphones": {
          "label": "SMARTPHONES 2026",
          "categories": [
              { "label": "CAMERA-FIRST", "type": "camera", "items": [{"name": "Vivo V60e"}, {"name": "Xiaomi 14 Civi"}] },
              { "label": "PRO GAMER", "type": "gaming", "items": [{"name": "Poco F7"}, {"name": "iQOO Neo 10R"}] },
              { "label": "BATTERY KING", "type": "battery", "items": [{"name": "Realme GT 7T"}, {"name": "iQOO Z10"}] }
          ]
      },
      "earbuds": {
          "label": "EARBUDS 2026",
          "categories": [
              { "label": "MUSIC LOVER", "type": "sound", "items": [{"name": "Sony WF-1000XM6"}, {"name": "OnePlus Buds Pro 4"}] },
              { "label": "GAMING (LOW LATENCY)", "type": "latency", "items": [{"name": "Razer Hammerhead V3"}, {"name": "Realme Buds Air 7"}] },
              { "label": "TRAVEL (ANC)", "type": "anc", "items": [{"name": "Sony WF-1000XM6"}, {"name": "Samsung Buds 3 Pro"}] }
          ]
      },
      "food": {
          "label": "DINING",
          "categories": [
              { "label": "COMFORT FOOD", "type": "comfort", "items": [{"name": "Dal Makhani"}, {"name": "Butter Naan"}] },
              { "label": "HEALTHY CHOICE", "type": "health", "items": [{"name": "Grilled Chicken Salad"}, {"name": "Paneer Butter Masala"}] },
              { "label": "PARTY SNACK", "type": "spice", "items": [{"name": "Chilli Chicken"}, {"name": "Coke"}] },
              { "label": "QUICK BITE", "type": "speed", "items": [{"name": "Hakka Noodles"}, {"name": "Chips"}] }
          ]
      }
    };

    let ENGINE_STATE = { 
        cuisines_detected: [], 
        items_detected: {}, 
        session_weights: { 
            // Phones
            camera: 0.1, gaming: 0.1, battery: 0.1, ui: 0.1, 
            // Audio
            anc: 0.1, sound: 0.1, mic: 0.1, latency: 0.1,
            // Food
            comfort: 0.1, health: 0.1, spice: 0.1, speed: 0.1, protein: 0.1
        } 
    };
    
    let RAW_DATA = {};
    let slideElements = [];
    let currentIdx = 0;

    function normalizeData(source) {
        if (!source) return {};
        if (source.smartphones && source.food && source.earbuds) return source;
        return FALLBACK_MENU;
    }

    async function boot() {
        RAW_DATA = normalizeData(FALLBACK_MENU); 
        renderLobby();
        initVoice();
    }

    /* =========================================
       UI LAYER 1: SELECTION LOBBY
       ========================================= */
    function renderLobby() {
        const container = document.getElementById('master-container');
        container.innerHTML = "";
        const section = document.createElement('section');
        section.className = "main-slide active";
        section.id = "lobby";
        
        let html = `<div class="slide-header"><span class="header-title">DECIDE OS v35.0</span></div>
                    <div class="lobby-container">
                    <h1 style="text-align:center">SELECT DOMAIN</h1><div style="display:grid; gap:15px;">`;
        
        for(let key in RAW_DATA) {
            const isSelected = ENGINE_STATE.cuisines_detected.includes(key) ? "selected" : "";
            html += `<button class="cuisine-btn ${isSelected}" onclick="toggleSelection('${key}', this)">${RAW_DATA[key].label}</button>`;
        }
        
        html += `</div><button class="btn btn-auto btn-full" style="margin-top:30px" onclick="startHunt()">START DECISION &rarr;</button></div>`;
        section.innerHTML = html;
        container.appendChild(section);
        slideElements = [section];
        currentIdx = 0;
    }

    function toggleSelection(id, btn) {
        if(ENGINE_STATE.cuisines_detected.includes(id)) {
            ENGINE_STATE.cuisines_detected = [];
            document.querySelectorAll('.cuisine-btn').forEach(b => b.classList.remove('selected'));
        } else {
            ENGINE_STATE.cuisines_detected = [id]; 
            document.querySelectorAll('.cuisine-btn').forEach(b => b.classList.remove('selected'));
            btn.classList.add('selected');
        }
    }

    function startHunt() { 
        if(ENGINE_STATE.cuisines_detected.length === 0) return showToast("PLEASE SELECT ONE");
        buildDeck(); 
    }

    /* =========================================
       UI LAYER 2: THE DECK & NEURAL LOGIC
       ========================================= */
    function buildDeck() {
        const container = document.getElementById('master-container');
        container.innerHTML = "";
        let slides = [];
        
        ENGINE_STATE.cuisines_detected.forEach(c => {
            if(RAW_DATA[c]) {
                RAW_DATA[c].categories.forEach(cat => {
                    slides.push({ type: 'opt', catType: cat.type || 'generic', title: `${RAW_DATA[c].label} ¬∑ ${cat.label}`, items: cat.items });
                });
            }
        });
        slides.push({ type: 'final', title: 'FINAL VERDICT' });

        slides.forEach((s, idx) => {
            const el = document.createElement('section');
            el.className = `main-slide ${idx === 0 ? 'active' : 'next'}`;
            el.dataset.catType = s.catType; 
            
            let html = `<div class="slide-header"><span class="header-title">${s.title}</span></div><div class="carousel-viewport">`;
            
            if(s.type === 'opt') {
                s.items.forEach((item, i) => {
                    html += `<div class="sub-slide ${i===0?'opt-active':'opt-hidden'}" data-val="${item.name}">
                             <div class="role-label">${s.title.split('¬∑')[1]}</div>
                             <h1>${item.name}</h1><div class="primary-question">Swipe Down to Select</div>
                             <div class="nav-hint"><span>&larr; BROWSE</span><span style="color:var(--accent-go)">SELECT &darr;</span><span>SKIP &rarr;</span></div>
                             </div>`;
                });
            } else {
                html += `<div class="sub-slide static"><div class="input-group" id="final-list"></div>
                         <div class="final-actions">
                            <button class="btn btn-auto btn-full" onclick="copyAndRedirect('auto')">AUTO ROUTE</button>
                            <button class="btn btn-amazon" id="btn-amazon" onclick="copyAndRedirect('amazon')">AMAZON</button>
                            <button class="btn btn-zomato" id="btn-zomato" onclick="copyAndRedirect('zomato')">ZOMATO</button>
                            <button class="btn btn-wa" onclick="sendWhatsapp()">WHATSAPP</button>
                            <button class="btn btn-full" onclick="location.reload()">RESTART</button>
                         </div></div>`;
            }
            html += `</div>`;
            el.innerHTML = html;
            container.appendChild(el);
        });
        slideElements = Array.from(document.querySelectorAll('.main-slide'));
        currentIdx = 0;
        attachEvents();
        updateResult();
    }

    /* üß† NEURAL ENGINE: UNIVERSAL CALCULATOR */
    function calculateVerdict() {
        const isFood = ENGINE_STATE.cuisines_detected.includes("food");
        const isAudio = ENGINE_STATE.cuisines_detected.includes("earbuds");
        
        let DB = PHONE_DATABASE;
        if(isFood) DB = FOOD_DATABASE;
        if(isAudio) DB = AUDIO_DATABASE;

        let scores = [];
        for (let itemName in DB) {
            let item = DB[itemName];
            let score = 0;
            
            // üß† NEURAL MATH: Œ£ (Attribute * Session Weight)
            for (let attr in item.attr) {
                // Mapping complex food weights (e.g. Health -> Protein/Heaviness)
                let userWeight = 0.1; 
                
                if (isFood) {
                    if (attr === 'protein' && ENGINE_STATE.session_weights['health'] > 0.2) userWeight += 0.3;
                    if (attr === 'heaviness' && ENGINE_STATE.session_weights['comfort'] > 0.2) userWeight += 0.3;
                    if (attr === 'spice' && ENGINE_STATE.session_weights['spice'] > 0.2) userWeight += 0.4;
                    if (attr === 'speed' && ENGINE_STATE.session_weights['speed'] > 0.2) userWeight += 0.4;
                } else {
                    userWeight = ENGINE_STATE.session_weights[attr] || 0.1;
                }
                
                score += (item.attr[attr] * userWeight);
            }
            
            if (ENGINE_STATE.items_detected[itemName]) score += 5.0; 
            scores.push({ name: itemName, score: score, price: item.price });
        }
        
        scores.sort((a, b) => b.score - a.score);
        return [scores[0], scores[1]]; 
    }

    /* =========================================
       UX PHYSICS ENGINE
       ========================================= */
    function attachEvents() {
        document.querySelectorAll('.carousel-viewport').forEach(view => {
            let startX = 0, startY = 0;
            view._curr = 0;
            view.addEventListener('touchstart', e => { startX = e.touches[0].clientX; startY = e.touches[0].clientY; }, {passive:true});
            view.addEventListener('touchmove', e => {
                const dy = e.touches[0].clientY - startY;
                if(dy > 0 && Math.abs(dy) > Math.abs(e.touches[0].clientX - startX)) {
                    document.getElementById('depth-fill').style.height = Math.min((dy/150)*100, 100) + '%';
                }
            }, {passive:false});
            view.addEventListener('touchend', e => {
                const dx = e.changedTouches[0].clientX - startX;
                const dy = e.changedTouches[0].clientY - startY;
                document.getElementById('depth-fill').style.height = '0%';
                
                const currentSlide = view.closest('.main-slide');
                const catType = currentSlide.dataset.catType;

                if(Math.abs(dy) > Math.abs(dx)) {
                    if(dy > 80) { // SELECT
                        const slides = view.querySelectorAll('.sub-slide');
                        if(slides[view._curr]) {
                            const val = slides[view._curr].dataset.val;
                            ENGINE_STATE.items_detected[val] = { qty: 1 };
                            if(catType && ENGINE_STATE.session_weights[catType] !== undefined) ENGINE_STATE.session_weights[catType] += 0.25;
                            showToast("SELECTED");
                            goToSlide(currentIdx + 1);
                        }
                    } else if (dy < -80) goToSlide(currentIdx - 1);
                } else {
                    const slides = view.querySelectorAll('.sub-slide');
                    if(slides.length <= 1) return;
                    if(dx < -60 || dx > 60) {
                        if(catType && ENGINE_STATE.session_weights[catType] !== undefined) ENGINE_STATE.session_weights[catType] -= 0.05;
                    }
                    if(dx < -60) {
                        slides[view._curr].classList.replace('opt-active', 'opt-hidden');
                        view._curr = (view._curr + 1) % slides.length;
                        slides[view._curr].classList.replace('opt-hidden', 'opt-active');
                    } else if (dx > 60) {
                        slides[view._curr].classList.replace('opt-active', 'opt-hidden');
                        view._curr = (view._curr - 1 + slides.length) % slides.length;
                        slides[view._curr].classList.replace('opt-hidden', 'opt-active');
                    }
                }
            });
        });
    }

    function goToSlide(idx) {
        if(idx < 0 || idx >= slideElements.length) return;
        slideElements[currentIdx].classList.replace('active', idx > currentIdx ? 'prev' : 'next');
        currentIdx = idx;
        slideElements[currentIdx].className = 'main-slide active';
        if(slideElements[currentIdx].querySelector('#final-list')) updateResult();
    }

    function updateResult() {
        const list = document.getElementById('final-list');
        if(!list) return;

        const winners = calculateVerdict();
        
        // Dynamic Button Visibility based on Domain
        const isFood = ENGINE_STATE.cuisines_detected.includes("food");
        document.getElementById('btn-amazon').style.display = isFood ? 'none' : 'block';
        document.getElementById('btn-zomato').style.display = isFood ? 'block' : 'none';

        let html = "";
        if (winners) {
            html += `<div class="biz-card" style="margin-bottom:20px; border-color:var(--accent-go);">
                        <span class="biz-tagline">üèÜ WINNER</span>
                        <div class="biz-title">${winners[0].name}</div>
                        <p style="color:#aaa;">Score: ${winners[0].score.toFixed(1)} ¬∑ ‚Çπ${winners[0].price}</p>
                     </div>`;
            html += `<div class="biz-card" style="margin-bottom:20px; border-color:#666;">
                        <span class="biz-tagline">ü•à RUNNER UP</span>
                        <div class="biz-title" style="font-size:1.2rem">${winners[1].name}</div>
                        <p style="color:#aaa;">Score: ${winners[1].score.toFixed(1)} ¬∑ ‚Çπ${winners[1].price}</p>
                     </div>`;
             
             ENGINE_STATE.items_detected = {}; 
             ENGINE_STATE.items_detected[winners[0].name] = { qty: 1 };
        }
        list.innerHTML = html || "<div style='text-align:center'>Empty</div>";
    }

    function resolvePlatform() {
        const text = Object.keys(ENGINE_STATE.items_detected).join(" ").toLowerCase();
        if (text.match(/iphone|samsung|phone|vivo|poco|iqoo|motorola|nothing|charger|cable|buds|realme|xiaomi|sony|razer|oneplus/)) return "amazon";
        if (text.match(/coke|chips|soda|water|snack|biscuit/)) return "blinkit";
        return "zomato";
    }

    function copyAndRedirect(requested = "auto") {
        const items = Object.keys(ENGINE_STATE.items_detected);
        if(!items.length) return showToast("EMPTY");

        const mode = requested === "auto" ? resolvePlatform() : requested;
        const target = ["amazon","flipkart","croma"].includes(mode) ? ECOM_DEEP_LINKS[mode] : DEEP_LINKS[mode];
        
        const q = encodeURIComponent(items.join(", "));
        navigator.clipboard.writeText(items.join(", "));
        showToast(`ROUTING TO ${mode.toUpperCase()}`);

        const start = Date.now();
        window.location.href = target.app(q);
        setTimeout(() => { if(Date.now() - start < 1600) window.location.href = target.web(q); }, 1500);
    }

    function sendWhatsapp() {
        const items = Object.keys(ENGINE_STATE.items_detected);
        if(!items.length) return;
        const text = encodeURIComponent(`*FINAL VERDICT*\n- ${items.join("\n- ")}`);
        window.open(`https://wa.me/916351537770?text=${text}`, "_blank");
    }

    function showToast(m) { const t = document.getElementById('toast'); t.innerText = m; t.classList.add('visible'); setTimeout(() => t.classList.remove('visible'), 2000); }

    function initVoice() {
        const SR = window.SpeechRecognition || window.webkitSpeechRecognition;
        if(!SR) return;
        const rec = new SR();
        rec.onresult = e => { if(e.results[0][0].transcript.toLowerCase().includes("next")) goToSlide(currentIdx + 1); };
        window.toggleListenMode = () => {
            const m = document.getElementById('mic-toggle');
            if(m.classList.contains('listening')) { rec.stop(); m.classList.remove('listening'); }
            else { rec.start(); m.classList.add('listening'); }
        };
    }

    boot();
</script>
</body>
</html>
