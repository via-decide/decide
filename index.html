<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>Decide Engine | OS v84.5 (Bridge)</title>
    
    <meta name="theme-color" content="#000000">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <link rel="manifest" href="manifest.json">
    
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://html2canvas.hertzen.com/dist/html2canvas.min.js"></script>

    <style>
        /* =========================================
           CORE SYSTEM | DECIDE OS v84.5
           ========================================= */
        :root {
            --brand-orange: #ff671f;
            --brand-gold: #ffb700;
            --brand-dark: #050505;
            --glass-surface: rgba(20, 20, 20, 0.75);
            --glass-border: rgba(255, 255, 255, 0.12);
            --text-main: #ffffff;
            --text-muted: #a0a0a0;
            --accent-go: #00e676; 
            --accent-skip: #ff3333;
            --font-tech: 'Courier New', monospace;
            --font-ui: -apple-system, BlinkMacSystemFont, "SF Pro Display", "Segoe UI", Roboto, sans-serif;
            --ease-elastic: cubic-bezier(0.19, 1, 0.22, 1);
        }

        html, body {
            margin: 0; padding: 0; height: 100%; width: 100%;
            background-color: var(--brand-dark);
            color: var(--text-main);
            font-family: var(--font-ui);
            overflow: hidden;
            touch-action: none; user-select: none;
            -webkit-font-smoothing: antialiased;
        }

        /* üåå BACKGROUND */
        .aurora-bg {
            position: fixed; top: -50%; left: -50%; width: 200%; height: 200%;
            background: radial-gradient(circle at 50% 50%, #1a1a2e 0%, #000000 70%);
            z-index: -1;
            animation: drift 25s infinite alternate ease-in-out;
            opacity: 0.8;
            pointer-events: none;
            will-change: transform;
        }
        @keyframes drift { 
            0% { transform: translate3d(0,0,0) scale(1); } 
            100% { transform: translate3d(-20px, -20px, 0) scale(1.05); } 
        }

        #master-container { height: 100vh; width: 100vw; position: relative; overflow: hidden; }

        /* SLIDE SYSTEM */
        .main-slide {
            height: 100vh; width: 100vw; position: absolute; top: 0; left: 0;
            display: flex; flex-direction: column;
            transition: transform 0.5s var(--ease-elastic), opacity 0.4s ease;
            will-change: transform, opacity;
            background: transparent;
        }
        .main-slide.prev { transform: translateY(-100%) scale(0.95); opacity: 0; pointer-events: none; }
        .main-slide.active { transform: translateY(0) scale(1); opacity: 1; z-index: 10; pointer-events: auto; }
        .main-slide.next { transform: translateY(100%) scale(0.95); opacity: 0; z-index: 20; pointer-events: none; }

        /* HEADER */
        .slide-header {
            padding: 0 24px; height: 70px;
            display: flex; align-items: center; justify-content: space-between;
            position: absolute; top: 0; left: 0; right: 0; z-index: 100;
            background: linear-gradient(180deg, rgba(0,0,0,0.8) 0%, rgba(0,0,0,0) 100%);
            pointer-events: none;
        }
        .slide-header > * { pointer-events: auto; }

        .header-title {
            font-family: var(--font-tech); font-size: 0.7rem; color: var(--brand-orange);
            letter-spacing: 2px; font-weight: 700; text-transform: uppercase;
            background: rgba(255, 103, 31, 0.1); padding: 6px 12px; border-radius: 4px;
            border: 1px solid rgba(255, 103, 31, 0.2);
            display: flex; align-items: center; gap: 8px;
        }
        
        .status-dot { width: 6px; height: 6px; background: var(--accent-go); border-radius: 50%; box-shadow: 0 0 5px var(--accent-go); transition: background 0.3s; }
        .status-dot.offline { background: var(--accent-skip); box-shadow: 0 0 5px var(--accent-skip); }

        /* UI ELEMENTS */
        .exit-btn {
            padding: 8px 16px; border: 1px solid rgba(255,255,255,0.3); border-radius: 20px;
            background: rgba(0,0,0,0.6); color: #fff; font-family: var(--font-tech);
            font-size: 0.7rem; font-weight: bold; cursor: pointer; backdrop-filter: blur(10px);
            text-transform: uppercase; transition: all 0.2s;
        }

        .lobby-grid { 
            display: grid; grid-template-columns: 1fr 1fr; gap: 12px; padding: 24px; 
            margin-top: 20px; overflow-y: auto; padding-bottom: 120px; box-sizing: border-box;
            height: 100%; align-content: start; padding-top: 80px;
        }
        .lobby-container {
             display: flex; flex-direction: column; gap: 15px; padding: 24px; height: 100%; 
             overflow-y: auto; justify-content: flex-start; padding-top: 80px; box-sizing: border-box;
        }

        .grid-btn {
            background: rgba(255,255,255,0.03); border: 1px solid var(--glass-border);
            border-radius: 16px; padding: 20px; display: flex; flex-direction: column;
            align-items: center; justify-content: center; gap: 8px;
            aspect-ratio: 1.15; transition: all 0.2s; cursor: pointer;
            backdrop-filter: blur(10px);
        }
        .grid-btn:active { transform: scale(0.96); background: rgba(255,255,255,0.08); }
        .grid-icon { font-size: 1.8rem; margin-bottom: 5px; }
        .grid-label { font-family: var(--font-ui); font-weight: 700; font-size: 0.85rem; letter-spacing: 0.5px; color: #fff; text-align: center; }
        .grid-status { font-family: var(--font-tech); font-size: 0.6rem; color: var(--accent-go); text-transform: uppercase; letter-spacing: 1px; opacity: 0.8; }
        
        .btn-fuel { border-color: var(--brand-gold); background: rgba(255, 183, 0, 0.05); }
        .full-width-btn { grid-column: span 2; aspect-ratio: auto; padding: 18px; flex-direction: row; gap: 15px; }

        .carousel-viewport { position: relative; flex-grow: 1; width: 100%; height: 100%; margin-top: 70px; perspective: 1000px; }

        .sub-slide {
            position: absolute; inset: 20px; bottom: 100px; 
            padding: 30px; display: flex; flex-direction: column; justify-content: center;
            background: var(--glass-surface);
            backdrop-filter: blur(20px); -webkit-backdrop-filter: blur(20px);
            border: 1px solid var(--glass-border);
            border-radius: 24px;
            box-shadow: 0 20px 50px rgba(0,0,0,0.5);
            opacity: 0; pointer-events: none; 
            transform: translateY(20px) scale(0.95);
            transition: all 0.4s cubic-bezier(0.19, 1, 0.22, 1);
        }
        .sub-slide.opt-active, .sub-slide.static { opacity: 1; pointer-events: auto; transform: translateY(0) scale(1); z-index: 30; }

        h1 { font-family: var(--font-ui); font-size: 2rem; font-weight: 700; margin: 0 0 15px 0; letter-spacing: -0.03em; line-height: 1.1; background: linear-gradient(to right, #fff, #ccc); -webkit-background-clip: text; -webkit-text-fill-color: transparent; }
        
        .wiki-summary { 
            font-family: var(--font-ui); font-size: 1.05rem; color: var(--text-muted); line-height: 1.6; 
            font-weight: 400; max-height: 300px; overflow-y: auto; 
            mask-image: linear-gradient(to bottom, black 85%, transparent 100%);
            touch-action: pan-y; 
        }
        
        .role-label { font-family: var(--font-tech); font-size: 0.65rem; color: var(--brand-orange); margin-bottom: 15px; font-weight: 700; letter-spacing: 1px; display: flex; align-items: center; gap: 8px; }
        .role-label::before { content: ''; width: 8px; height: 8px; background: var(--brand-orange); border-radius: 50%; box-shadow: 0 0 10px var(--brand-orange); }

        .cuisine-btn { background: rgba(20,20,20,0.6); border: 1px solid var(--glass-border); color: #888; padding: 20px; font-size: 1rem; font-weight: 600; text-transform: uppercase; border-radius: 12px; transition: all 0.3s; flex-shrink: 0; font-family: var(--font-ui); text-align: center; }
        .cuisine-btn.selected { background: rgba(255, 103, 31, 0.15); color: var(--brand-orange); border-color: var(--brand-orange); }
        .btn { background: rgba(255,255,255,0.05); color: #fff; border: 1px solid rgba(255,255,255,0.1); padding: 18px; border-radius: 12px; font-weight: 600; font-size: 0.9rem; cursor: pointer; width: 100%; transition: all 0.2s; font-family: var(--font-ui); }
        .btn-primary { background: var(--brand-orange); color: #000; border: none; font-weight: 800; }
        .btn-yt { background: #cc0000; border: none; }
        .btn-share { background: #6b21a8; color: #fff; border: none; grid-column: span 2; }
        
        .search-wrapper { position: relative; margin-bottom: 20px; }
        #search-input { width: 100%; padding: 20px; border-radius: 16px; border: 1px solid var(--glass-border); background: rgba(0,0,0,0.3); color: #fff; font-family: var(--font-ui); font-size: 1.1rem; box-sizing: border-box; }

        .modal-backdrop {
            position: fixed; inset: 0; background: rgba(0,0,0,0.8); backdrop-filter: blur(10px);
            z-index: 5000; display: flex; align-items: center; justify-content: center;
            opacity: 0; pointer-events: none; transition: opacity 0.3s;
        }
        .modal-backdrop.open { opacity: 1; pointer-events: auto; }
        .payment-card { background: #111; border: 1px solid var(--brand-gold); width: 90%; max-width: 400px; padding: 30px; border-radius: 24px; text-align: center; position: relative; }
        .pay-option { background: rgba(255,255,255,0.05); padding: 15px; margin: 10px 0; border-radius: 12px; cursor: pointer; border: 1px solid #333; display: flex; align-items: center; justify-content: space-between; font-weight: 600; color: #fff; }
        
        .toast-msg { position: fixed; bottom: 40px; left: 50%; transform: translateX(-50%); background: #222; color: var(--accent-go); padding: 12px 24px; border-radius: 30px; border: 1px solid #333; opacity: 0; z-index: 6000; pointer-events: none; transition: opacity 0.3s; font-family: var(--font-tech); font-size: 0.8rem; font-weight: bold; }
        .toast-msg.visible { opacity: 1; }

        .video-bg { position: absolute; top: 0; left: 0; width: 100%; height: 100%; object-fit: cover; z-index: -1; opacity: 0.4; mix-blend-mode: screen; }
        .winner-container { flex-grow: 1; display: flex; flex-direction: column; justify-content: flex-end; padding: 30px; padding-bottom: 120px; background: linear-gradient(to top, #000 95%, transparent); }
        iframe { width: 100%; height: 100%; border: none; background: #000; }
        .close-iframe { position: fixed; top: 20px; right: 20px; z-index: 200; background: #000; border: 1px solid #333; color: #fff; padding: 10px 20px; border-radius: 20px; font-weight: bold; cursor: pointer; }

        #share-card-canvas {
            position: fixed; top: -200vh; left: 0; width: 360px; padding: 40px 30px;
            background: linear-gradient(145deg, #111, #050505);
            border: 2px solid var(--brand-orange); border-radius: 24px;
            text-align: center; color: #fff; font-family: var(--font-ui);
            display: flex; flex-direction: column; align-items: center; justify-content: center;
            box-sizing: border-box; z-index: 9000;
        }
        
        .topic-grid { display: grid; grid-template-columns: 1fr; gap: 10px; margin-top: 20px; padding-bottom: 20px; }
        .topic-card { background: rgba(255,255,255,0.03); border: 1px solid var(--glass-border); padding: 15px; border-radius: 12px; cursor: pointer; }
        .topic-title { font-weight: bold; color: #fff; font-size: 0.85rem; margin-bottom: 4px; font-family: var(--font-tech); }
        .topic-desc { font-size: 0.75rem; color: #888; display: -webkit-box; -webkit-line-clamp: 2; -webkit-box-orient: vertical; overflow: hidden; }
        
        .deal-tag { color: var(--accent-go); font-size: 0.8rem; font-weight: bold; background: rgba(0, 230, 118, 0.1); padding: 2px 6px; border-radius: 4px; margin-left: 10px; font-family: var(--font-tech); }
        .nav-hint { margin-top: 25px; padding-top: 15px; border-top: 1px solid rgba(255,255,255,0.05); display: flex; justify-content: space-between; font-family: var(--font-tech); font-size: 0.7rem; color: #555; }
        .skip-btn-clickable { cursor: pointer; padding: 8px 16px; background: rgba(255,255,255,0.05); border: 1px solid rgba(255,255,255,0.1); border-radius: 20px; color: #aaa; pointer-events: auto; }
        .final-actions { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-top: 15px; width: 100%; }

    </style>
</head>
<body>

<div class="aurora-bg"></div>
<div id="master-container"></div>
<div id="toast" class="toast-msg"></div>

<div id="share-card-canvas">
    <div style="font-family:var(--font-tech); color:var(--brand-orange); font-size:0.8rem; letter-spacing:2px; margin-bottom:20px;">DECIDE ENGINE</div>
    <div style="font-size:0.7rem; color:#888; text-transform:uppercase;">THE WINNER IS</div>
    <h1 id="share-winner-name" style="font-size:2.5rem; margin:15px 0; line-height:1; color:#fff; word-wrap:break-word;">WINNER</h1>
    <div id="share-winner-price" style="font-size:1.5rem; color:var(--accent-go); font-weight:bold;">‚Çπ0</div>
    <div style="margin-top:30px; font-size:0.7rem; color:#666; border-top:1px solid #333; padding-top:15px; width:100%;">viadecide.com</div>
</div>

<div id="payment-modal" class="modal-backdrop">
    <div class="payment-card">
        <button class="close-modal" style="position:absolute; top:15px; right:15px; background:none; border:none; color:#666; font-size:1.5rem;" onclick="togglePayment(false)">&times;</button>
        <h2 style="color:var(--brand-gold); margin-top:0;">FUEL THE SYSTEM ‚ö°</h2>
        <p style="color:#888; font-size:0.9rem; margin-bottom:20px;">Keep the servers running.</p>
        <div id="upi-container"></div>
        <div class="pay-option" onclick="window.open('https://buymeacoffee.com/dharamdaxini', '_blank')">
            <span>üåç International Cards</span><span>‚Üó</span>
        </div>
    </div>
</div>

<script>
    /* =========================================
       KUTCH AUTOMATION | v84.5 (STUDIO BRIDGE)
       ========================================= */
    
    // --- CONFIG & CONSTANTS ---
    const BACKEND_URL = "https://script.google.com/macros/s/AKfycbxxh1ZwNRwqsSW1Lf62eh2wiwaNKzHWX8Icq472NQVj7-yEvOYuTDuiEGmelW_DG2Zs/exec"; 
    const PHONE_REVIEW_URL = "https://youtu.be/W28-2z9IZbA?si=nJDuPcmTsaUcao9d";
    const AUDIO_REVIEW_URL = "https://youtu.be/ceuEz96MMEY";
    const YOUTUBE_CHANNEL = "https://www.youtube.com/@decide.engine"; 
    const AMZN_TAG = "decideos-21";
    const WINNER_VIDEO = "https://static.videezy.com/system/resources/previews/000/012/628/original/Abstract_Blue_Background.mp4";
    const UPI_ID = "6351537770@yapl";
    const QR_IMAGE = "1000206276.png"; 

    // üéôÔ∏è VOICE DATA
    const VOICE_FEED = [
      { id: "voice_focus_ai", title: "Voice Focus AI ‚Äì Call Clarity Explained", mode: "explain", blocks: [{ text: "Voice Focus AI uses a six-microphone array to isolate human voice." }, { text: "It improves both outgoing clarity and incoming audio." }] },
      { id: "earbuds_buy_wait_2026", title: "Wireless Earbuds ‚Äì Buy vs Wait (Feb 2026)", mode: "decision", blocks: [{ text: "Buy today: Technics AZ100 for work. Wait for Sony WF-1000XM6." }] }
    ];

    // üß† 50 TOPICS KNOWLEDGE BASE
    const CURATED_PATHS = {
        // --- COSMOLOGY ---
        "THE BIG BANG": { title: "The Big Bang", summary: "The prevailing cosmological model explaining the existence of the observable universe from the earliest known periods through its subsequent large-scale evolution.", links: ["Cosmic Inflation", "Nucleosynthesis", "CMB Radiation", "Hubble's Law", "The Singularity"] },
        "BLACK HOLES": { title: "Black Holes", summary: "A region of spacetime where gravity is so strong that nothing‚Äîno particles or even electromagnetic radiation such as light‚Äîcan escape from it.", links: ["Event Horizon", "Singularity", "Hawking Radiation", "Spaghettification", "Supermassive Black Holes"] },
        "DARK MATTER": { title: "Dark Matter", summary: "A hypothetical form of matter thought to account for approximately 85% of the matter in the universe and about a quarter of its total energy density.", links: ["Gravitational Lensing", "Galaxy Rotation Curves", "WIMPs", "Cosmic Web", "Dark Energy"] },
        "FERMI PARADOX": { title: "The Fermi Paradox", summary: "The apparent contradiction between the lack of evidence for extraterrestrial civilizations and various high estimates for their probability.", links: ["Great Filter", "Drake Equation", "Zoo Hypothesis", "Von Neumann Probes", "Rare Earth Hypothesis"] },
        "NEUTRON STARS": { title: "Neutron Stars", summary: "The collapsed core of a massive supergiant star, which had a total mass of between 10 and 25 solar masses.", links: ["Pulsars", "Magnetars", "Supernova", "Degeneracy Pressure", "Kilonova"] },
        "STRING THEORY": { title: "String Theory", summary: "A theoretical framework in which the point-like particles of particle physics are replaced by one-dimensional objects called strings.", links: ["M-Theory", "Extra Dimensions", "Quantum Gravity", "Supersymmetry", "Branes"] },
        "EXOPLANETS": { title: "Exoplanets", summary: "A planet outside the Solar System. The first evidence of an exoplanet was noted in 1917, but was not recognized as such.", links: ["Goldilocks Zone", "Transit Method", "Hot Jupiters", "Super-Earths", "Biosignatures"] },
        "THE MULTIVERSE": { title: "The Multiverse", summary: "A hypothetical group of multiple universes. Together, these universes comprise everything that exists.", links: ["Bubble Universes", "Many-Worlds Theory", "Parallel Dimensions", "Cosmic Inflation", "Fine-Tuning"] },
        "ENTROPY": { title: "Entropy", summary: "The eventual fate of the universe where it has diminished to a state of no thermodynamic free energy and therefore can no longer sustain processes that increase entropy.", links: ["Second Law", "Thermodynamics", "Arrow of Time", "The Big Freeze", "Maxwell's Demon"] },
        "DYSON SPHERES": { title: "Dyson Spheres", summary: "A hypothetical megastructure that completely encompasses a star and captures a large percentage of its solar power output.", links: ["Kardashev Scale", "Megastructures", "Technosignatures", "Matrioshka Brain", "Stellar Engines"] },
        "GENERAL RELATIVITY": { title: "General Relativity", summary: "The geometric theory of gravitation published by Albert Einstein in 1915 and the current description of gravitation in modern physics.", links: ["Spacetime Curvature", "Time Dilation", "Gravitational Waves", "Equivalence Principle", "Wormholes"] },
        "THE SUN": { title: "The Sun", summary: "The star around which the earth orbits. It is the dominant body of the solar system.", links: ["Nuclear Fusion", "Solar Flares", "Corona", "Sunspots", "Solar Wind"] },
        "ASTROBIOLOGY": { title: "Astrobiology", summary: "The study of the origin, evolution, distribution, and future of life in the universe.", links: ["Panspermia", "Extremophiles", "SETI", "Habitability", "Europa Clipper"] },
        "THE MOON": { title: "The Moon", summary: "Earth's only natural satellite.", links: ["Tidal Locking", "Lunar Mare", "Apollo Program", "Impact Theory", "Lunar Water"] },
        
        // --- HISTORY ---
        "FALL OF ROME": { title: "Fall of Rome", summary: "The process of decline in the Western Roman Empire in which the Empire failed to enforce its rule.", links: ["Visigoths", "Constantine", "Economic Inflation", "Military Decline", "Migration Period"] },
        "SILK ROAD": { title: "The Silk Road", summary: "A network of trade routes connecting the East and West, central to economic interactions.", links: ["Marco Polo", "Spice Trade", "Cultural Exchange", "Han Dynasty", "Byzantine Empire"] },
        "INDUSTRIAL REVOLUTION": { title: "Industrial Revolution", summary: "The transition to new manufacturing processes in Great Britain, continental Europe, and the United States.", links: ["Steam Engine", "Urbanization", "Textile Industry", "Capitalism", "Labor Unions"] },
        "FRENCH REVOLUTION": { title: "French Revolution", summary: "A period of radical political and societal change in France.", links: ["Napoleon", "Guillotine", "Reign of Terror", "Louis XVI", "Enlightenment"] },
        "COLD WAR": { title: "The Cold War", summary: "A period of geopolitical tension between the Soviet Union and the United States.", links: ["Nuclear Arms Race", "Space Race", "Berlin Wall", "Cuban Missile Crisis", "Espionage"] },
        "THE RENAISSANCE": { title: "The Renaissance", summary: "A fervent period of European cultural, artistic, political and economic rebirth.", links: ["Da Vinci", "Humanism", "Medici Family", "Printing Press", "Galileo"] },
        "VIKINGS": { title: "Vikings", summary: "Norse seafarers who raided, traded, and settled in wide areas of Europe.", links: ["Longships", "Norse Mythology", "Ragnar Lothbrok", "Valhalla", "Lindisfarne"] },
        "MONGOL EMPIRE": { title: "Mongol Empire", summary: "The largest contiguous land empire in history.", links: ["Genghis Khan", "Silk Road Safety", "Horse Archery", "Pax Mongolica", "Kublai Khan"] },
        "BLACK DEATH": { title: "The Black Death", summary: "A bubonic plague pandemic occurring in Western Eurasia and North Africa.", links: ["Yersinia Pestis", "Plague Doctor", "Feudalism Decline", "Quarantine", "Danse Macabre"] },
        "ANCIENT EGYPT": { title: "Ancient Egypt", summary: "A civilization of ancient North Africa.", links: ["Pyramids", "Pharaohs", "Hieroglyphs", "Mummification", "Cleopatra"] },
        "SAMURAI": { title: "Samurai", summary: "The hereditary military nobility and officer caste of medieval Japan.", links: ["Bushido", "Katana", "Shogunate", "Ronin", "Seppuku"] },
        "ALEXANDER THE GREAT": { title: "Alexander the Great", summary: "A king of the ancient Greek kingdom of Macedon.", links: ["Hellenistic Period", "Macedonian Phalanx", "Persian Empire", "Aristotle", "Library of Alexandria"] },
        "MAYA CIVILIZATION": { title: "Maya Civilization", summary: "A Mesoamerican civilization noted for its logosyllabic script.", links: ["Chichen Itza", "Maya Calendar", "Human Sacrifice", "Step Pyramids", "Cenotes"] },
        "WORLD WAR I": { title: "World War I", summary: "A global war originating in Europe that lasted from 1914 to 1918.", links: ["Trench Warfare", "Treaty of Versailles", "Archduke Franz Ferdinand", "Chemical Weapons", "No Man's Land"] },
        "THE CRUSADES": { title: "The Crusades", summary: "A series of religious wars initiated by the Latin Church.", links: ["Knights Templar", "Saladin", "Holy Land", "Siege of Jerusalem", "Richard the Lionheart"] },

        // --- MODERN / SYSTEMS ---
        "SYSTEMS THINKING": { 
            title: "Systems Thinking", 
            summary: "A holistic approach to analysis that focuses on the way that a system's constituent parts interrelate and how systems work over time.", 
            links: ["FEEDBACK LOOPS", "CYBERNETICS", "AGENT-BASED MODEL", "SOCIAL SIMULATION", "Emergence"] 
        },
        "FEEDBACK LOOPS": { title: "Feedback Loops", summary: "A process in which the outputs of a system are circled back and used as inputs (Node 01).", links: ["Positive Feedback", "Negative Feedback", "Homeostasis", "Runaway Effect", "Control Theory"] },
        "CYBERNETICS": { title: "Cybernetics", summary: "The transdisciplinary study of circular causal processes such as feedback and recursion (Node 02).", links: ["Norbert Wiener", "Steering", "Macy Conferences", "Information Theory", "Second-Order Cybernetics"] },
        "AGENT-BASED MODEL": { title: "Agent-Based Model (ABM)", summary: "Computational model for simulating the actions and interactions of autonomous agents (Node 03).", links: ["Game Theory", "Complex Systems", "Cellular Automata", "NetLogo", "Emergent Behavior"] },
        "SOCIAL SIMULATION": { title: "Social Simulation", summary: "Scientific discipline concerned with simulation of social phenomena using multi-agent models (Node 04).", links: ["Artificial Society", "Computational Sociology", "Opinion Dynamics", "Crowd Simulation", "Economic Modeling"] },
        
        "GENERATIVE AI": { title: "Generative AI", summary: "AI capable of generating text, images, or other media.", links: ["LLMs", "Diffusion Models", "Transformer Architecture", "Neural Networks", "AI Ethics"] },
        "BLOCKCHAIN": { title: "Blockchain", summary: "A distributed database or ledger.", links: ["Decentralization", "Smart Contracts", "Cryptography", "Bitcoin", "Web3"] },
        "GAME THEORY": { title: "Game Theory", summary: "Models of strategic interaction among rational decision-makers.", links: ["Nash Equilibrium", "Prisoner's Dilemma", "Zero-Sum Game", "Coordination", "Behavioral Economics"] },
        "CRISPR": { title: "CRISPR", summary: "A family of DNA sequences found in the genomes of prokaryotic organisms.", links: ["Gene Editing", "Cas9", "Bioethics", "Designer Babies", "Genetic Engineering"] },
        "QUANTUM COMPUTING": { title: "Quantum Computing", summary: "Computation harnessing quantum states.", links: ["Qubits", "Superposition", "Quantum Supremacy", "Cryptography Break", "Shor's Algorithm"] },
        "NEURALINK": { title: "Brain-Computer Interface", summary: "Communication pathway between a brain and an external device.", links: ["Neural Lace", "Cyborgs", "Neuroscience", "Prosthetics", "AI Symbiosis"] },
        "THE SINGULARITY": { title: "Technological Singularity", summary: "A hypothetical point in time at which technological growth becomes uncontrollable.", links: ["Artificial Superintelligence", "Moore's Law", "Transhumanism", "Ray Kurzweil", "Intelligence Explosion"] },
        "CIRCULAR ECONOMY": { title: "Circular Economy", summary: "A model of production and consumption involving sharing and reusing.", links: ["Sustainability", "Zero Waste", "Supply Chain", "Green Tech", "Planned Obsolescence"] },
        "MINIMALISM": { title: "Digital Minimalism", summary: "Focusing online time on a small number of carefully selected activities.", links: ["Deep Work", "Attention Economy", "Dopamine Detox", "Essentialism", "Slow Living"] },
        "METAVERSE": { title: "The Metaverse", summary: "A hypothetical iteration of the Internet as a universal virtual world.", links: ["Virtual Reality", "Augmented Reality", "Digital Avatars", "Spatial Computing", "NFTs"] },
        "STOICISM": { title: "Stoicism", summary: "A school of Hellenistic philosophy teaching acceptance of the moment.", links: ["Marcus Aurelius", "Seneca", "Amor Fati", "Dichotomy of Control", "Virtue Ethics"] },
        "FIRST PRINCIPLES": { title: "First Principles", summary: "A method of thinking that breaks problems down to their fundamental truths.", links: ["Reasoning", "Elon Musk", "Physics", "Innovation", "Deconstruction"] },
        "NETWORK EFFECTS": { title: "Network Effects", summary: "Value derived from the number of users of compatible products.", links: ["Metcalfe's Law", "Social Media", "Virality", "Critical Mass", "Platform Economy"] },
        "AGILE METHODOLOGY": { title: "Agile Methodology", summary: "Software development where solutions evolve through collaborative effort.", links: ["Scrum", "Kanban", "Iterative Design", "Sprints", "MVP"] },
        "FUSION ENERGY": { title: "Fusion Energy", summary: "Generating electricity by using heat from nuclear fusion reactions.", links: ["Tokamak", "Clean Energy", "Plasma Physics", "ITER", "Unlimited Power"] },
        "VERTICAL FARMING": { title: "Vertical Farming", summary: "Growing crops in vertically stacked layers.", links: ["Hydroponics", "Aeroponics", "Food Security", "Urban Agriculture", "Sustainable Farming"] },
        "BIOHACKING": { title: "Biohacking", summary: "Do-it-yourself biology.", links: ["Nootropics", "Quantified Self", "Intermittent Fasting", "Genomics", "Longevity"] },
        "SPACE TOURISM": { title: "Space Tourism", summary: "Human space travel for recreational purposes.", links: ["SpaceX", "Blue Origin", "Virgin Galactic", "Commercial Spaceflight", "Zero Gravity"] },
        "SMART CITIES": { title: "Smart Cities", summary: "Urban area using sensors to collect data.", links: ["IoT", "Urban Planning", "Autonomous Vehicles", "5G Networks", "Big Data"] }
    };

    const PHONE_DB = {
      "Poco F7": { attr: { cam: 6, gam: 10, bat: 9, ui: 4, dis: 9, srv: 6, thm: 10, dur: 7 }, tags: ["heavy", "performance"], price: 29999, mrp: 34999 },
      "iQOO Neo 10R": { attr: { cam: 7, gam: 10, bat: 8, ui: 5, dis: 9, srv: 7, thm: 9, dur: 7 }, tags: ["performance", "value"], price: 30999, mrp: 34999 },
      "Nothing 3a Pro": { attr: { cam: 8, gam: 7, bat: 8, ui: 10, dis: 9, srv: 9, thm: 8, dur: 8 }, tags: ["clean_ui", "no_charger"], price: 27999, mrp: 29999 },
      "Samsung S24 FE": { attr: { cam: 10, gam: 7, bat: 5, ui: 10, dis: 10, srv: 9, thm: 7, dur: 9 }, tags: ["premium", "clean_ui", "camera_king", "7yr_updates"], price: 29999, mrp: 34999 },
      "Vivo V60e": { attr: { cam: 10, gam: 5, bat: 7, ui: 7, dis: 8, srv: 7, thm: 7, dur: 7 }, tags: ["camera_king", "aura_light"], price: 28999, mrp: 32999 },
      "Realme GT 7T": { attr: { cam: 6, gam: 9, bat: 10, ui: 5, dis: 8, srv: 7, thm: 8, dur: 7 }, tags: ["battery_king", "120w"], price: 31999, mrp: 35999 }
    };

    const AUDIO_DB = {
      "Technics AZ100": { attr: { anc: 9.5, snd: 10.0, mic: 9, lat: 8 }, price: 22990 },
      "Sony WF-1000XM6": { attr: { anc: 10.0, snd: 9.5, mic: 8, lat: 6 }, price: 24990 },
      "SteelSeries Arctis": { attr: { anc: 7.0, snd: 8.0, mic: 8, lat: 10 }, price: 17999 },
      "OnePlus Nord Buds 3": { attr: { anc: 8.5, snd: 8.0, mic: 8, lat: 7 }, price: 3299 }
    };

    const DEAL_BREAKERS = { "CLEAN UI": "bloatware", "LIGHTWEIGHT": "heavy", "FAST CHARGE": "slow_charge" };

    const MODULES = {
        smartphones: { 
            label: "SMARTPHONES", database: PHONE_DB, review: PHONE_REVIEW_URL,
            init: () => renderEcosystemGate(), 
            categories: [
                { label: "CAMERA-FIRST", type: "cam", items: [{"name": "Vivo V60e"}, {"name": "Xiaomi 14 Civi"}] }, 
                { label: "PRO GAMER", type: "gam", items: [{"name": "Poco F7"}, {"name": "iQOO Neo 10R"}] }, 
                { label: "CLEAN UI", type: "ui", items: [{"name": "Nothing 3a Pro"}, {"name": "Samsung A55"}] },
                { label: "BATTERY KING", type: "bat", items: [{"name": "Realme GT 7T"}] }
            ] 
        },
        earbuds: { 
            label: "EARBUDS", database: AUDIO_DB, review: AUDIO_REVIEW_URL,
            init: () => { ENGINE_STATE.active_filters=[]; renderSubLobby('earbuds'); }, 
            categories: [
                { label: "AUDIOPHILE", type: "snd", items: [{"name": "Technics AZ100"}] }, 
                { label: "SILENCE (ANC)", type: "anc", items: [{"name": "Sony WF-1000XM6"}] },
                { label: "LOW LATENCY", type: "lat", items: [{"name": "SteelSeries Arctis"}] }
            ] 
        },
        trivia: { label: "TRIVIA", init: () => renderTriviaGate() },
        research: { label: "RESEARCH", init: () => renderSearchSlide() },
        food: { label: "DINING", init: () => renderExternalModule("https://via-decide.github.io/food.decider/") },
        custom: { label: "CUSTOM REQ", init: () => renderExternalModule('https://via-decide.github.io/food.decide-custom/') },
        review: { label: "ENGINE REVIEW ‚Üó", init: () => window.open(YOUTUBE_CHANNEL, '_blank') }
    };

    // --- ENGINES ---
    const TRIVIA_ENGINE = {
        api: "https://opentdb.com/api.php?amount=5&type=multiple",
        async fetch(category = "") {
            try {
                const url = this.api + (category ? `&category=${category}` : "");
                const res = await fetch(url);
                const data = await res.json();
                return data.results || [];
            } catch(e) { return []; }
        }
    };

    const WIKI_ENGINE = {
        async search(query) {
            const upper = query.toUpperCase();
            if(CURATED_PATHS[upper]) return upper; 
            try {
                const url = `https://en.wikipedia.org/w/api.php?origin=*&action=opensearch&search=${encodeURIComponent(query)}&limit=1&format=json`;
                const res = await fetch(url);
                const data = await res.json();
                return (data[1] && data[1].length > 0) ? data[1][0] : null;
            } catch(e) { return null; }
        },
        async getContext(title) {
            if(CURATED_PATHS[title.toUpperCase()]) {
                const c = CURATED_PATHS[title.toUpperCase()];
                return { title: c.title, summary: c.summary, links: c.links.map(l => ({name: l})) };
            }
            try {
                const url = `https://en.wikipedia.org/w/api.php?origin=*&action=query&prop=extracts|links&titles=${encodeURIComponent(title)}&redirects=1&exintro=1&explaintext=1&pllimit=20&format=json`;
                const res = await fetch(url);
                const data = await res.json();
                const pageId = Object.keys(data.query.pages)[0];
                if(pageId === "-1") return { title: "Not Found", summary: "", links: [] };
                const page = data.query.pages[pageId];
                return { title: page.title, summary: page.extract || "No summary.", links: page.links ? page.links.map(l => ({name: l.title})) : [] };
            } catch(e) { return { title: "Error", summary: "Connection Failed.", links: [] }; }
        }
    };

    // --- STATE ---
    let ENGINE_STATE = { currentDomain: null, items_detected: {}, active_filters: [], session_weights: {}, researchPath: [], triviaMode: false, sessionID: "" };
    let slideElements = [];
    let currentIdx = 0;

    // --- BOOT ---
    function boot() { 
        ENGINE_STATE.sessionID = "SID-" + Math.random().toString(36).substr(2, 4).toUpperCase();
        updateStatus(navigator.onLine);
        window.addEventListener('online', () => updateStatus(true));
        window.addEventListener('offline', () => updateStatus(false));
        renderLobby();
        initSwipeSystem(); 
    }

    function updateStatus(isOnline) {
        const dot = document.querySelector('.status-dot');
        if(dot) isOnline ? dot.classList.remove('offline') : dot.classList.add('offline');
    }

    // --- BACKEND LOGGER ---
    function logToSheet(data) {
        const formData = new URLSearchParams();
        formData.append("type", "JSON_EXPORT");
        formData.append("payload", JSON.stringify(data));
        formData.append("session", ENGINE_STATE.sessionID);
        
        fetch(BACKEND_URL, {
            method: "POST",
            mode: "no-cors",
            headers: { "Content-Type": "application/x-www-form-urlencoded" },
            body: formData.toString()
        }).catch(e => console.log("Sync skipped"));
    }

    // --- RENDERERS ---
    function renderLobby() {
        const container = document.getElementById('master-container');
        container.innerHTML = "";
        const section = document.createElement('section');
        section.className = "main-slide active";
        
        section.innerHTML = `
            <div class="slide-header">
                <span class="header-title">DECIDE OS v84.5 <div class="status-dot"></div></span>
            </div>
            <div class="lobby-grid">
                <div class="grid-btn" onclick="loadDomain('smartphones')">
                    <div class="grid-icon">üì±</div>
                    <div class="grid-label">PHONES</div>
                    <div class="grid-status">DB: ONLINE</div>
                </div>
                <div class="grid-btn" onclick="loadDomain('earbuds')">
                    <div class="grid-icon">üéß</div>
                    <div class="grid-label">AUDIO</div>
                    <div class="grid-status">LOW LATENCY</div>
                </div>
                <div class="grid-btn" onclick="loadDomain('research')">
                    <div class="grid-icon">üß†</div>
                    <div class="grid-label">RESEARCH</div>
                    <div class="grid-status">STUDIO LINK</div>
                </div>
                <div class="grid-btn" onclick="loadDomain('trivia')">
                    <div class="grid-icon">üß©</div>
                    <div class="grid-label">TRIVIA</div>
                    <div class="grid-status">LOGIC READY</div>
                </div>
                <div class="grid-btn" onclick="loadDomain('food')">
                    <div class="grid-icon">üçî</div>
                    <div class="grid-label">DINING</div>
                    <div class="grid-status">EXT: LINK</div>
                </div>
                <div class="grid-btn" onclick="loadDomain('custom')">
                    <div class="grid-icon">üõ†Ô∏è</div>
                    <div class="grid-label">CUSTOM REQ</div>
                    <div class="grid-status">DEMO: LINK</div>
                </div>
                <div class="grid-btn" onclick="openVoiceLobby()">
                    <div class="grid-icon">üéôÔ∏è</div>
                    <div class="grid-label">VOICE FEED</div>
                    <div class="grid-status">AI READY</div>
                </div>
                <div class="grid-btn btn-fuel" onclick="togglePayment(true)">
                    <div class="grid-icon">‚ö°</div>
                    <div class="grid-label">SYSTEM FUEL</div>
                    <div class="grid-status">SUPPORT DEV</div>
                </div>
                <div class="grid-btn full-width-btn" onclick="loadDomain('review')">
                    <div class="grid-icon">‚ñ∂</div>
                    <div class="grid-label">ENGINE REVIEW ‚Üó</div>
                </div>
                <div style="grid-column:span 2; text-align:center; opacity:0.3; font-size:0.6rem; font-family:var(--font-tech); margin-top:20px;">
                    SESSION: ${ENGINE_STATE.sessionID}
                </div>
            </div>
        `;
        container.appendChild(section);
        slideElements = [section];
        currentIdx = 0;
        
        let exitBtn = document.getElementById('global-exit');
        if(exitBtn) exitBtn.remove();
    }

    function loadDomain(key) {
        stopAudio();
        ENGINE_STATE.currentDomain = key;
        ENGINE_STATE.triviaMode = false;
        
        const container = document.getElementById('master-container');
        while(container.children.length > 1) container.removeChild(container.lastChild);
        slideElements = [slideElements[0]];
        
        addGlobalExit();
        MODULES[key].init();
    }

    function addGlobalExit() {
        if(document.getElementById('global-exit')) return;
        let exitBtn = document.createElement('button');
        exitBtn.id = 'global-exit';
        exitBtn.className = 'exit-btn';
        exitBtn.innerText = 'EXIT';
        exitBtn.onclick = () => { stopAudio(); renderLobby(); };
        exitBtn.style.position = 'fixed'; exitBtn.style.top = '20px'; exitBtn.style.right = '20px'; exitBtn.style.zIndex = '5000';
        document.body.appendChild(exitBtn);
    }

    // --- VOICE MODULE ---
    function openVoiceLobby() {
        stopAudio();
        addGlobalExit();
        const section = document.createElement('section');
        section.className = "main-slide next";
        section.innerHTML = `
            <div class="slide-header"><span class="header-title">VOICE MODULE</span></div>
            <div class="lobby-container">
              <h1>VOICE FEEDS</h1>
              <div class="topic-grid">
              ${VOICE_FEED.map(v => `
                <div class="topic-card" onclick="playVoiceFeed('${v.id}')">
                  <div class="topic-title">${v.title}</div>
                  <div class="topic-desc">MODE: ${v.mode.toUpperCase()}</div>
                </div>
              `).join("")}
              </div>
            </div>`;
        document.getElementById('master-container').appendChild(section);
        slideElements.push(section);
        goToSlide(1);
    }

    function playVoiceFeed(id) {
        stopAudio();
        const feed = VOICE_FEED.find(v => v.id === id);
        if (!feed) return;
        let text = feed.blocks.map(b => b.text).join(". ");
        const utterance = new SpeechSynthesisUtterance(text);
        utterance.rate = 0.95;
        window.speechSynthesis.speak(utterance);
        showToast("VOICE PLAYING");
    }

    function stopAudio() { window.speechSynthesis.cancel(); }

    // --- PAYMENT ---
    function togglePayment(show) {
        const modal = document.getElementById('payment-modal');
        const container = document.getElementById('upi-container');
        
        if(show) {
            modal.classList.add('open');
            const isMobile = /iPhone|iPad|iPod|Android/i.test(navigator.userAgent);
            
            if(isMobile) {
                const deepLink = "https://image2url.com/r2/default/images/1770560615015-576f561b-6ef1-4be2-b483-9ceb59f23ce8.jpg";
                container.innerHTML = `
                    <div class="pay-option" onclick="window.location.href='${deepLink}'" style="border-color:var(--accent-go);">
                        <span>üáÆüá≥ Tap to Pay (UPI)</span><span>üöÄ</span>
                    </div>
                `;
            } else {
                container.innerHTML = `
                    <div style="background:#fff; padding:10px; border-radius:12px; margin-bottom:15px; display:inline-block">
                        <img src="${QR_IMAGE}" style="width:180px; display:block;" alt="Scan QR">
                    </div>
                    <div style="font-size:0.7rem; color:#666;">${UPI_ID}</div>
                `;
            }
        } else {
            modal.classList.remove('open');
        }
    }

    // --- RESEARCH (UPDATED: JSON BRIDGE) ---
    async function renderSearchSlide() {
        const section = document.createElement('section'); section.className = "main-slide next";
        let topicsHTML = `<div class="topic-grid">`;
        for(let key in CURATED_PATHS) {
            const t = CURATED_PATHS[key];
            if(t.summary) {
                topicsHTML += `<div class="topic-card" onclick="triggerCurated('${key}')"><div class="topic-title">${t.title}</div><div class="topic-desc">${t.summary}</div></div>`;
            }
        }
        topicsHTML += `</div>`;
        section.innerHTML = `<div class="slide-header"><span class="header-title">RESEARCH</span></div><div class="lobby-container"><h1>TOPIC?</h1><div class="search-wrapper"><input type="text" id="search-input" placeholder="e.g. Systems, AI..."></div><button class="btn btn-primary" onclick="executeSearch()">SEARCH &rarr;</button>${topicsHTML}</div>`;
        document.getElementById('master-container').appendChild(section); slideElements.push(section); goToSlide(1);
    }

    function triggerCurated(key) { document.getElementById('search-input').value = key; executeSearch(); }

    async function executeSearch() {
        const q = document.getElementById('search-input').value;
        if(!q) return showToast("ENTER TOPIC");
        showToast("FORGING NODE...");
        const title = await WIKI_ENGINE.search(q);
        if(!title) return showToast("NOT FOUND");
        const context = await WIKI_ENGINE.getContext(title);
        ENGINE_STATE.researchPath = [{ title: context.title, summary: context.summary }];
        buildResearchDeck(context);
    }

    function buildResearchDeck(context) {
        let links = context.links || [];
        links = links.slice(0, 5);
        const section = document.createElement('section'); section.className = "main-slide next";
        
        // ADDED: COPY JSON BUTTON
        section.innerHTML = `
            <div class="slide-header">
                <span class="header-title">DEPTH: ${ENGINE_STATE.researchPath.length}</span>
                <div style="display:flex; gap:10px;">
                    <button class="skip-btn-clickable" onclick="copyJSON()">COPY JSON üìã</button>
                    <button class="skip-btn-clickable" onclick="saveJSON()">PDF üíæ</button>
                </div>
            </div>
            <div class="carousel-viewport">
                <div class="sub-slide static">
                    <div class="role-label">KNOWLEDGE NODE</div>
                    <h1>${context.title}</h1>
                    <div class="wiki-summary">${context.summary}</div>
                    <div class="nav-hint"><span>SWIPE DOWN: BACK</span><span style="color:var(--accent-go)">UP: DIG DEEPER</span></div>
                </div>
                ${links.map((link, i) => `
                    <div class="sub-slide opt-hidden" data-val="${link.name}">
                        <div class="role-label">RELATED PATH ${i+1}/5</div>
                        <h1>${link.name}</h1>
                        <div class="nav-hint"><span class="skip-btn-clickable" onclick="manualSkip(this)">SKIP</span><span style="color:var(--accent-go)">SELECT &uarr;</span></div>
                    </div>`).join('')}
            </div>`;
        document.getElementById('master-container').appendChild(section); slideElements.push(section); goToSlide(slideElements.length - 1);
    }

    async function diveDeeper(t) {
        showToast("DIVING...");
        const ctx = await WIKI_ENGINE.getContext(t);
        ENGINE_STATE.researchPath.push({ title: ctx.title, summary: ctx.summary });
        buildResearchDeck(ctx);
    }

    // --- JSON BRIDGE ---
    function copyJSON() {
        const payload = ENGINE_STATE.researchPath.map((item, i) => ({
            id: `NODE_${ENGINE_STATE.sessionID}_${i}`,
            title: item.title.toUpperCase(),
            body: item.summary,
            source: "DECIDE ENGINE RESEARCH"
        }));
        
        navigator.clipboard.writeText(JSON.stringify(payload, null, 2));
        showToast("JSON COPIED! PASTE IN STUDIO");
        logToSheet(payload); // Also log to backend
    }

    function saveJSON() {
        const { jsPDF } = window.jspdf; 
        const doc = new jsPDF();
        let y = 20;
        doc.setFont("courier", "bold"); doc.setFontSize(18); 
        doc.text("DECIDE.ENGINE // RESEARCH LOG", 20, y); y += 8;
        
        doc.setFontSize(10); doc.setFont("courier", "normal");
        doc.text(`SESSION: ${ENGINE_STATE.sessionID} | DATE: ${new Date().toISOString().split('T')[0]}`, 20, y); y+= 15;

        ENGINE_STATE.researchPath.forEach((item, i) => {
            if (y > 270) { doc.addPage(); y = 20; }
            doc.setFont("courier", "bold"); doc.text(`[NODE ${String(i+1).padStart(2, '0')}] ${item.title.toUpperCase()}`, 20, y); y += 8;
            doc.setFont("courier", "normal");
            const lines = doc.splitTextToSize(item.summary, 170); doc.text(lines, 20, y);
            y += (lines.length * 6) + 10;
        });
        doc.save(`Research_Path_${ENGINE_STATE.sessionID}.pdf`); showToast("PDF DOWNLOADING...");
    }

    // --- HARDWARE MODULES (PHONES/AUDIO) ---
    function renderEcosystemGate() {
        const section = document.createElement('section'); section.className = "main-slide next";
        section.innerHTML = `
            <div class="slide-header"><span class="header-title">PHILOSOPHY</span></div>
            <div class="lobby-container">
                <h1 style="text-align:center">WHAT MATTERS?</h1>
                <div style="display:grid; gap:20px; margin-top:20px;">
                    <button class="cuisine-btn" onclick="selectEcosystem('specs')">üöÄ PURE SPECS</button>
                    <button class="cuisine-btn" onclick="selectEcosystem('peace')">üõ°Ô∏è PEACE OF MIND</button>
                </div>
            </div>`;
        document.getElementById('master-container').appendChild(section); slideElements.push(section); goToSlide(1);
    }
    
    function selectEcosystem(type) { ENGINE_STATE.ecosystem = type; ENGINE_STATE.active_filters = []; renderSubLobby('smartphones'); }

    function renderSubLobby(domain) {
        const section = document.createElement('section'); section.className = "main-slide next"; 
        const module = MODULES[domain];
        let html = `<div class="slide-header"><span class="header-title">FILTER</span></div><div class="lobby-container"><h1 style="text-align:center">PRIORITIES</h1><div style="display:grid; gap:10px; margin-top:20px;">`;
        module.categories.forEach((cat, idx) => { html += `<button class="cuisine-btn" id="filter-btn-${idx}" onclick="toggleFilter('${cat.label}', ${idx})">${cat.label}</button>`; });
        html += `</div><button class="btn btn-primary" style="margin-top:30px" onclick="startHunt()">HUNT &rarr;</button></div>`;
        section.innerHTML = html; document.getElementById('master-container').appendChild(section); slideElements.push(section); goToSlide(slideElements.length - 1);
    }

    function toggleFilter(label, idx) {
        const btn = document.getElementById(`filter-btn-${idx}`);
        if(ENGINE_STATE.active_filters.includes(label)) { ENGINE_STATE.active_filters = ENGINE_STATE.active_filters.filter(x => x !== label); btn.classList.remove('selected'); } 
        else { ENGINE_STATE.active_filters.push(label); btn.classList.add('selected'); }
    }

    function startHunt() {
        if(ENGINE_STATE.active_filters.length === 0) return showToast("SELECT AT LEAST ONE");
        ENGINE_STATE.session_weights = { cam:0.1, gam:0.1, bat:0.1, ui:0.1, dis:0.1, srv:0.1, thm:0.1, dur:0.1, anc:0.1, snd:0.1, mic:0.1, lat:0.1, fit:0.1, bld:0.1, app:0.1 };
        buildDeck();
    }

    function buildDeck() {
        const container = document.getElementById('master-container');
        const currentMod = MODULES[ENGINE_STATE.currentDomain];
        const targetCats = currentMod.categories.filter(c => ENGINE_STATE.active_filters.includes(c.label));
        targetCats.forEach(cat => {
            const el = document.createElement('section'); el.className = `main-slide next`;
            let html = `<div class="slide-header"><span class="header-title">${cat.label}</span></div><div class="carousel-viewport">`;
            const items = cat.items.length > 0 ? cat.items : [{name: cat.label + " Optimized"}];
            items.forEach((item, i) => {
                html += `<div class="sub-slide ${i===0?'opt-active':'opt-hidden'}" data-val="${item.name}"><div class="role-label">PROPOSAL</div><h1>${item.name}</h1><div class="nav-hint"><span class="skip-btn-clickable" onclick="manualSkip(this)">SKIP</span><span style="color:var(--accent-go)">SELECT &uarr;</span></div></div>`;
            });
            html += `</div>`; el.innerHTML = html; container.appendChild(el); slideElements.push(el);
        });
        const final = document.createElement('section'); final.className = "main-slide next";
        
        final.innerHTML = `
            <video class="video-bg" autoplay loop muted playsinline><source src="${WINNER_VIDEO}" type="video/mp4"></video>
            <div class="winner-container">
                <div id="final-list"></div>
                <div class="final-actions">
                    <button class="btn btn-primary" onclick="redirect()">CHECK PRICE ‚Üó</button>
                    <button class="btn btn-yt" onclick="openReview()">‚ñ∂ WATCH REVIEW</button>
                    <button class="btn btn-share" onclick="generateShareCard()">üì∑ SHARE CARD</button>
                    <button class="btn" style="background:#222; color:#fff;" onclick="window.open('${YOUTUBE_CHANNEL}', '_blank')">üì∫ MORE VIDEOS</button>
                </div>
            </div>`;
        container.appendChild(final); slideElements.push(final); goToSlide(currentIdx + 1);
    }

    function calculateVerdict() {
        const activeModule = MODULES[ENGINE_STATE.currentDomain];
        if(!activeModule.database) return {name: "Ready", price: "---"};
        let DB = activeModule.database; let scores = []; const bannedTags = [];
        ENGINE_STATE.active_filters.forEach(f => { if(DEAL_BREAKERS[f.toUpperCase()]) bannedTags.push(DEAL_BREAKERS[f.toUpperCase()]); });
        for (let name in DB) {
            let item = DB[name]; if(item.tags && item.tags.some(t => bannedTags.includes(t))) continue;
            let score = 0;
            if(ENGINE_STATE.ecosystem === 'specs' && (item.tags?.includes('performance') || item.tags?.includes('value'))) score += 3;
            if(ENGINE_STATE.ecosystem === 'peace' && (item.tags?.includes('trust'))) score += 3;
            for(let attr in item.attr) { let w = ENGINE_STATE.session_weights[attr] || 0.1; score += item.attr[attr] * w; }
            if(ENGINE_STATE.items_detected[name]) score += 10;
            scores.push({name, score, price: item.price, mrp: item.mrp});
        }
        scores.sort((a, b) => b.score - a.score); return scores[0] || {name: "No Match", price: 0};
    }

    async function generateShareCard() {
        const w = calculateVerdict();
        document.getElementById('share-winner-name').innerText = w.name;
        document.getElementById('share-winner-price').innerText = "‚Çπ" + w.price;
        const card = document.getElementById('share-card-canvas');
        showToast("GENERATING CARD...");
        
        try {
            card.style.top = "0"; 
            const canvas = await html2canvas(card, { backgroundColor: null, scale: 2 });
            card.style.top = "-200vh";
            canvas.toBlob(async (blob) => {
                const file = new File([blob], "Decide_Winner.png", { type: "image/png" });
                if (navigator.share && navigator.canShare({ files: [file] })) {
                    await navigator.share({ title: 'My Winner', text: `Decide Engine picked ${w.name}`, files: [file] });
                } else {
                    const link = document.createElement('a'); link.download = 'Decide_Winner.png';
                    link.href = canvas.toDataURL(); link.click(); showToast("DOWNLOADED");
                }
            });
        } catch(e) { card.style.top = "-200vh"; showToast("ERROR"); }
    }

    function updateFinal() { 
        const list = document.getElementById('final-list'); const winner = calculateVerdict(); 
        let priceHtml = `Est. Price: ‚Çπ${winner.price}`;
        if(winner.mrp && winner.mrp > winner.price) {
            const off = Math.round(((winner.mrp - winner.price) / winner.mrp) * 100);
            priceHtml = `‚Çπ${winner.price} <span class="deal-tag">(${off}% OFF)</span>`;
        }
        list.innerHTML = `<div style="text-align:left;"><span style="color:var(--accent-go); font-size:0.8rem; font-weight:bold; letter-spacing:2px;">THE CHAMPION</span><div style="font-size:2.8rem; font-weight:900; margin:5px 0; color:#fff; line-height:1.1;">${winner.name}</div><p style="color:#eee; font-size:1.1rem; margin-top:5px;">${priceHtml}</p></div>`; 
        ENGINE_STATE.items_detected = {}; ENGINE_STATE.items_detected[winner.name] = true; 
        const u = new SpeechSynthesisUtterance(`The winner is ${winner.name}.`);
        window.speechSynthesis.speak(u);
    }

    function openReview() { 
        const m = MODULES[ENGINE_STATE.currentDomain];
        if (m && m.review) window.open(m.review, '_blank');
        else showToast("NO VIDEO AVAILABLE");
    }

    // --- TRIVIA & EXTERNAL ---
    function renderTriviaGate() {
        const section = document.createElement('section'); section.className = "main-slide next";
        section.innerHTML = `<div class="slide-header"><span class="header-title">TRIVIA</span></div><div class="lobby-container"><h1 style="text-align:center">CATEGORY</h1><div style="display:grid; gap:15px;"><button class="cuisine-btn" onclick="startTrivia(9)">GENERAL</button><button class="cuisine-btn" onclick="startTrivia(18)">COMPUTERS</button><button class="cuisine-btn" onclick="startTrivia(17)">SCIENCE</button><button class="cuisine-btn" onclick="startTrivia(23)">HISTORY</button></div></div>`;
        document.getElementById('master-container').appendChild(section); slideElements.push(section); goToSlide(1);
    }

    async function startTrivia(cat) {
        showToast("FETCHING Qs...");
        ENGINE_STATE.triviaMode = true;
        const data = await TRIVIA_ENGINE.fetch(cat);
        if(!data.length) return showToast("ERROR");
        const container = document.getElementById('master-container');
        data.forEach((q, i) => {
            const el = document.createElement('section'); el.className = `main-slide next`;
            const answers = [...q.incorrect_answers, q.correct_answer].sort(() => Math.random() - 0.5);
            let html = `<div class="slide-header"><span class="header-title">Q${i+1}</span></div><div class="carousel-viewport">`;
            answers.forEach((ans, idx) => {
                html += `<div class="sub-slide ${idx===0?'opt-active':'opt-hidden'}" data-correct="${ans === q.correct_answer}" data-real="${q.correct_answer}"><div class="role-label">${q.difficulty.toUpperCase()}</div><h1 style="font-size:1.4rem;">${decodeHTML(q.question)}</h1><div style="margin-top:20px; font-size:1.2rem; color:var(--brand-orange);">${decodeHTML(ans)}</div><div class="nav-hint"><span class="skip-btn-clickable" onclick="manualSkip(this)">SKIP</span><span style="color:var(--accent-go)">SELECT &uarr;</span></div></div>`;
            });
            html += `</div>`; el.innerHTML = html; container.appendChild(el); slideElements.push(el);
        });
        goToSlide(slideElements.length - data.length);
    }

    function renderExternalModule(url) {
        addGlobalExit();
        const section = document.createElement('section');
        section.className = "main-slide next";
        section.innerHTML = `<iframe src="${url}"></iframe><button class="close-iframe" onclick="renderLobby()">EXIT</button>`; 
        document.getElementById('master-container').appendChild(section);
        slideElements.push(section);
        goToSlide(slideElements.length - 1);
    }

    // --- SWIPE SYSTEM ---
    function manualSkip(el) {
        if (event) event.stopPropagation();
        const view = el.closest('.carousel-viewport');
        const active = view.querySelector('.sub-slide.opt-active');
        if (!active) return;
        const siblings = Array.from(view.querySelectorAll('.sub-slide:not(.static)'));
        const next = siblings[(siblings.indexOf(active) + 1) % siblings.length];
        active.classList.replace('opt-active', 'opt-hidden');
        next.classList.replace('opt-hidden', 'opt-active');
    }

    function goToSlide(idx) {
        if(idx < 0 || idx >= slideElements.length) return;
        slideElements[currentIdx].classList.replace('active', idx > currentIdx ? 'prev' : 'next');
        currentIdx = idx;
        slideElements[currentIdx].className = "main-slide active";
        if(slideElements[currentIdx].querySelector('#final-list')) updateFinal();
    }
    
    let tsY = 0, tsX = 0;
    function initSwipeSystem() {
        document.addEventListener('touchstart', e => { 
            tsY = e.touches[0].clientY; 
            tsX = e.touches[0].clientX; 
        }, {passive: true});

        document.addEventListener('touchend', e => {
            if(e.target.closest('.wiki-summary')) return;

            const view = e.target.closest('.main-slide.active .carousel-viewport');
            if(!view || document.querySelector('iframe')) return;
            
            const dy = e.changedTouches[0].clientY - tsY;
            const active = view.querySelector('.sub-slide.opt-active') || view.querySelector('.sub-slide.static');

            if(dy < -60) { // UP SWIPE
                if(active.classList.contains('static')) {
                    active.classList.remove('static'); active.classList.add('opt-hidden');
                    view.querySelector('.sub-slide:nth-child(2)').classList.add('opt-active');
                } else if(ENGINE_STATE.triviaMode) {
                    if(active.dataset.correct === "true") { 
                        showToast("CORRECT!", "success"); 
                        setTimeout(() => goToSlide(currentIdx + 1), 800);
                    } else { 
                        showToast("WRONG!", "error"); 
                        setTimeout(() => goToSlide(currentIdx + 1), 800); 
                    }
                } else if(active.dataset.val) {
                    if(ENGINE_STATE.currentDomain === 'smartphones' || ENGINE_STATE.currentDomain === 'earbuds') {
                        ENGINE_STATE.items_detected[active.dataset.val] = true; goToSlide(currentIdx + 1);
                    } else { 
                        diveDeeper(active.dataset.val); 
                    }
                }
            } else if(dy > 60) { // DOWN SWIPE
                if(ENGINE_STATE.currentDomain === 'research' && ENGINE_STATE.researchPath.length > 1) {
                    ENGINE_STATE.researchPath.pop(); 
                    buildResearchDeck(ENGINE_STATE.researchPath[ENGINE_STATE.researchPath.length-1]);
                } else { 
                    goToSlide(currentIdx - 1); 
                }
            }
        });
    }

    function showToast(m, type="normal") { 
        const t = document.getElementById('toast'); 
        t.innerText = m; 
        t.style.borderColor = type === 'error' ? '#f44' : 'rgba(255,255,255,0.1)'; 
        t.classList.add('visible'); 
        setTimeout(() => t.classList.remove('visible'), 2000); 
    }
    
    function decodeHTML(html) { const txt = document.createElement("textarea"); txt.innerHTML = html; return txt.value; }
    function redirect() { const item = Object.keys(ENGINE_STATE.items_detected)[0]; if(!item) return showToast("NOTHING SELECTED"); window.open(`https://www.amazon.in/s?k=${encodeURIComponent(item)}&tag=${AMZN_TAG}`, '_blank'); }

    boot();
</script>
</body>
</html>
