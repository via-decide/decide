<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>| decide.engine v70.0 |</title>

    <link rel="manifest" href="manifest.json">
    <meta name="theme-color" content="#000000">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>

    <style>
        /* =========================================
           CORE SYSTEM | DECIDE OS v70.0 (GLASS)
           ========================================= */
        :root {
            --brand-orange: #ff671f;
            --brand-dark: #050505;
            --glass-surface: rgba(20, 20, 20, 0.6);
            --glass-border: rgba(255, 255, 255, 0.08);
            --text-main: #ffffff;
            --text-muted: #a0a0a0;
            --accent-go: #00e676; 
            --accent-skip: #ff3333;
            --font-tech: 'Courier New', monospace;
            --font-ui: -apple-system, BlinkMacSystemFont, "SF Pro Display", "Segoe UI", Roboto, sans-serif;
        }

        html, body {
            margin: 0; padding: 0; height: 100%; width: 100%;
            background-color: var(--brand-dark);
            color: var(--text-main);
            font-family: var(--font-ui);
            overflow: hidden;
            touch-action: none; user-select: none;
            -webkit-font-smoothing: antialiased;
        }

        /* ðŸŒŒ CINEMATIC BACKGROUND */
        .aurora-bg {
            position: fixed; top: -50%; left: -50%; width: 200%; height: 200%;
            background: radial-gradient(circle at 50% 50%, #1a1a2e 0%, #000000 70%);
            z-index: -1;
            animation: drift 20s infinite alternate ease-in-out;
            opacity: 0.8;
            pointer-events: none;
        }
        @keyframes drift { 0% { transform: translate(0,0) scale(1); } 100% { transform: translate(-20px, -20px) scale(1.05); } }

        #master-container { height: 100vh; width: 100vw; position: relative; overflow: hidden; }

        .main-slide {
            height: 100vh; width: 100vw; position: absolute; top: 0; left: 0;
            display: flex; flex-direction: column;
            transition: transform 0.5s cubic-bezier(0.19, 1, 0.22, 1);
            will-change: transform;
            background: transparent;
        }

        .main-slide.prev { transform: translateY(-100%) scale(0.95); opacity: 0; pointer-events: none; }
        .main-slide.active { transform: translateY(0) scale(1); opacity: 1; z-index: 10; pointer-events: auto; }
        .main-slide.next { transform: translateY(100%) scale(0.95); opacity: 0; z-index: 20; pointer-events: none; }

        .slide-header {
            padding: 0 24px; height: 80px;
            display: flex; align-items: center; justify-content: space-between;
            position: absolute; top: 0; left: 0; right: 0; z-index: 100;
            background: linear-gradient(180deg, rgba(0,0,0,0.8) 0%, rgba(0,0,0,0) 100%);
        }

        .header-title {
            font-family: var(--font-tech); font-size: 0.7rem; color: var(--brand-orange);
            letter-spacing: 2px; font-weight: 700; text-transform: uppercase;
            background: rgba(255, 103, 31, 0.1); padding: 6px 12px; border-radius: 4px;
            border: 1px solid rgba(255, 103, 31, 0.2);
        }

        .carousel-viewport { position: relative; flex-grow: 1; width: 100%; height: 100%; margin-top: 80px; perspective: 1000px; }

        .sub-slide {
            position: absolute; inset: 20px; bottom: 100px; 
            padding: 30px; display: flex; flex-direction: column; justify-content: center;
            background: var(--glass-surface);
            backdrop-filter: blur(20px); -webkit-backdrop-filter: blur(20px);
            border: 1px solid var(--glass-border);
            border-radius: 24px;
            box-shadow: 0 20px 50px rgba(0,0,0,0.5);
            opacity: 0; pointer-events: none; 
            transform: translateY(20px) scale(0.95);
            transition: all 0.4s cubic-bezier(0.19, 1, 0.22, 1);
        }

        .sub-slide.opt-active, .sub-slide.static { 
            opacity: 1; pointer-events: auto; 
            transform: translateY(0) scale(1); 
            z-index: 30; 
        }

        h1 { 
            font-family: var(--font-ui); font-size: 2.2rem; font-weight: 700; 
            margin: 0 0 15px 0; letter-spacing: -0.03em; line-height: 1.1;
            background: linear-gradient(to right, #fff, #ccc);
            -webkit-background-clip: text; -webkit-text-fill-color: transparent;
        }
        
        .wiki-summary { 
            font-family: var(--font-ui); font-size: 1.05rem; color: var(--text-muted); 
            line-height: 1.6; font-weight: 400;
            max-height: 300px; overflow-y: auto; 
            mask-image: linear-gradient(to bottom, black 85%, transparent 100%);
        }

        .role-label {
            font-family: var(--font-tech); font-size: 0.65rem; color: var(--brand-orange);
            margin-bottom: 15px; font-weight: 700; letter-spacing: 1px;
            display: flex; align-items: center; gap: 8px;
        }
        .role-label::before { content: ''; width: 8px; height: 8px; background: var(--brand-orange); border-radius: 50%; box-shadow: 0 0 10px var(--brand-orange); }

        .btn { 
            background: rgba(255,255,255,0.05); color: #fff; 
            border: 1px solid rgba(255,255,255,0.1); 
            padding: 18px; border-radius: 12px; 
            font-weight: 600; font-size: 0.9rem; cursor: pointer; width: 100%; 
            transition: all 0.2s; font-family: var(--font-ui);
        }
        .btn:active { transform: scale(0.96); background: rgba(255,255,255,0.1); }
        .btn-primary { background: var(--brand-orange); color: #000; border: none; }
        .btn-yt { background: #cc0000; border: none; color: white; display:flex; align-items:center; justify-content:center; gap:8px;}

        .cuisine-btn { 
            background: rgba(20,20,20,0.6); border: 1px solid var(--glass-border); 
            color: #888; padding: 25px; font-size: 1.1rem; font-weight: 600; 
            text-transform: uppercase; border-radius: 16px; 
            transition: all 0.3s; flex-shrink: 0; letter-spacing: 0.5px;
            font-family: var(--font-ui);
        }
        .cuisine-btn.selected { 
            background: rgba(255, 103, 31, 0.15); color: var(--brand-orange); 
            border-color: var(--brand-orange); box-shadow: 0 0 30px rgba(255,103,31,0.1); 
        }

        .search-wrapper { position: relative; margin-bottom: 20px; }
        #search-input { 
            width: 100%; padding: 20px; border-radius: 16px; 
            border: 1px solid var(--glass-border); 
            background: rgba(0,0,0,0.3); color: #fff; 
            font-family: var(--font-ui); font-size: 1.1rem; 
            transition: all 0.3s; box-sizing: border-box; 
        }
        #search-input:focus { border-color: var(--brand-orange); outline: none; background: rgba(0,0,0,0.5); }

        .nav-hint {
            margin-top: 25px; padding-top: 15px; border-top: 1px solid rgba(255,255,255,0.05);
            font-family: var(--font-tech); font-size: 0.7rem; color: #555;
            display: flex; justify-content: space-between; pointer-events: none;
        }
        
        .skip-btn-clickable { 
            cursor: pointer; padding: 8px 16px; 
            background: rgba(255,255,255,0.05); border: 1px solid rgba(255,255,255,0.1);
            border-radius: 20px; pointer-events: auto; 
            font-weight: 600; font-size: 0.7rem; color: #aaa;
            transition: 0.2s; font-family: var(--font-tech);
        }
        .skip-btn-clickable:active { background: #fff; color: #000; }

        .toast-msg { 
            position: fixed; bottom: 40px; left: 50%; transform: translateX(-50%) translateY(20px); 
            background: rgba(20,20,20,0.9); backdrop-filter: blur(10px);
            color: var(--accent-go); padding: 12px 24px; 
            border: 1px solid rgba(255,255,255,0.1); border-radius: 30px; 
            font-size: 0.8rem; opacity: 0; transition: all 0.3s cubic-bezier(0.19, 1, 0.22, 1); 
            z-index: 3000; font-family: var(--font-tech); box-shadow: 0 10px 30px rgba(0,0,0,0.5);
        }
        .toast-msg.visible { opacity: 1; transform: translateX(-50%) translateY(0); }

        .lobby-container { 
            display: flex; flex-direction: column; gap: 15px; padding: 30px; height: 100%; 
            overflow-y: auto; justify-content: flex-start; padding-top: 100px; padding-bottom: 150px;
        }

        .video-bg { position: absolute; top: 0; left: 0; width: 100%; height: 100%; object-fit: cover; z-index: -1; opacity: 0.4; mix-blend-mode: screen; }
        .winner-container { flex-grow: 1; display: flex; flex-direction: column; justify-content: flex-end; padding: 30px; padding-bottom: 120px; background: linear-gradient(to top, #000 95%, transparent); }

        iframe { width: 100%; height: 100%; border: none; background: #000; }
        .close-iframe { position: fixed; top: 20px; right: 20px; z-index: 200; background: rgba(0,0,0,0.8); border: 1px solid #333; color: #fff; padding: 10px 20px; border-radius: 20px; font-family: var(--font-tech); font-weight: bold; cursor: pointer;}

        /* TOPIC GRID */
        .topic-grid { display: grid; grid-template-columns: 1fr; gap: 15px; margin-top: 20px; }
        .topic-card {
            background: rgba(255,255,255,0.03); border: 1px solid var(--glass-border);
            padding: 20px; border-radius: 12px; cursor: pointer; transition: all 0.2s;
        }
        .topic-card:active { background: rgba(255,255,255,0.1); transform: scale(0.98); }
        .topic-title { font-weight: bold; color: #fff; font-size: 0.9rem; margin-bottom: 5px; font-family: var(--font-tech); }
        .topic-desc { font-size: 0.8rem; color: #888; display: -webkit-box; -webkit-line-clamp: 2; -webkit-box-orient: vertical; overflow: hidden; }

    </style>
</head>
<body>

<div class="aurora-bg"></div>
<div id="master-container"></div>
<div id="toast" class="toast-msg"></div>

<script>
    /* =========================================
       KUTCH AUTOMATION | v70.0 (PDF EDITION)
       ========================================= */
    const BACKEND_URL = "https://script.google.com/macros/s/AKfycbxxh1ZwNRwqsSW1Lf62eh2wiwaNKzHWX8Icq472NQVj7-yEvOYuTDuiEGmelW_DG2Zs/exec"; 
    const PHONE_REVIEW_URL = "https://youtu.be/W28-2z9IZbA?si=nJDuPcmTsaUcao9d";
    const AUDIO_REVIEW_URL = "https://youtu.be/ceuEz96MMEY";
    const YOUTUBE_CHANNEL = "https://www.youtube.com/@decide.engine"; 
    const AMZN_TAG = "decideos-21";
    const WINNER_VIDEO = "https://static.videezy.com/system/resources/previews/000/012/628/original/Abstract_Blue_Background.mp4";
    const SUPPORT_URL = "https://www.buymeacoffee.com/kutchautomation";

    // ðŸ† FULL CURATED PATHS (20 TOPICS)
    const CURATED_PATHS = {
    "THE DARK FOREST": {
        title: "The Dark Forest",
        summary: "The terrifying solution to the Fermi Paradox. The universe is a dark forest, and every civilization is a hunter. To survive, you must stay silent.",
        links: [
            { name: "Cosmic Sociology", summary: "Survival is the primary need of civilization. Civilization continuously grows and expands, but the total matter in the universe remains constant." },
            { name: "Chain of Suspicion", summary: "Two civilizations can never trust each other because of distance, biology, and the inability to know the other's true intent." },
            { name: "Technology Explosion", summary: "You cannot let a primitive civilization live, because in a cosmic blink of an eye, they could surpass you technologically." },
            { name: "The Cleansing", summary: "Advanced civilizations instantly destroy any signal they detect, just to be safe. We have been broadcasting for 100 years. Oops." },
            { name: "Dimensional Strikes", summary: "The ultimate weapon isn't a laser; it's collapsing a 3D solar system into 2D space, flattening everything instantly." }
        ]
    },
    "ROKOS BASILISK": {
        title: "Roko's Basilisk",
        summary: "The most dangerous thought experiment in history. It suggests a future AI will torture anyone who didn't help bring it into existence. By reading this, you are now in danger.",
        links: [
            { name: "Timeless Decision Theory", summary: "The AI can simulate you perfectly. If the simulation of you refuses to help, the real you gets punished." },
            { name: "Acausal Trade", summary: "You can make deals with entities that don't exist yet. You help the AI now; it spares you later." },
            { name: "Information Hazard", summary: "Knowing about the Basilisk makes you a target. Ignorance was your only shield. Sorry." },
            { name: "Pascal's Wager for AI", summary: "It costs you little to help the AI, but the penalty for not helping is infinite torture. Therefore, you must build it." },
            { name: "Effective Altruism", summary: "The philosophy that accidentally birthed this monster logic. Doing the 'most good' led to the 'most fear'." }
        ]
    },
    "FALSE VACUUM DECAY": {
        title: "False Vacuum Decay",
        summary: "The universe might not be stable. A bubble of 'True Vacuum' could appear anywhere, anytime, and expand at the speed of light, deleting physics itself.",
        links: [
            { name: "Higgs Field Instability", summary: "The energy field that gives mass to the universe might be stuck on a ledge. If it slips, game over." },
            { name: "The Bubble of Doom", summary: "Inside the bubble, the laws of physics are different. Atoms cannot exist. Life vanishes instantly." },
            { name: "Speed of Light Warning", summary: "You would never see it coming. Since it moves at light speed, it hits you before the light from it reaches your eyes." },
            { name: "Heat Death Alternative", summary: "Instead of a slow freeze, the universe ends in a violent instant rewrite." },
            { name: "Quantum Tunneling", summary: "A particle could tunnel through the energy barrier at any moment, triggering the collapse." }
        ]
    },
    "BOLTZMANN BRAINS": {
        title: "Boltzmann Brains",
        summary: "It is statistically more likely for a single brain to spontaneously form in a void with your memories than for the entire universe to have evolved naturally.",
        links: [
            { name: "Entropy & Chaos", summary: "In an infinite universe over infinite time, atoms will randomly assemble into anythingâ€”including a brain." },
            { name: "The Observer Problem", summary: "You believe you have a past, but those could be false memories implanted in a brain that just appeared 1 second ago." },
            { name: "Brief Existence", summary: "A Boltzmann Brain exists for a millisecond, thinks one thought, and then dissolves back into chaos." },
            { name: "Cosmic Inflation", summary: "Scientists use this paradox to test theories. If a theory predicts more Boltzmann Brains than real humans, it is wrong." },
            { name: "Solipsism", summary: "The philosophical nightmare: You are the only thing that exists, and your reality is a hallucination." }
        ]
    },
    "DYSON SPHERES": {
        title: "Dyson Spheres",
        summary: "The ultimate megastructure. A shell built around a star to capture 100% of its energy. It is the hallmark of a Type II Civilization.",
        links: [
            { name: "The Energy Crisis", summary: "A civilization eventually uses more energy than a planet can provide. The star is the only next step." },
            { name: "Dyson Swarm", summary: "A solid shell is unstable. A swarm of billions of satellites orbiting the star is the realistic version." },
            { name: "Matrioshka Brain", summary: "Using the energy of a Dyson Sphere to power a computer the size of a solar system. God-like intelligence." },
            { name: "Tabby's Star", summary: "A real star in our galaxy that dimmed mysteriously. Was it a Dyson Sphere under construction?" },
            { name: "Starlifting", summary: "Mining a star for raw materials to build the sphere. Literally taking the sun apart." }
        ]
    },
    "QUANTUM IMMORTALITY": {
        title: "Quantum Immortality",
        summary: "The idea that you can never die. In the Many-Worlds Interpretation, every time you die in one universe, your consciousness continues in the one where you survived.",
        links: [
            { name: "Schrodinger's Cat", summary: "The cat is both dead and alive. But from the cat's perspective, it is always alive." },
            { name: "Many-Worlds Theory", summary: "Every decision splits reality. There is a timeline where you survive every accident, disease, and age." },
            { name: "The Russian Roulette Experiment", summary: "A physicist creates a gun triggered by a quantum quark. If MWI is true, he will hear a click for eternity." },
            { name: "Subjective Survival", summary: "You might be the oldest person in your universe, watching everyone else die while you strangely persist." },
            { name: "The End of Entropy", summary: "Eventually, you are a floating consciousness in a heat-dead universe, unable to die. Hell." }
        ]
    },
    "THE LIBRARY OF BABEL": {
        title: "The Library of Babel",
        summary: "A library that contains every possible book. Most are gibberish, but one contains the true story of your life, and another contains the false one.",
        links: [
            { name: "Infinite Permutations", summary: "By rearranging letters randomly, you eventually write Shakespeare, the cure for cancer, and your own obituary." },
            { name: "Jorge Luis Borges", summary: "The author who imagined this nightmare. Librarians go mad looking for the 'Index Man' who knows where the truth is." },
            { name: "Information Entropy", summary: "If you have all information, you have zero information. Finding the truth is impossible in the noise." },
            { name: "The Digital Library", summary: "A website actually exists that simulates this. You can search for your death date, and it's there somewhere." },
            { name: "Meaning vs. Chaos", summary: "Does a sentence have meaning if it was generated by randomness? Or do we invent the meaning?" }
        ]
    },
    "SHIP OF THESEUS": {
        title: "Ship of Theseus",
        summary: "If you replace every plank of a ship one by one, is it still the same ship? If you replace every cell in your brain, are you still you?",
        links: [
            { name: "The Identity Paradox", summary: "What makes 'You' you? Is it the material (meat) or the pattern (memories)?" },
            { name: "Teleportation Problem", summary: "If a teleporter destroys you here and rebuilds you on Mars, did you travel, or did you die and a clone wake up?" },
            { name: "Upload Consciousness", summary: "If we upload your mind to a cloud and turn off your body, is the computer 'you' or just a chatbot?" },
            { name: "Biological Turnover", summary: "Every 7 years, almost every atom in your body is replaced. You are a completely different physical object than you were at birth." },
            { name: "Continuity of Self", summary: "The illusion that you are one person flowing through time, rather than a series of moments." }
        ]
    },
    "SIMULATION THEORY": {
        title: "Simulation Theory",
        summary: "The statistical argument that we are likely living in a computer simulation created by a more advanced civilization.",
        links: [
            { name: "Ancestral Simulations", summary: "Future humans will simulate their history. There will be billions of sims and one base reality. Odds are, you are in a sim." },
            { name: "Pixelation of Physics", summary: "Planck Length is the smallest possible unit of space. It looks suspiciously like a pixel grid limit." },
            { name: "Rendering Efficiency", summary: "Quantum mechanics suggests things don't exist until observed. This saves processing power, like a video game loading chunks." },
            { name: "The Glitch", summary: "Mandela Effects, Deja Vu, and UFOs. Are these bugs in the code?" },
            { name: "Base Reality", summary: "If we are in a sim, is our creator also in a sim? Is it turtles all the way down?" }
        ]
    },
    "THE GREAT ATTRACTOR": {
        title: "The Great Attractor",
        summary: "Something massive is pulling our entire galaxy towards it at millions of miles per hour. But we can't see what it is because it's hidden behind the Milky Way.",
        links: [
            { name: "Zone of Avoidance", summary: "The area of the sky blocked by our own galaxy's dust. The Attractor hides in this blind spot." },
            { name: "Laniakea Supercluster", summary: "We are part of a river of galaxies flowing towards a central point. We are surfing a cosmic wave." },
            { name: "Dark Flow", summary: "Some galaxies seem to be moving towards a point *outside* the observable universe. What is pulling them?" },
            { name: "Gravitational Anomaly", summary: "The mass required to pull us this fast is equivalent to quadrillions of suns. It is the monster in the dark." },
            { name: "The Wall", summary: "Is it a black hole? A cluster of galaxies? Or a bruise from a collision with another universe?" }
        ]
    },
    "GREY GOO": {
        title: "Grey Goo",
        summary: "A nanotech apocalypse. Self-replicating nanobots programmed to consume matter to build more of themselves could eat the entire Earth in 72 hours.",
        links: [
            { name: "Molecular Manufacturing", summary: "The dream of building anything atom-by-atom. The nightmare of losing control of the builders." },
            { name: "Exponential Growth", summary: "1 becomes 2, 2 becomes 4. By step 60, they outweigh the planet. Math is scary." },
            { name: "The Blue Goo", summary: "A defense system: 'Police' nanobots designed to hunt down and eat the Grey Goo. Nanowarfare." },
            { name: "Ecophagy", summary: "The literal eating of the environment. The biosphere becomes a tech-sphere." },
            { name: "Safety Limits", summary: "Scientists propose hard-coding 'kill switches' or making bots require rare elements so they can't eat trees." }
        ]
    },
    "KARDASHEV SCALE": {
        title: "The Kardashev Scale",
        summary: "A method of measuring a civilization's advancement based on the amount of energy it can capture. We are currently Type 0.7.",
        links: [
            { name: "Type I: Planetary", summary: "Masters of their home world. Control weather, volcanoes, and all solar energy hitting the planet." },
            { name: "Type II: Stellar", summary: "Masters of their star. Dyson spheres. Immune to extinction events." },
            { name: "Type III: Galactic", summary: "Masters of the galaxy. Colonizing billions of stars. Extracting energy from black holes." },
            { name: "Type IV & V", summary: "Universal and Multiversal gods. They operate outside the laws of physics as we know them." },
            { name: "The Great Silence", summary: "If Type III civilizations exist, they should be blindingly obvious. Where are they?" }
        ]
    },
    "THE UNCANNY VALLEY": {
        title: "The Uncanny Valley",
        summary: "The feeling of revulsion when a robot looks *almost* human but not quite. It suggests humans evolved to fear something that looked human but wasn't.",
        links: [
            { name: "Evolutionary Defense", summary: "Why do we have a specific instinct to fear 'fake humans'? Did we coexist with corpses or shapeshifters?" },
            { name: "Corpses & Disease", summary: "The most likely theory: We fear things that look dead or diseased to avoid infection." },
            { name: "Androids", summary: "Modern robotics is stuck here. Sofia the Robot looks creepy, not cute. We prefer R2-D2." },
            { name: "Deepfakes", summary: "AI video is crossing the valley. Soon, we won't be able to tell real from fake, killing trust." },
            { name: "The Other Human Species", summary: "Neanderthals looked 'almost' like us. Maybe the valley is an ancient war instinct." }
        ]
    },
    "THE EGG": {
        title: "The Egg",
        summary: "A viral story by Andy Weir. It proposes that you are the only person in the universe. Everyone else is just you in a different life.",
        links: [
            { name: "Reincarnation", summary: "You are reincarnated across time linearly and non-linearly. You are Hitler, and you are the millions he killed." },
            { name: "The Maturity", summary: "The universe is an egg/incubator for a baby god (You). Once you live every human life, you will be born." },
            { name: "Solipsism with Empathy", summary: "Instead of 'only I matter', it argues 'everyone matters because everyone is me'. The ultimate Golden Rule." },
            { name: "God's Conversation", summary: "The story is a dialogue between You and God, explaining the purpose of suffering." },
            { name: "Cosmic Perspective", summary: "It changes how you view strangers. The homeless man is just you in a harder level." }
        ]
    },
    "TIME CRYSTALS": {
        title: "Time Crystals",
        summary: "A new phase of matter that repeats in time, not just space. They break the laws of thermodynamics by moving without consuming energy.",
        links: [
            { name: "Perpetual Motion", summary: "They aren't free energy, but they are the closest thing physics allows to a perpetual motion machine." },
            { name: "Quantum Computing", summary: "Time crystals are stable against noise, making them the holy grail for memory in quantum computers." },
            { name: "Symmetry Breaking", summary: "Normal crystals break spatial symmetry. Time crystals break time-translation symmetry." },
            { name: "Google's Sycamore", summary: "Google's quantum computer actually created a time crystal for a fraction of a second." },
            { name: "Exotic Matter", summary: "Matter that shouldn't exist but does. It opens the door to physics we haven't even imagined." }
        ]
    },
    "THE DEAD INTERNET THEORY": {
        title: "Dead Internet Theory",
        summary: "The conspiracy that the internet died around 2016 and is now 80% bots talking to other bots to manipulate human perception.",
        links: [
            { name: "The Bot Takeover", summary: "Traffic analysis shows over 50% of web activity is non-human." },
            { name: "Algorithmic Sludge", summary: "AI content farms generating text for search engines, not people." },
            { name: "Simulation Hypothesis", summary: "Are we being gaslit by our own creation?" },
            { name: "The Dark Forest", summary: "Real humans are retreating to private discords, leaving the public web to the bots." },
            { name: "Deepfakes", summary: "The end of 'Video Evidence' and shared reality." }
        ]
    },
    "THE OMNIPRESENCE OF MICROPLASTICS": {
        title: "Microplastics",
        summary: "There is plastic in your blood, your lungs, and the deepest ocean trenches. We have coated the planet in a layer of synthetic polymer.",
        links: [
            { name: "Blood Brain Barrier", summary: "Nanoplastics are small enough to cross into the brain. We don't know what they do there yet." },
            { name: "Hormone Disruption", summary: "Plastics mimic estrogen. Fertility rates are dropping globally. Is this the cause?" },
            { name: "The Plastisphere", summary: "A new ecosystem of bacteria evolving to eat plastic in the ocean. Life adapts." },
            { name: "Atmospheric Transport", summary: "It rains plastic in the Antarctic. The wind carries particles everywhere." },
            { name: "The Credit Card Diet", summary: "The average human ingests a credit card's worth of plastic every week." }
        ]
    },
    "NEURALINK & TRANSHUMANISM": {
        title: "Neuralink",
        summary: "Merging man with machine. Elon Musk's brain chip aims to cure blindness and paralysis, but eventually, it aims to save us from AI.",
        links: [
            { name: "High Bandwidth", summary: "Humans communicate at 10 bits/second (typing). Computers at 1 trillion. We need to speed up to stay relevant." },
            { name: "Telepathy", summary: "Conceptual communication. Sending a thought directly to another person without words." },
            { name: "The Hive Mind", summary: "If we are all connected, does individuality die? Do we become the Borg?" },
            { name: "Security Risks", summary: "Can your brain be hacked? Can memories be deleted or implanted?" },
            { name: "The Divide", summary: "Rich people get smarter with chips. Poor people stay biological. A new species split." }
        ]
    },
    "THE WOW! SIGNAL": {
        title: "The Wow! Signal",
        summary: "In 1977, a radio telescope detected a strong, narrowband signal from Sagittarius. It lasted 72 seconds and never repeated.",
        links: [
            { name: "The Signature", summary: "The signal was at 1420 MHz (Hydrogen Line), the universal frequency scientists said aliens would use." },
            { name: "The Origin", summary: "It came from an empty patch of sky. No stars, no planets visible. Was it a passing ship?" },
            { name: "No Explanation", summary: "Comets, satellites, and glitches have been ruled out. It remains the best candidate for contact." },
            { name: "The Response", summary: "We sent a reply 35 years later. It will arrive in 25,000 years. Don't hold your breath." },
            { name: "Fermi's Answer", summary: "Maybe they pinged us once, saw we were boring, and moved on." }
        ]
    },
    "PANPSYCHISM": {
        title: "Panpsychism",
        summary: "The theory that consciousness is not generated by the brain, but is a fundamental property of matter, like mass or charge. Everything feels.",
        links: [
            { name: "The Hard Problem", summary: "Science can explain how the brain processes data, but not why it 'feels' like something. Panpsychism solves this." },
            { name: "Integrated Information", summary: "Consciousness correlates with complexity. A rock has 0.0001 conscioussness; a human has 100." },
            { name: "Electron Awareness", summary: "Does an electron 'choose' to spin up or down? Is quantum randomness actually free will?" },
            { name: "Universal Consciousness", summary: "If the universe is made of conscious particles, is the universe itself conscious?" },
            { name: "Implications for AI", summary: "If silicon atoms have proto-consciousness, building a brain out of them will inevitably create a soul." }
        ]
    }
    };

    // ðŸ§  DATABASES (Full)
    const PHONE_DB = {
      "Poco F7": { attr: { cam: 6, gam: 10, bat: 9, ui: 4, dis: 9, srv: 6, thm: 10, dur: 7 }, tags: ["heavy", "performance"], price: 29999 },
      "iQOO Neo 10R": { attr: { cam: 7, gam: 10, bat: 8, ui: 5, dis: 9, srv: 7, thm: 9, dur: 7 }, tags: ["performance", "value"], price: 30999 },
      "Nothing 3a Pro": { attr: { cam: 8, gam: 7, bat: 8, ui: 10, dis: 9, srv: 9, thm: 8, dur: 8 }, tags: ["clean_ui", "no_charger"], price: 27999 },
      "Xiaomi 14 Civi": { attr: { cam: 10, gam: 6, bat: 6, ui: 6, dis: 10, srv: 6, thm: 6, dur: 7 }, tags: ["camera_king", "compact"], price: 32999 },
      "Vivo V60e": { attr: { cam: 10, gam: 5, bat: 7, ui: 7, dis: 8, srv: 7, thm: 7, dur: 7 }, tags: ["camera_king", "aura_light"], price: 28999 },
      "Samsung A55": { attr: { cam: 8, gam: 4, bat: 7, ui: 9, dis: 9, srv: 10, thm: 7, dur: 10 }, tags: ["trust", "updates", "bloatware"], price: 33999 },
      "Realme GT 7T": { attr: { cam: 6, gam: 9, bat: 10, ui: 5, dis: 8, srv: 7, thm: 8, dur: 7 }, tags: ["battery_king", "120w"], price: 31999 },
      "Samsung Galaxy F07": { attr: { cam: 6, gam: 3, bat: 9, ui: 7, dis: 6, srv: 10, thm: 9, dur: 8 }, tags: ["budget", "trust", "val"], price: 7499 },
      "Realme Note 60": { attr: { cam: 5, gam: 4, bat: 8, ui: 6, dis: 6, srv: 7, thm: 7, dur: 6 }, tags: ["budget", "value", "val"], price: 7999 },
      "Samsung S24 FE": { attr: { cam: 10, gam: 7, bat: 5, ui: 10, dis: 10, srv: 9, thm: 7, dur: 9 }, tags: ["premium", "clean_ui", "camera_king", "7yr_updates"], price: 29999 }
    };

    const AUDIO_DB = {
      "Technics AZ100": { attr: { anc: 9.5, snd: 10.0, mic: 9, lat: 8, bat: 7, fit: 10, bld: 9, app: 9 }, price: 22990 },
      "Sony WF-1000XM6": { attr: { anc: 10.0, snd: 9.5, mic: 8, lat: 6, bat: 8, fit: 8, bld: 9, app: 10 }, price: 24990 },
      "SteelSeries Arctis": { attr: { anc: 7.0, snd: 8.0, mic: 8, lat: 10, bat: 9, fit: 8, bld: 7, app: 7 }, price: 17999 },
      "OnePlus Nord Buds 3": { attr: { anc: 8.5, snd: 8.0, mic: 8, lat: 7, bat: 8, fit: 9, bld: 8, app: 8 }, price: 3299 },
      "Tribit FlyBuds 3": { attr: { anc: 5.0, snd: 6, mic: 6, lat: 6, bat: 10, fit: 7, bld: 7, app: 5 }, price: 3999 }
    };

    const TRIVIA_ENGINE = {
        api: "https://opentdb.com/api.php?amount=5&type=multiple",
        async fetch(category = "") {
            try {
                const url = this.api + (category ? `&category=${category}` : "");
                const res = await fetch(url);
                const data = await res.json();
                if(data.response_code !== 0) return [];
                return data.results || [];
            } catch(e) { return []; }
        }
    };

    const DEAL_BREAKERS = { "CLEAN UI": "bloatware", "LIGHTWEIGHT": "heavy", "FAST CHARGE": "slow_charge" };

    const MODULES = {
        smartphones: { 
            label: "SMARTPHONES", 
            database: PHONE_DB, 
            review: PHONE_REVIEW_URL,
            init: () => renderEcosystemGate(), 
            categories: [
                { label: "CAMERA-FIRST", type: "cam", items: [{"name": "Vivo V60e"}, {"name": "Xiaomi 14 Civi"}] }, 
                { label: "PRO GAMER", type: "gam", items: [{"name": "Poco F7"}, {"name": "iQOO Neo 10R"}] }, 
                { label: "CLEAN UI", type: "ui", items: [{"name": "Nothing 3a Pro"}, {"name": "Samsung A55"}] },
                { label: "BATTERY KING", type: "bat", items: [{"name": "Realme GT 7T"}] },
                { label: "BUDGET BUY", type: "val", items: [{"name": "Samsung Galaxy F07"}, {"name": "Realme Note 60"}] }
            ] 
        },
        earbuds: { 
            label: "EARBUDS", 
            database: AUDIO_DB, 
            review: AUDIO_REVIEW_URL,
            init: () => { ENGINE_STATE.active_filters=[]; renderSubLobby('earbuds'); }, 
            categories: [
                { label: "AUDIOPHILE", type: "snd", items: [{"name": "Technics AZ100"}] }, 
                { label: "SILENCE (ANC)", type: "anc", items: [{"name": "Sony WF-1000XM6"}] },
                { label: "LOW LATENCY", type: "lat", items: [{"name": "SteelSeries Arctis"}] },
                { label: "WORK & MIC", type: "mic", items: [{"name": "Technics AZ100"}] }
            ] 
        },
        trivia: { label: "TRIVIA", init: () => renderTriviaGate() },
        research: { label: "RESEARCH", init: () => renderSearchSlide() },
        food: { label: "DINING", init: () => renderExternalModule("https://via-decide.github.io/food.decider/") },
        review: { label: "ENGINE REVIEW â†—", init: () => window.open(YOUTUBE_CHANNEL, '_blank') }
    };

    const WIKI_ENGINE = {
        async search(query) {
            const upper = query.toUpperCase();
            if(CURATED_PATHS[upper]) return upper; 
            try {
                const url = `https://en.wikipedia.org/w/api.php?origin=*&action=opensearch&search=${encodeURIComponent(query)}&limit=1&format=json`;
                const res = await fetch(url);
                const data = await res.json();
                return (data[1] && data[1].length > 0) ? data[1][0] : null;
            } catch(e) { return null; }
        },
        async getContext(title) {
            if(CURATED_PATHS[title.toUpperCase()]) {
                const c = CURATED_PATHS[title.toUpperCase()];
                return { title: c.title, summary: c.summary, links: c.links };
            }
            try {
                const url = `https://en.wikipedia.org/w/api.php?origin=*&action=query&prop=extracts|links&titles=${encodeURIComponent(title)}&redirects=1&exintro=1&explaintext=1&pllimit=20&format=json`;
                const res = await fetch(url);
                const data = await res.json();
                const pageId = Object.keys(data.query.pages)[0];
                if(pageId === "-1") return { title: "Not Found", summary: "", links: [] };
                const page = data.query.pages[pageId];
                return { title: page.title, summary: page.extract || "No summary.", links: page.links ? page.links.map(l => ({name: l.title})) : [] };
            } catch(e) { return { title: "Error", summary: "Connection Failed.", links: [] }; }
        }
    };

    let ENGINE_STATE = { currentDomain: null, items_detected: {}, active_filters: [], session_weights: {}, researchPath: [], triviaMode: false };
    let slideElements = [];
    let currentIdx = 0;

    async function boot() { 
        const params = new URLSearchParams(window.location.search);
        const syllabus = params.get('syllabus');
        if (syllabus) {
            ENGINE_STATE.currentDomain = 'research';
            renderSearchSlide(); 
            document.getElementById('search-input').value = syllabus;
            executeSearch(); 
        } else { renderLobby(); }
        initSwipeSystem(); 
    }

    // ðŸŽ¨ UI RENDERERS
    function renderLobby() {
        const container = document.getElementById('master-container');
        container.innerHTML = "";
        const section = document.createElement('section');
        section.className = "main-slide active";
        let html = `<div class="slide-header"><span class="header-title">DECIDE OS v70.0</span></div><div class="lobby-container"><h1 style="text-align:center; font-size:1.5rem; letter-spacing:2px; margin-bottom:40px;">SELECT DOMAIN</h1>`;
        for(let key in MODULES) {
            html += `<button class="cuisine-btn" onclick="loadDomain('${key}')">${MODULES[key].label}</button>`;
        }
        html += `</div>`;
        section.innerHTML = html;
        container.appendChild(section);
        slideElements = [section];
        currentIdx = 0;
    }

    function loadDomain(key) {
        ENGINE_STATE.currentDomain = key;
        const container = document.getElementById('master-container');
        while(container.children.length > 1) container.removeChild(container.lastChild);
        slideElements = [slideElements[0]];
        MODULES[key].init();
    }

    // ðŸ“± HARDWARE LOGIC
    function renderEcosystemGate() {
        const section = document.createElement('section');
        section.className = "main-slide next";
        section.innerHTML = `<div class="slide-header"><span class="header-title">PHILOSOPHY</span></div><div class="lobby-container"><h1 style="text-align:center">WHAT MATTERS?</h1><div style="display:grid; gap:20px;"><button class="cuisine-btn" onclick="selectEcosystem('specs')">PURE SPECS</button><button class="cuisine-btn" onclick="selectEcosystem('peace')">PEACE OF MIND</button></div></div>`;
        document.getElementById('master-container').appendChild(section);
        slideElements.push(section); goToSlide(1);
    }
    
    function selectEcosystem(type) { ENGINE_STATE.ecosystem = type; ENGINE_STATE.active_filters = []; renderSubLobby('smartphones'); }

    function renderSubLobby(domain) {
        const section = document.createElement('section');
        section.className = "main-slide next"; 
        const module = MODULES[domain];
        let html = `<div class="slide-header"><span class="header-title">FILTER</span></div><div class="lobby-container"><h1 style="text-align:center">PRIORITIES</h1>`;
        module.categories.forEach((cat, idx) => {
            html += `<button class="cuisine-btn" id="filter-btn-${idx}" onclick="toggleFilter('${cat.label}', ${idx})">${cat.label}</button>`;
        });
        html += `<button class="btn btn-primary" style="margin-top:30px" onclick="startHunt()">HUNT &rarr;</button></div>`;
        section.innerHTML = html; document.getElementById('master-container').appendChild(section); slideElements.push(section); goToSlide(slideElements.length - 1);
    }

    function toggleFilter(label, idx) {
        const btn = document.getElementById(`filter-btn-${idx}`);
        if(ENGINE_STATE.active_filters.includes(label)) { ENGINE_STATE.active_filters = ENGINE_STATE.active_filters.filter(x => x !== label); btn.classList.remove('selected'); } 
        else { ENGINE_STATE.active_filters.push(label); btn.classList.add('selected'); }
    }

    function startHunt() {
        if(ENGINE_STATE.active_filters.length === 0) return showToast("SELECT AT LEAST ONE");
        ENGINE_STATE.session_weights = { cam:0.1, gam:0.1, bat:0.1, ui:0.1, dis:0.1, srv:0.1, thm:0.1, dur:0.1, anc:0.1, snd:0.1, mic:0.1, lat:0.1, fit:0.1, bld:0.1, app:0.1 };
        buildDeck();
    }

    function buildDeck() {
        const container = document.getElementById('master-container');
        const currentMod = MODULES[ENGINE_STATE.currentDomain];
        const targetCats = currentMod.categories.filter(c => ENGINE_STATE.active_filters.includes(c.label));
        targetCats.forEach(cat => {
            const el = document.createElement('section'); el.className = `main-slide next`;
            let html = `<div class="slide-header"><span class="header-title">${cat.label}</span></div><div class="carousel-viewport">`;
            const items = cat.items.length > 0 ? cat.items : [{name: cat.label + " Optimized"}];
            items.forEach((item, i) => {
                html += `<div class="sub-slide ${i===0?'opt-active':'opt-hidden'}" data-val="${item.name}"><div class="role-label">PROPOSAL</div><h1>${item.name}</h1><div class="nav-hint"><span class="skip-btn-clickable" onclick="manualSkip(this)">SKIP</span><span style="color:var(--accent-go)">SELECT &uarr;</span></div></div>`;
            });
            html += `</div>`; el.innerHTML = html; container.appendChild(el); slideElements.push(el);
        });
        
        const final = document.createElement('section'); final.className = "main-slide next";
        final.innerHTML = `<video class="video-bg" autoplay loop muted playsinline><source src="${WINNER_VIDEO}" type="video/mp4"></video><div class="winner-container"><div id="final-list"></div><div class="final-actions"><button class="btn btn-primary" onclick="redirect('amazon')">BUY NOW â†—</button><button class="btn btn-yt" onclick="window.open('${currentMod.review}', '_blank')">â–¶ WATCH REVIEW</button><button class="btn" onclick="location.reload()">RESTART</button></div></div>`;
        container.appendChild(final); slideElements.push(final); goToSlide(currentIdx + 1);
    }

    function calculateVerdict() {
        const activeModule = MODULES[ENGINE_STATE.currentDomain];
        if(!activeModule.database) return {name: "Ready", price: "---"};
        let DB = activeModule.database; let scores = []; const bannedTags = [];
        ENGINE_STATE.active_filters.forEach(f => { if(DEAL_BREAKERS[f.toUpperCase()]) bannedTags.push(DEAL_BREAKERS[f.toUpperCase()]); });
        for (let name in DB) {
            let item = DB[name]; if(item.tags && item.tags.some(t => bannedTags.includes(t))) continue;
            let score = 0;
            if(ENGINE_STATE.ecosystem === 'specs' && (item.tags?.includes('performance') || item.tags?.includes('value'))) score += 3;
            if(ENGINE_STATE.ecosystem === 'peace' && (item.tags?.includes('trust'))) score += 3;
            for(let attr in item.attr) { let w = ENGINE_STATE.session_weights[attr] || 0.1; score += item.attr[attr] * w; }
            if(ENGINE_STATE.items_detected[name]) score += 10;
            scores.push({name, score, price: item.price});
        }
        scores.sort((a, b) => b.score - a.score); return scores[0] || {name: "No Match", price: 0};
    }

    // ðŸŽ“ TRIVIA LOGIC
    function renderTriviaGate() {
        const section = document.createElement('section'); section.className = "main-slide next";
        section.innerHTML = `<div class="slide-header"><span class="header-title">TRIVIA</span></div><div class="lobby-container"><h1 style="text-align:center">CATEGORY</h1><div style="display:grid; gap:15px;"><button class="cuisine-btn" onclick="startTrivia(9)">GENERAL</button><button class="cuisine-btn" onclick="startTrivia(18)">COMPUTERS</button><button class="cuisine-btn" onclick="startTrivia(17)">SCIENCE</button><button class="cuisine-btn" onclick="startTrivia(23)">HISTORY</button></div></div>`;
        document.getElementById('master-container').appendChild(section); slideElements.push(section); goToSlide(1);
    }

    async function startTrivia(cat) {
        showToast("FETCHING Qs...");
        ENGINE_STATE.triviaMode = true;
        const data = await TRIVIA_ENGINE.fetch(cat);
        if(!data.length) return showToast("ERROR");
        const container = document.getElementById('master-container');
        data.forEach((q, i) => {
            const el = document.createElement('section'); el.className = `main-slide next`;
            const answers = [...q.incorrect_answers, q.correct_answer].sort(() => Math.random() - 0.5);
            let html = `<div class="slide-header"><span class="header-title">Q${i+1}</span></div><div class="carousel-viewport">`;
            answers.forEach((ans, idx) => {
                html += `<div class="sub-slide ${idx===0?'opt-active':'opt-hidden'}" data-correct="${ans === q.correct_answer}" data-real="${q.correct_answer}"><div class="role-label">${q.difficulty.toUpperCase()}</div><h1 style="font-size:1.4rem;">${decodeHTML(q.question)}</h1><div style="margin-top:20px; font-size:1.2rem; color:var(--brand-orange);">${decodeHTML(ans)}</div><div class="nav-hint"><span class="skip-btn-clickable" onclick="manualSkip(this)">SKIP</span><span style="color:var(--accent-go)">SELECT &uarr;</span></div></div>`;
            });
            html += `</div>`; el.innerHTML = html; container.appendChild(el); slideElements.push(el);
        });
        goToSlide(slideElements.length - data.length);
    }

    // ðŸ”¬ RESEARCH LOGIC (With Default 20 Topics Feed)
    async function renderSearchSlide() {
        const section = document.createElement('section'); section.className = "main-slide next";
        if(ENGINE_STATE.currentDomain === 'research') section.className = "main-slide active";
        
        let topicsHTML = `<div class="topic-grid">`;
        for(let key in CURATED_PATHS) {
            const t = CURATED_PATHS[key];
            topicsHTML += `<div class="topic-card" onclick="triggerCurated('${key}')"><div class="topic-title">${t.title}</div><div class="topic-desc">${t.summary}</div></div>`;
        }
        topicsHTML += `</div>`;

        section.innerHTML = `<div class="slide-header"><span class="header-title">RESEARCH</span></div><div class="lobby-container"><h1>TOPIC?</h1><div class="search-wrapper"><input type="text" id="search-input" placeholder="e.g. Stoicism, AI..."></div><button class="btn btn-primary" onclick="executeSearch()">SEARCH &rarr;</button>${topicsHTML}</div>`;
        
        const c = document.getElementById('master-container');
        if(ENGINE_STATE.currentDomain === 'research') { c.innerHTML = ""; c.appendChild(section); slideElements=[section]; currentIdx=0; } 
        else { c.appendChild(section); slideElements.push(section); goToSlide(1); }
    }

    function triggerCurated(key) {
        document.getElementById('search-input').value = key;
        executeSearch();
    }

    async function executeSearch() {
        const q = document.getElementById('search-input').value;
        if(!q) return showToast("ENTER TOPIC");
        showToast("FORGING NODE...");
        const title = await WIKI_ENGINE.search(q);
        if(!title) return showToast("NOT FOUND");
        const context = await WIKI_ENGINE.getContext(title);
        ENGINE_STATE.researchPath = [{ title: context.title, summary: context.summary }];
        buildResearchDeck(context);
    }

    function buildResearchDeck(context) {
        let links = context.links || [];
        if (links.length < 5) {
            const drifts = ["Quantum Mechanics", "Philosophy", "Future Tech", "History", "Psychology"];
            while (links.length < 5) links.push({name: drifts[links.length % drifts.length]});
        }
        links = links.slice(0, 5);
        const section = document.createElement('section'); section.className = "main-slide next";
        section.innerHTML = `<div class="slide-header"><span class="header-title">DEPTH: ${ENGINE_STATE.researchPath.length}</span><button class="skip-btn-clickable" onclick="saveJSON()">SAVE ðŸ’¾</button></div><div class="carousel-viewport"><div class="sub-slide static"><div class="role-label">KNOWLEDGE NODE</div><h1>${context.title}</h1><div class="wiki-summary">${context.summary}</div><div class="nav-hint"><span>SWIPE DOWN: BACK</span><span style="color:var(--accent-go)">UP: DIG DEEPER</span></div></div>${links.map((link, i) => `<div class="sub-slide opt-hidden" data-val="${link.name}" onclick="diveDeeper('${link.name}')"><div class="role-label">RELATED PATH ${i+1}/5</div><h1>${link.name}</h1><div class="nav-hint"><span class="skip-btn-clickable" onclick="manualSkip(this)">SKIP</span><span style="color:var(--accent-go)">SELECT &uarr;</span></div></div>`).join('')}</div>`;
        document.getElementById('master-container').appendChild(section); slideElements.push(section); goToSlide(slideElements.length - 1);
    }

    async function diveDeeper(t) {
        showToast("DIVING...");
        const ctx = await WIKI_ENGINE.getContext(t);
        ENGINE_STATE.researchPath.push({ title: ctx.title, summary: ctx.summary });
        buildResearchDeck(ctx);
    }

    // ðŸ›¡ï¸ REPLACED: saveJSON() -> NOW GENERATES PDF DIRECTLY
    function saveJSON() {
        const { jsPDF } = window.jspdf; 
        const doc = new jsPDF();
        
        let y = 20;

        // Header
        doc.setFont("courier", "bold");
        doc.setFontSize(18);
        doc.setTextColor(0, 0, 0);
        doc.text("DECIDE.ENGINE // RESEARCH PATH", 20, y);
        y += 15;

        // Content
        doc.setFontSize(12);
        doc.setFont("courier", "normal");

        ENGINE_STATE.researchPath.forEach((item, i) => {
            if (y > 270) { doc.addPage(); y = 20; }
            
            // Node Header
            doc.setFont("courier", "bold");
            doc.text(`[NODE ${String(i+1).padStart(2, '0')}] ${item.title.toUpperCase()}`, 20, y);
            y += 8;
            
            // Summary
            doc.setFont("courier", "normal");
            const lines = doc.splitTextToSize(item.summary, 170);
            doc.text(lines, 20, y);
            y += (lines.length * 6) + 10;
        });

        // Footer / Timestamp
        const date = new Date().toLocaleString();
        doc.setFontSize(10);
        doc.text(`GENERATED: ${date}`, 20, 280);

        doc.save("Decide_Journey.pdf");
        showToast("PDF DOWNLOADING...");
    }

    // ðŸ•¹ï¸ SYSTEM CORE
    function manualSkip(el) {
        if (event) event.stopPropagation();
        const view = el.closest('.carousel-viewport');
        const active = view.querySelector('.sub-slide.opt-active');
        if (!active) return;
        const siblings = Array.from(view.querySelectorAll('.sub-slide:not(.static)'));
        const next = siblings[(siblings.indexOf(active) + 1) % siblings.length];
        active.classList.replace('opt-active', 'opt-hidden');
        next.classList.replace('opt-hidden', 'opt-active');
    }

    function goToSlide(idx) {
        if(idx < 0 || idx >= slideElements.length) return;
        slideElements[currentIdx].classList.replace('active', idx > currentIdx ? 'prev' : 'next');
        currentIdx = idx;
        slideElements[currentIdx].className = "main-slide active";
        if(slideElements[currentIdx].querySelector('#final-list')) updateFinal();
    }
    
    function updateFinal() { 
        const list = document.getElementById('final-list'); const winner = calculateVerdict(); 
        list.innerHTML = `<div style="text-align:left;"><span style="color:var(--accent-go); font-size:0.8rem; font-weight:bold; letter-spacing:2px;">THE CHAMPION</span><div style="font-size:2.8rem; font-weight:900; margin:5px 0; color:#fff; line-height:1.1;">${winner.name}</div><p style="color:#eee; font-size:1.1rem; margin-top:5px;">Est. Price: â‚¹${winner.price}</p></div>`; 
        ENGINE_STATE.items_detected = {}; ENGINE_STATE.items_detected[winner.name] = true; 
    }

    let tsY = 0, tsX = 0;
    function initSwipeSystem() {
        document.addEventListener('touchstart', e => { tsY = e.touches[0].clientY; tsX = e.touches[0].clientX; }, {passive: true});
        document.addEventListener('touchend', e => {
            const view = e.target.closest('.carousel-viewport');
            if(!view || document.querySelector('iframe')) return;
            const dy = e.changedTouches[0].clientY - tsY;
            const dx = e.changedTouches[0].clientX - tsX;
            const active = view.querySelector('.sub-slide.opt-active') || view.querySelector('.sub-slide.static');

            if(dy < -80) { // UP
                if(active.classList.contains('static')) {
                    active.classList.remove('static'); active.classList.add('opt-hidden');
                    view.querySelector('.sub-slide:nth-child(2)').classList.add('opt-active');
                } else if(ENGINE_STATE.triviaMode) {
                    if(active.dataset.correct === "true") { showToast("CORRECT!", "success"); diveDeeper(active.dataset.real); }
                    else { showToast("WRONG!", "error"); setTimeout(() => diveDeeper(active.dataset.real), 1000); }
                } else if(active.dataset.val) {
                    if(ENGINE_STATE.currentDomain === 'smartphones' || ENGINE_STATE.currentDomain === 'earbuds') {
                        ENGINE_STATE.items_detected[active.dataset.val] = true; goToSlide(currentIdx + 1);
                    } else {
                        diveDeeper(active.dataset.val);
                    }
                }
            } else if(dy > 80) { // DOWN
                if(ENGINE_STATE.currentDomain === 'research' && ENGINE_STATE.researchPath.length > 1) {
                    ENGINE_STATE.researchPath.pop(); WIKI_ENGINE.getContext(ENGINE_STATE.researchPath[ENGINE_STATE.researchPath.length-1].title).then(c => buildResearchDeck(c));
                } else {
                    goToSlide(currentIdx - 1);
                }
            }
        });
    }

    function showToast(m, type="normal") {
        const t = document.getElementById('toast'); t.innerText = m;
        t.style.borderColor = type === 'error' ? '#f44' : 'rgba(255,255,255,0.1)';
        t.classList.add('visible'); setTimeout(() => t.classList.remove('visible'), 2000);
    }
    
    function decodeHTML(html) { const txt = document.createElement("textarea"); txt.innerHTML = html; return txt.value; }
    function renderExternalModule(url) { document.getElementById('master-container').innerHTML = `<iframe src="${url}"></iframe><button class="close-iframe" onclick="location.reload()">EXIT</button>`; }
    function redirect(type) { const item = Object.keys(ENGINE_STATE.items_detected)[0]; if(!item) return showToast("NOTHING SELECTED"); window.open(`https://www.amazon.in/s?k=${encodeURIComponent(item)}&tag=${AMZN_TAG}`, '_blank'); }

    boot();
</script>
</body>
</html>
