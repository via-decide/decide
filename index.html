<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>Decide Engine | ONDC Neutral Discovery</title>
    <meta name="theme-color" content="#000000">
    <link rel="manifest" href="manifest.json">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.31/jspdf.plugin.autotable.min.js"></script>
    <script src="https://html2canvas.hertzen.com/dist/html2canvas.min.js"></script>

    <style>
        /* =========================================
           CORE SYSTEM | VISUAL SHELL (v92.0)
           ========================================= */
        :root {
            --brand-orange: #ff671f;
            --brand-gold: #ffb700;
            --brand-dark: #050505;
            --glass-surface: rgba(20, 20, 20, 0.75);
            --glass-border: rgba(255, 255, 255, 0.12);
            --text-main: #ffffff;
            --text-muted: #a0a0a0;
            --accent-go: #00e676; 
            --accent-skip: #ff3333;
            --font-tech: 'Courier New', monospace;
            --font-ui: -apple-system, BlinkMacSystemFont, "SF Pro Display", "Segoe UI", Roboto, sans-serif;
            --ease-elastic: cubic-bezier(0.19, 1, 0.22, 1);
        }

        html, body { margin: 0; padding: 0; height: 100%; width: 100%; background-color: var(--brand-dark); color: var(--text-main); font-family: var(--font-ui); overflow: hidden; touch-action: none; user-select: none; -webkit-font-smoothing: antialiased; }
        .aurora-bg { position: fixed; top: -50%; left: -50%; width: 200%; height: 200%; background: radial-gradient(circle at 50% 50%, #1a1a2e 0%, #000000 70%); z-index: -1; animation: drift 25s infinite alternate ease-in-out; opacity: 0.8; pointer-events: none; will-change: transform; }
        @keyframes drift { 0% { transform: translate3d(0,0,0) scale(1); } 100% { transform: translate3d(-20px, -20px, 0) scale(1.05); } }
        #master-container { height: 100vh; width: 100vw; position: relative; overflow: hidden; }
        .main-slide { height: 100vh; width: 100vw; position: absolute; top: 0; left: 0; display: flex; flex-direction: column; transition: transform 0.5s var(--ease-elastic), opacity 0.4s ease; will-change: transform, opacity; background: transparent; }
        .main-slide.prev { transform: translateY(-100%) scale(0.95); opacity: 0; pointer-events: none; }
        .main-slide.active { transform: translateY(0) scale(1); opacity: 1; z-index: 10; pointer-events: auto; }
        .main-slide.next { transform: translateY(100%) scale(0.95); opacity: 0; z-index: 20; pointer-events: none; }
        .slide-header { padding: 0 24px; height: 70px; display: flex; align-items: center; justify-content: space-between; position: absolute; top: 0; left: 0; right: 0; z-index: 100; background: linear-gradient(180deg, rgba(0,0,0,0.8) 0%, rgba(0,0,0,0) 100%); pointer-events: none; }
        .slide-header > * { pointer-events: auto; }
        .header-title { font-family: var(--font-tech); font-size: 0.7rem; color: var(--brand-orange); letter-spacing: 2px; font-weight: 700; text-transform: uppercase; background: rgba(255, 103, 31, 0.1); padding: 6px 12px; border-radius: 4px; border: 1px solid rgba(255, 103, 31, 0.2); display: flex; align-items: center; gap: 8px; }
        .status-dot { width: 6px; height: 6px; background: var(--accent-go); border-radius: 50%; box-shadow: 0 0 5px var(--accent-go); transition: background 0.3s; }
        .status-dot.offline { background: var(--accent-skip); box-shadow: 0 0 5px var(--accent-skip); }
        .exit-btn { padding: 8px 16px; border: 1px solid rgba(255,255,255,0.3); border-radius: 20px; background: rgba(0,0,0,0.6); color: #fff; font-family: var(--font-tech); font-size: 0.7rem; font-weight: bold; cursor: pointer; backdrop-filter: blur(10px); text-transform: uppercase; }
        .lobby-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 12px; padding: 24px; margin-top: 20px; overflow-y: auto; padding-bottom: 120px; box-sizing: border-box; height: 100%; align-content: start; padding-top: 80px; }
        .lobby-container { display: flex; flex-direction: column; gap: 15px; padding: 24px; height: 100%; overflow-y: auto; justify-content: flex-start; padding-top: 80px; box-sizing: border-box; }
        .grid-btn { background: rgba(255,255,255,0.03); border: 1px solid var(--glass-border); border-radius: 16px; padding: 20px; display: flex; flex-direction: column; align-items: center; justify-content: center; gap: 8px; aspect-ratio: 1.15; transition: all 0.2s; cursor: pointer; backdrop-filter: blur(10px); }
        .grid-icon { font-size: 1.8rem; }
        .grid-label { font-weight: 700; font-size: 0.85rem; color: #fff; }
        .grid-status { font-family: var(--font-tech); font-size: 0.6rem; color: var(--accent-go); opacity: 0.8; }
        .carousel-viewport { position: relative; flex-grow: 1; width: 100%; height: 100%; margin-top: 70px; perspective: 1000px; }
        .sub-slide { position: absolute; inset: 20px; bottom: 100px; padding: 30px; display: flex; flex-direction: column; justify-content: center; background: var(--glass-surface); backdrop-filter: blur(20px); border: 1px solid var(--glass-border); border-radius: 24px; opacity: 0; pointer-events: none; transform: translateY(20px) scale(0.95); transition: all 0.4s var(--ease-elastic); }
        .sub-slide.opt-active, .sub-slide.static { opacity: 1; pointer-events: auto; transform: translateY(0) scale(1); z-index: 30; }
        .sub-slide.opt-hidden { opacity: 0; pointer-events: none; transform: translateY(-20px) scale(0.95); }
        .cuisine-btn { background: rgba(20,20,20,0.6); border: 1px solid var(--glass-border); color: #888; padding: 20px; font-size: 1rem; font-weight: 600; border-radius: 12px; transition: all 0.3s; }
        .cuisine-btn.selected { background: rgba(255, 103, 31, 0.15); color: var(--brand-orange); border-color: var(--brand-orange); }
        .btn { background: rgba(255,255,255,0.05); color: #fff; border: 1px solid rgba(255,255,255,0.1); padding: 18px; border-radius: 12px; font-weight: 600; cursor: pointer; width: 100%; }
        .btn-primary { background: var(--brand-orange); color: #000; border: none; font-weight: 800; }
        .toast-msg { position: fixed; bottom: 40px; left: 50%; transform: translateX(-50%); background: #222; color: var(--accent-go); padding: 12px 24px; border-radius: 30px; opacity: 0; transition: opacity 0.3s; font-family: var(--font-tech); z-index: 9999; }
        .toast-msg.visible { opacity: 1; }
        .video-bg { position: absolute; top: 0; left: 0; width: 100%; height: 100%; object-fit: cover; z-index: -1; opacity: 0.4; }
        .winner-container { flex-grow: 1; display: flex; flex-direction: column; justify-content: flex-end; padding: 30px; padding-bottom: 120px; background: linear-gradient(to top, #000 95%, transparent); }
        .deal-tag { color: var(--accent-go); font-size: 0.8rem; background: rgba(0, 230, 118, 0.1); padding: 2px 6px; border-radius: 4px; }
        .role-label { font-family: var(--font-tech); font-size: 0.65rem; color: var(--brand-orange); margin-bottom: 10px; display: flex; align-items: center; gap: 8px; }
        .nav-hint { margin-top: 25px; display: flex; justify-content: space-between; font-family: var(--font-tech); font-size: 0.7rem; color: #555; }
        .skip-btn-clickable { cursor: pointer; padding: 4px 10px; background: rgba(255,255,255,0.1); border-radius: 4px; }
    </style>
</head>
<body>

<div class="aurora-bg"></div>
<div id="master-container"></div>
<div id="toast" class="toast-msg"></div>

<script>
    // --- CONFIG ---
    const BACKEND_URL = "REPLACE_WITH_YOUR_APPS_SCRIPT_URL"; 
    const AMZN_TAG = "decideos-21";
    const WINNER_VIDEO = "https://static.videezy.com/system/resources/previews/000/012/628/original/Abstract_Blue_Background.mp4";

    let PHONE_DB = {};
    let AUDIO_DB = {};
    let ENGINE_STATE = { 
        currentDomain: null, items_detected: {}, active_filters: [], 
        session_weights: {}, researchPath: [], triviaMode: false, sessionID: "" 
    };
    let slideElements = [];
    let currentIdx = 0;

    const DEAL_BREAKERS = { "CLEAN UI": "bloatware", "LIGHTWEIGHT": "heavy" };

    const MODULES = {
        smartphones: { label: "SMARTPHONES", database: null, init: () => renderEcosystemGate(), categories: [
            { label: "CAMERA-FIRST", type: "cam", items: [] }, { label: "PRO GAMER", type: "gam", items: [] }, 
            { label: "CLEAN UI", type: "ui", items: [] }, { label: "BATTERY KING", type: "bat", items: [] }
        ]},
        earbuds: { label: "EARBUDS", database: null, init: () => { ENGINE_STATE.active_filters=[]; renderSubLobby('earbuds'); }, categories: [
            { label: "AUDIOPHILE", type: "snd", items: [] }, { label: "SILENCE (ANC)", type: "anc", items: [] }
        ]}
    };

    // --- CORE LOGIC ---
    async function syncDatabase() {
        showToast("SYNCING DB...");
        try {
            const res = await fetch(`${BACKEND_URL}?type=local`);
            const data = await res.json();
            PHONE_DB = {}; AUDIO_DB = {};
            data.forEach(item => {
                const entry = {
                    attr: { cam:item.cam||0, gam:item.gam||0, bat:item.bat||0, ui:item.ui||0, dis:item.dis||0 },
                    price: item.price, mrp: item.mrp, tags: item.tags ? item.tags.split(',') : []
                };
                if(item.category === 'smartphones') PHONE_DB[item.Name] = entry;
                else AUDIO_DB[item.Name] = entry;
            });
            MODULES.smartphones.database = PHONE_DB;
            MODULES.earbuds.database = AUDIO_DB;
            showToast("DB LIVE ‚úÖ");
        } catch(e) { showToast("SYNC ERROR"); }
    }

    function calculateVerdict() {
        const db = MODULES[ENGINE_STATE.currentDomain].database;
        let candidates = [];
        for (let name in db) {
            let item = db[name];
            let score = 0;
            for(let a in item.attr) score += item.attr[a] * (ENGINE_STATE.session_weights[a] || 0.1);
            if(ENGINE_STATE.items_detected[name]) score += 10;
            candidates.push({name, score, price: item.price});
        }
        candidates.sort((a,b) => b.score - a.score);
        return candidates[0] || {name: "No Match", price: 0};
    }

    // --- UI RENDERERS ---
    function renderLobby() {
        const container = document.getElementById('master-container');
        container.innerHTML = `<section class="main-slide active">
            <div class="slide-header"><span class="header-title">DECIDE OS v92.0 <div class="status-dot"></div></span></div>
            <div class="lobby-grid">
                <div class="grid-btn" onclick="loadDomain('smartphones')"><div class="grid-icon">üì±</div><div class="grid-label">PHONES</div><div class="grid-status">NEUTRAL</div></div>
                <div class="grid-btn" onclick="loadDomain('earbuds')"><div class="grid-icon">üéß</div><div class="grid-label">AUDIO</div><div class="grid-status">LIVE DB</div></div>
            </div></section>`;
        slideElements = [container.firstChild];
        currentIdx = 0;
    }

    function loadDomain(key) {
        ENGINE_STATE.currentDomain = key;
        const container = document.getElementById('master-container');
        while(container.children.length > 1) container.removeChild(container.lastChild);
        slideElements = [slideElements[0]];
        addGlobalExit();
        MODULES[key].init();
    }

    function renderEcosystemGate() {
        const section = document.createElement('section'); section.className = "main-slide next";
        section.innerHTML = `<div class="slide-header"><span class="header-title">PHILOSOPHY</span></div>
            <div class="lobby-container"><h1>WHAT MATTERS?</h1>
            <button class="cuisine-btn" onclick="ENGINE_STATE.ecosystem='specs'; renderSubLobby('smartphones')">üöÄ PURE SPECS</button>
            <button class="cuisine-btn" style="margin-top:10px" onclick="ENGINE_STATE.ecosystem='peace'; renderSubLobby('smartphones')">üõ°Ô∏è PEACE OF MIND</button>
            </div>`;
        document.getElementById('master-container').appendChild(section); slideElements.push(section); goToSlide(1);
    }

    function renderSubLobby(domain) {
        const section = document.createElement('section'); section.className = "main-slide next";
        let html = `<div class="slide-header"><span class="header-title">FILTER</span></div><div class="lobby-container"><h1>PRIORITIES</h1>`;
        MODULES[domain].categories.forEach((cat, i) => {
            html += `<button class="cuisine-btn" id="f-${i}" onclick="toggleFilter('${cat.label}', 'f-${i}')">${cat.label}</button>`;
        });
        html += `<button class="btn btn-primary" style="margin-top:20px" onclick="startHunt()">HUNT &rarr;</button></div>`;
        section.innerHTML = html; document.getElementById('master-container').appendChild(section); slideElements.push(section); goToSlide(slideElements.length-1);
    }

    function toggleFilter(label, id) {
        const btn = document.getElementById(id);
        if(ENGINE_STATE.active_filters.includes(label)) { ENGINE_STATE.active_filters = ENGINE_STATE.active_filters.filter(x=>x!==label); btn.classList.remove('selected'); }
        else { ENGINE_STATE.active_filters.push(label); btn.classList.add('selected'); }
    }

    function startHunt() {
        ENGINE_STATE.session_weights = { cam:0.5, gam:0.5, bat:0.5, ui:0.5, dis:0.5 };
        buildDeck();
    }

    function buildDeck() {
        const container = document.getElementById('master-container');
        const db = MODULES[ENGINE_STATE.currentDomain].database;
        Object.keys(db).slice(0, 5).forEach(name => {
            const el = document.createElement('section'); el.className = "main-slide next";
            el.innerHTML = `<div class="slide-header"><span class="header-title">PROPOSAL</span></div>
                <div class="carousel-viewport"><div class="sub-slide opt-active" data-val="${name}">
                <div class="role-label">NEUTRAL OPTION</div><h1>${name}</h1>
                <div class="nav-hint"><span>SWIPE DOWN: BACK</span><span style="color:var(--accent-go)">SELECT &uarr;</span></div>
                </div></div>`;
            container.appendChild(el); slideElements.push(el);
        });
        const final = document.createElement('section'); final.className = "main-slide next";
        final.innerHTML = `<video class="video-bg" autoplay loop muted playsinline><source src="${WINNER_VIDEO}"></video>
            <div class="winner-container"><div id="final-list"></div><button class="btn btn-primary" onclick="window.open('https://amazon.in')">CHECK PRICE ‚Üó</button></div>`;
        container.appendChild(final); slideElements.push(final); goToSlide(currentIdx+1);
    }

    function updateFinal() {
        const winner = calculateVerdict();
        document.getElementById('final-list').innerHTML = `<div><span style="color:var(--accent-go)">THE NEUTRAL CHAMPION</span><h1 style="font-size:2.8rem">${winner.name}</h1><p>‚Çπ${winner.price}</p></div>`;
    }

    // --- UTILS ---
    function goToSlide(idx) {
        slideElements[currentIdx].classList.replace('active', idx > currentIdx ? 'prev' : 'next');
        currentIdx = idx; slideElements[currentIdx].className = "main-slide active";
        if(slideElements[currentIdx].querySelector('#final-list')) updateFinal();
    }

    function addGlobalExit() {
        if(document.getElementById('global-exit')) return;
        const b = document.createElement('button'); b.id='global-exit'; b.className='exit-btn'; b.innerText='EXIT';
        b.onclick=()=>renderLobby(); b.style.position='fixed'; b.style.top='20px'; b.style.right='20px'; b.style.zIndex='5000';
        document.body.appendChild(b);
    }

    function showToast(m) { const t = document.getElementById('toast'); t.innerText = m; t.classList.add('visible'); setTimeout(() => t.classList.remove('visible'), 2000); }
    function updateStatus(is) { const d = document.querySelector('.status-dot'); if(d) is ? d.classList.remove('offline') : d.classList.add('offline'); }

    let tsY = 0;
    function initSwipeSystem() {
        document.addEventListener('touchstart', e => tsY = e.touches[0].clientY);
        document.addEventListener('touchend', e => {
            const dy = e.changedTouches[0].clientY - tsY;
            const view = e.target.closest('.main-slide.active .carousel-viewport');
            if(!view) return;
            const active = view.querySelector('.sub-slide.opt-active');
            if(dy < -60 && active.dataset.val) { ENGINE_STATE.items_detected[active.dataset.val] = true; goToSlide(currentIdx + 1); }
            else if(dy > 60) goToSlide(currentIdx - 1);
        });
    }

    function boot() { 
        ENGINE_STATE.sessionID = "SID-" + Math.random().toString(36).substr(2,4).toUpperCase();
        syncDatabase(); renderLobby(); initSwipeSystem(); 
    }

    boot();
</script>
</body>
</html>
