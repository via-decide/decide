<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>| decide.engine |</title>

    <link rel="manifest" href="manifest.json">
    <meta name="theme-color" content="#0a0a0a">
    <meta name="background-color" content="#0a0a0a">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="decide.engine">
    <link rel="apple-touch-icon" href="icons/icon-192.png">
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="application-name" content="decide.engine">
    <meta name="description" content="Voice-first decision engine">

    <style>
        /* =========================================
           CORE SYSTEM | KUTCH AUTOMATION
           ========================================= */
        :root {
            --brand-orange: #ff671f;
            --brand-bg: #0a0a0a;
            --text-main: #f0f0f0;
            --accent-go: #00e676; 
            --accent-skip: #ff3333;
            --font-tech: 'Courier New', monospace;
            --font-ui: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
        }

        html, body {
            margin: 0; padding: 0; height: 100%; width: 100%;
            background-color: var(--brand-bg);
            color: var(--text-main);
            font-family: var(--font-ui);
            overflow: hidden;
            touch-action: none; 
            -webkit-user-select: none;
            user-select: none;
        }

        #master-container { height: 100vh; width: 100vw; position: relative; overflow: hidden; }

        .main-slide {
            height: 100vh; width: 100vw; position: absolute; top: 0; left: 0;
            display: flex; flex-direction: column; background: var(--brand-bg);
            transition: transform 0.5s cubic-bezier(0.2, 0.8, 0.2, 1);
            will-change: transform;
        }

        .main-slide.prev { transform: translateY(-100%); }
        .main-slide.active { transform: translateY(0); z-index: 10; }
        .main-slide.next { transform: translateY(100%); z-index: 20; }

        .slide-header {
            padding: 20px; border-left: 3px solid var(--brand-orange); height: 70px;
            flex-shrink: 0; z-index: 10; display: flex; align-items: center;
        }

        .header-title {
            font-family: var(--font-tech); font-size: 0.75rem; color: var(--brand-orange);
            letter-spacing: 1px; font-weight: 700; text-transform: uppercase;
        }

        .carousel-viewport { position: relative; flex-grow: 1; width: 100%; height: 100%; }

        .sub-slide {
            position: absolute; inset: 0; padding: 25px; display: flex; flex-direction: column;
            justify-content: center; opacity: 0; pointer-events: none; transform: translateX(20px);
            transition: transform 0.3s ease, opacity 0.3s ease;
        }

        .sub-slide.opt-active { z-index: 30; opacity: 1; pointer-events: auto; transform: translateX(0); }
        .sub-slide.opt-hidden { z-index: 0; opacity: 0; pointer-events: none; }
        .sub-slide.static { z-index: 30; opacity: 1; pointer-events: auto; transform: none; }

        h1 { font-size: 1.8rem; margin: 0 0 15px 0; line-height: 1; letter-spacing: -1px; color: var(--brand-orange); }
        .primary-question { font-size: 1.1rem; color: #fff; margin-bottom: 25px; line-height: 1.4; font-weight: 600; }
        .wiki-summary { font-size: 0.9rem; color: #aaa; line-height: 1.6; max-height: 200px; overflow-y: auto; margin-bottom: 20px; }

        .role-label {
            font-family: var(--font-tech); font-size: 0.6rem; color: #000;
            background: var(--accent-go); padding: 4px 8px; border-radius: 4px;
            width: fit-content; margin-bottom: 15px; font-weight: bold;
        }

        .nav-hint {
            margin-top: 30px; padding-top: 20px; border-top: 1px solid #333;
            font-family: var(--font-tech); font-size: 0.7rem; color: #666;
            display: flex; justify-content: space-between;
        }

        .input-group { 
            border: 1px solid #333; background: #111; padding: 20px; border-radius: 8px; 
            margin-bottom: 20px; min-height: 100px; max-height: 40vh; overflow-y: auto; 
        }
        
        .input-row { display: flex; justify-content: space-between; border-bottom: 1px dashed #333; padding: 10px 0; font-family: var(--font-tech); font-size: 0.8rem; }
        .input-key { color: #888; text-transform: uppercase; }
        .input-val { color: var(--accent-go); font-weight: bold; text-align: right; }
        
        .final-actions { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-top: 20px; }
        .btn { background: #222; color: #fff; border: 1px solid #333; padding: 15px; border-radius: 8px; font-weight: 600; text-align: center; font-size: 0.8rem; cursor: pointer; display: block; width: 100%; box-sizing: border-box; transition: opacity 0.3s; }
        .btn-full { grid-column: span 2; }
        
        .btn-amazon { background: #232f3e; border: none; color: #ff9900; }
        .btn-zomato { background: #cb202d; border: none; }
        .btn-wa { background: #25D366; color: #000; border: none; }
        
        .lobby-container { display: flex; flex-direction: column; gap: 15px; padding: 30px; height: 100%; justify-content: center; }
        .cuisine-btn { background: #222; border: 1px solid #444; color: #888; padding: 20px; font-size: 1.1rem; font-weight: bold; text-transform: uppercase; border-radius: 12px; transition: all 0.2s; }
        .cuisine-btn.selected { background: var(--brand-orange); color: #000; border-color: var(--brand-orange); }

        #search-input { width: 100%; background: #111; border: 1px solid #333; color: #fff; padding: 15px; font-size: 1.2rem; border-radius: 8px; margin-bottom: 20px; outline: none; text-align: center; }
        .source-toggle { display: flex; gap: 10px; margin-bottom: 20px; justify-content: center; }
        .source-chip { padding: 5px 15px; border: 1px solid #333; border-radius: 20px; font-size: 0.7rem; color: #666; font-family: var(--font-tech); cursor: pointer; }
        .source-chip.active { background: #333; color: var(--accent-go); border-color: var(--accent-go); }

        #depth-fill { position: fixed; right: 0; top: 0; bottom: 0; width: 4px; background: #333; z-index: 900; height: 0%; transition: height 0.05s linear; }
        
        /* Iframe Integration */
        iframe { width: 100%; height: 100%; border: none; background: #000; }
        .close-iframe { position: fixed; top: 20px; right: 20px; z-index: 100; background: #000; border: 1px solid #333; color: #fff; padding: 10px 20px; border-radius: 20px; font-family: var(--font-tech); font-weight: bold; }

        .toast-msg { position: fixed; bottom: 100px; left: 50%; transform: translateX(-50%); background: #222; color: #00e676; padding: 10px 20px; border: 1px solid #00e676; border-radius: 20px; font-size: 0.8rem; opacity: 0; pointer-events: none; transition: opacity 0.3s; z-index: 3000; font-family: var(--font-tech); }
        .toast-msg.visible { opacity: 1; }

        #mic-toggle { position: fixed; bottom: 20px; left: 20px; width: 50px; height: 50px; background: #111; border-radius: 50%; display: flex; align-items: center; justify-content: center; border: 1px solid #444; z-index: 2000; cursor: pointer; }
        #mic-toggle.listening { border-color: var(--accent-go); box-shadow: 0 0 15px rgba(0,230,118,0.3); }
        #mic-toggle svg { fill: #666; width: 24px; }
    </style>
</head>
<body>

<div id="master-container"></div>
<div id="depth-fill"></div>
<div id="toast" class="toast-msg"></div>

<div id="mic-toggle" onclick="toggleListenMode()">
    <svg viewBox="0 0 24 24"><path d="M12 14c1.66 0 3-1.34 3-3V5c0-1.66-1.34-3-3-3S9 3.34 9 5v6c0 1.66 1.34 3 3 3z"/><path d="M17 11c0 2.76-2.24 5-5 5s-5-2.24-5-5H5c0 3.53 2.61 6.43 6 6.92V21h2v-3.08c3.39-.49 6-3.39 6-6.92h-2z"/></svg>
</div>

<script>
    /* =========================================
       KUTCH AUTOMATION | UNIVERSAL OS v49.0
       ========================================= */
    
    // ðŸ§  1. CONTEXT EXTRACTOR (WIKIPEDIA API)
    const WIKI_ENGINE = {
        source: "wiki", 
        endpoints: { wiki: "https://en.wikipedia.org/w/api.php", travel: "https://en.wikivoyage.org/w/api.php" },
        async search(query) {
            try {
                const base = this.endpoints[this.source];
                const url = `${base}?origin=*&action=opensearch&search=${encodeURIComponent(query)}&limit=1&format=json`;
                const res = await fetch(url);
                const data = await res.json();
                return data[1][0] || null; 
            } catch(e) { return null; }
        },
        async getContext(title) {
            try {
                const base = this.endpoints[this.source];
                const url = `${base}?origin=*&action=query&prop=extracts|links&titles=${encodeURIComponent(title)}&exintro=1&explaintext=1&pllimit=10&plnamespace=0&format=json`;
                const res = await fetch(url);
                const data = await res.json();
                const pages = data.query.pages;
                const pageId = Object.keys(pages)[0];
                if(pageId === "-1") return null;
                const p = pages[pageId];
                return {
                    title: p.title,
                    summary: p.extract ? p.extract.split('. ')[0] + '.' : "No summary available.",
                    links: p.links ? p.links.map(l => ({ name: l.title })) : []
                };
            } catch(e) { return null; }
        }
    };

    // ðŸ§  2. TECH TRUTH DATABASES
    const PHONE_DATABASE = {
      // 20k+ High End
      "Poco F7": { attr: { camera: 6.0, gaming: 9.5, battery: 8.0, ui: 4.0 }, price: 29999 },
      "iQOO Neo 10R": { attr: { camera: 6.5, gaming: 9.0, battery: 7.5, ui: 5.0 }, price: 30999 },
      "Nothing 3a Pro": { attr: { camera: 8.0, gaming: 6.0, battery: 7.0, ui: 10.0 }, price: 27999 },
      "Xiaomi 14 Civi": { attr: { camera: 9.5, gaming: 6.0, battery: 6.5, ui: 6.0 }, price: 32999 },
      "Vivo V60e": { attr: { camera: 9.0, gaming: 5.0, battery: 7.0, ui: 7.0 }, price: 28999 },
      "Samsung A55": { attr: { camera: 7.5, gaming: 5.0, battery: 6.5, ui: 9.0 }, price: 33999 },
      "Realme GT 7T": { attr: { camera: 5.0, gaming: 8.5, battery: 10.0, ui: 5.0 }, price: 31999 },
      // Budget (<10k)
      "Samsung Galaxy F07": { attr: { camera: 6.0, gaming: 3.0, battery: 9.0, ui: 7.0 }, price: 7499 },
      "Realme Note 60": { attr: { camera: 5.0, gaming: 4.0, battery: 8.0, ui: 6.0 }, price: 7999 }
    };

    const AUDIO_DATABASE = {
      // Premium
      "Sony WF-1000XM6": { attr: { anc: 9.8, sound: 9.5, mic: 8.0, latency: 6.0 }, price: 24990 },
      "Nothing Ear (4)": { attr: { anc: 8.0, sound: 8.5, mic: 9.0, latency: 7.0 }, price: 11999 },
      "OnePlus Buds 3 Pro": { attr: { anc: 8.5, sound: 9.5, mic: 8.0, latency: 7.0 }, price: 8999 },
      "Realme Buds Air 7 Pro": { attr: { anc: 9.0, sound: 8.0, mic: 8.5, latency: 8.0 }, price: 4999 },
      // Budget/Gaming
      "Realme Buds T310": { attr: { anc: 6.0, sound: 7.5, mic: 7.0, latency: 8.0 }, price: 2499 },
      "boAt Nirvana 2026": { attr: { anc: 4.0, sound: 7.0, mic: 6.0, latency: 6.0 }, price: 1999 },
      "Razer Hammerhead V3": { attr: { anc: 6.0, sound: 7.0, mic: 7.0, latency: 9.8 }, price: 14999 },
      "Realme Buds 2 Neo": { attr: { anc: 0.0, sound: 6.0, mic: 5.0, latency: 9.0 }, price: 350 }
    };

    // ðŸ§  3. VECTORS (Tech Only - Food Handled by v28)
    const CATEGORY_VECTORS = {
        "camera": { camera: 0.4 }, "gaming": { gaming: 0.4 }, "battery": { battery: 0.4 }, "ui": { ui: 0.4 },
        "sound": { sound: 0.4 }, "anc": { anc: 0.4 }, "mic": { mic: 0.4 }, "latency": { latency: 0.4 }
    };

    const AMZN_TAG = "decideos-21";
    
    const ECOM_DEEP_LINKS = {
        amazon: { 
            app: q => `intent://www.amazon.in/s?k=${q}&tag=${AMZN_TAG}#Intent;scheme=https;package=in.amazon.mShop.android.shopping;end`, 
            web: q => `https://www.amazon.in/s?k=${q}&tag=${AMZN_TAG}` 
        }
    };

    // ðŸ§  4. FALLBACK MENU
    const FALLBACK_MENU = {
      "smartphones": {
          "label": "SMARTPHONES",
          "categories": [
              { "label": "CAMERA-FIRST", "type": "camera", "items": [{"name": "Vivo V60e"}, {"name": "Xiaomi 14 Civi"}, {"name": "Samsung A55"}] },
              { "label": "PRO GAMER", "type": "gaming", "items": [{"name": "Poco F7"}, {"name": "iQOO Neo 10R"}] },
              { "label": "CLEAN UI", "type": "ui", "items": [{"name": "Nothing 3a Pro"}, {"name": "Samsung Galaxy F07"}] },
              { "label": "BATTERY KING", "type": "battery", "items": [{"name": "Realme GT 7T"}, {"name": "Samsung Galaxy M07"}] }
          ]
      },
      "earbuds": {
          "label": "EARBUDS",
          "categories": [
              { "label": "MUSIC LOVER", "type": "sound", "items": [{"name": "Sony WF-1000XM6"}, {"name": "OnePlus Buds 3 Pro"}] },
              { "label": "GAMING (LOW LATENCY)", "type": "latency", "items": [{"name": "Razer Hammerhead V3"}, {"name": "Realme Buds T310"}] },
              { "label": "CALLS & WORK", "type": "mic", "items": [{"name": "Nothing Ear (4)"}, {"name": "Realme Buds Air 7 Pro"}] },
              { "label": "TRAVEL (ANC)", "type": "anc", "items": [{"name": "Sony WF-1000XM6"}, {"name": "Samsung Buds 3 Pro"}] }
          ]
      },
      "food": { 
          label: "DINING (v28)", 
          categories: [] // Handled by External Link
      },
      "research": { label: "WIKIPEDIA RESEARCH", categories: [] } 
    };

    let ENGINE_STATE = { cuisines_detected: [], items_detected: {}, session_weights: {}, active_filters: [] };
    let RAW_DATA = FALLBACK_MENU;
    let slideElements = [];
    let currentIdx = 0;

    async function boot() { renderLobby(); initVoice(); initSwipeSystem(); }

    /* =========================================
       UI LOGIC
       ========================================= */
    function renderLobby() {
        const container = document.getElementById('master-container');
        container.innerHTML = "";
        const section = document.createElement('section');
        section.className = "main-slide active";
        
        let html = `<div class="slide-header"><span class="header-title">DECIDE OS v49.0</span></div>
                    <div class="lobby-container"><h1 style="text-align:center">SELECT DOMAIN</h1><div style="display:grid; gap:15px;">`;
        
        for(let key in RAW_DATA) {
            const isSelected = ENGINE_STATE.cuisines_detected.includes(key) ? "selected" : "";
            html += `<button class="cuisine-btn ${isSelected}" onclick="toggleDomain('${key}', this)">${RAW_DATA[key].label}</button>`;
        }
        
        html += `</div><button class="btn btn-auto btn-full" style="margin-top:30px" onclick="handleStart()">NEXT &rarr;</button></div>`;
        section.innerHTML = html;
        container.appendChild(section);
        slideElements = [section];
        currentIdx = 0;
    }

    function toggleDomain(id, btn) {
        ENGINE_STATE.cuisines_detected = [id]; 
        document.querySelectorAll('.cuisine-btn').forEach(b => b.classList.remove('selected'));
        btn.classList.add('selected');
    }

    function handleStart() {
        if(ENGINE_STATE.cuisines_detected.length === 0) return showToast("SELECT DOMAIN");
        const domain = ENGINE_STATE.cuisines_detected[0];
        
        if(domain === "food") {
            // ðŸŸ¢ MODULAR INTEGRATION: Open v28 Logic
            renderExternalModule("https://via-decide.github.io/food.decider/");
        } else if(domain === "research") {
            renderSearchSlide();
        } else { 
            ENGINE_STATE.active_filters = []; 
            renderSubLobby(domain); 
        }
    }

    function renderExternalModule(url) {
        const container = document.getElementById('master-container');
        container.innerHTML = ""; // Clear current OS
        
        const iframe = document.createElement('iframe');
        iframe.src = url;
        container.appendChild(iframe);

        const closeBtn = document.createElement('button');
        closeBtn.className = "close-iframe";
        closeBtn.innerText = "EXIT MODULE";
        closeBtn.onclick = () => window.location.reload(); // Hard Reset to Lobby
        container.appendChild(closeBtn);
    }

    function renderSubLobby(domain) {
        const container = document.getElementById('master-container');
        while(container.children.length > 1) container.removeChild(container.lastChild);
        slideElements = [slideElements[0]];

        const section = document.createElement('section');
        section.className = "main-slide next"; 
        
        const title = "SELECT PRIORITY";
        const categories = RAW_DATA[domain].categories;

        let html = `<div class="slide-header"><span class="header-title">FILTER</span></div>
                    <div class="lobby-container">
                    <h1 style="text-align:center; text-transform:uppercase;">${title}</h1>
                    <div style="display:grid; gap:15px;">`;

        categories.forEach((cat, idx) => {
            html += `<button class="cuisine-btn" id="filter-btn-${idx}" onclick="toggleFilter('${cat.label}', ${idx})">${cat.label}</button>`;
        });

        html += `</div><button class="btn btn-auto btn-full" style="margin-top:30px" onclick="startHunt()">HUNT &rarr;</button></div>`;
        
        section.innerHTML = html;
        container.appendChild(section);
        slideElements.push(section); 
        goToSlide(1); 
    }

    function toggleFilter(label, idx) {
        const btn = document.getElementById(`filter-btn-${idx}`);
        if(ENGINE_STATE.active_filters.includes(label)) {
            ENGINE_STATE.active_filters = ENGINE_STATE.active_filters.filter(x => x !== label);
            btn.classList.remove('selected');
        } else {
            ENGINE_STATE.active_filters.push(label);
            btn.classList.add('selected');
        }
    }

    function startHunt() { 
        if(ENGINE_STATE.active_filters.length === 0) return showToast("SELECT AT LEAST ONE");
        ENGINE_STATE.session_weights = { camera:0.1, gaming:0.1, battery:0.1, ui:0.1, anc:0.1, sound:0.1, mic:0.1, latency:0.1 };
        buildDeck(); 
    }

    /* ðŸŸ¢ RESEARCH BRANCH */
    function renderSearchSlide() {
        const container = document.getElementById('master-container');
        while(container.children.length > 1) container.removeChild(container.lastChild);
        slideElements = [slideElements[0]];

        const section = document.createElement('section');
        section.className = "main-slide next";
        section.innerHTML = `<div class="slide-header"><span class="header-title">CONTEXT ENGINE</span></div>
                    <div class="lobby-container">
                        <div class="source-toggle">
                            <span class="source-chip active" onclick="setSource('wiki', this)">WIKIPEDIA</span>
                            <span class="source-chip" onclick="setSource('travel', this)">WIKIVOYAGE</span>
                        </div>
                        <h1>TOPIC?</h1>
                        <input type="text" id="search-input" placeholder="e.g. Goa, AI, Mars...">
                        <button class="btn btn-auto btn-full" onclick="executeSearch()">EXTRACT CONTEXT</button>
                    </div>`;
        
        container.appendChild(section);
        slideElements.push(section);
        goToSlide(1);
    }

    function setSource(src, btn) {
        WIKI_ENGINE.source = src;
        document.querySelectorAll('.source-chip').forEach(c => c.classList.remove('active'));
        btn.classList.add('active');
        document.getElementById('search-input').placeholder = src === 'travel' ? "e.g. Paris, Tokyo..." : "e.g. Quantum Physics...";
    }

    async function executeSearch() {
        const query = document.getElementById('search-input').value;
        if(!query) return showToast("ENTER TOPIC");
        showToast("EXTRACTING...");
        const title = await WIKI_ENGINE.search(query);
        if(!title) return showToast("NOT FOUND");
        const context = await WIKI_ENGINE.getContext(title);
        buildResearchDeck(context);
    }

    function buildResearchDeck(context) {
        const container = document.getElementById('master-container');
        while(container.children.length > 2) container.removeChild(container.lastChild);
        slideElements = slideElements.slice(0, 2);

        const sumSlide = document.createElement('section');
        sumSlide.className = "main-slide next";
        sumSlide.dataset.mode = "research"; 
        sumSlide.innerHTML = `<div class="slide-header"><span class="header-title">SUMMARY</span></div>
            <div class="carousel-viewport"><div class="sub-slide static">
                <div class="role-label">${WIKI_ENGINE.source === 'travel' ? 'DESTINATION' : 'TOPIC'}</div>
                <h1>${context.title}</h1>
                <div class="wiki-summary">${context.summary}</div>
                <div class="nav-hint"><span style="color:var(--accent-go)">SWIPE UP: BACK | DOWN: LINKS</span></div>
            </div></div>`;
        container.appendChild(sumSlide);
        slideElements.push(sumSlide);

        const linkSlide = document.createElement('section');
        linkSlide.className = "main-slide next";
        linkSlide.dataset.mode = "research"; 
        let html = `<div class="slide-header"><span class="header-title">SUB-NODES</span></div><div class="carousel-viewport">`;
        context.links.forEach((link, i) => {
             html += `<div class="sub-slide ${i===0?'opt-active':'opt-hidden'}" data-val="${link.name}">
                        <div class="role-label">RELATED NODE</div><h1>${link.name}</h1>
                        <div class="primary-question">Swipe Down to Extract</div>
                        <div class="nav-hint"><span>&larr; NEXT</span><span style="color:var(--accent-go)">EXTRACT &darr;</span></div>
                     </div>`;
        });
        html += `</div>`;
        linkSlide.innerHTML = html;
        container.appendChild(linkSlide);
        slideElements.push(linkSlide);
        goToSlide(2);
    }

    /* ðŸ”´ STANDARD BRANCH */
    function buildDeck() {
        const container = document.getElementById('master-container');
        while(container.children.length > 2) container.removeChild(container.lastChild);
        slideElements = slideElements.slice(0, 2); 

        const domain = ENGINE_STATE.cuisines_detected[0];
        const allCats = RAW_DATA[domain].categories;
        const targetCats = allCats.filter(c => ENGINE_STATE.active_filters.includes(c.label));

        let slides = [];
        targetCats.forEach(cat => {
            slides.push({ type: 'opt', title: cat.label, items: cat.items, catType: cat.type });
        });
        slides.push({ type: 'final' });

        slides.forEach((s, idx) => {
            const el = document.createElement('section');
            el.className = `main-slide next`;
            el.dataset.catType = s.catType;
            
            if(s.type === 'final') {
                el.innerHTML = `<div class="sub-slide static"><div class="input-group" id="final-list"></div>
                           <div class="final-actions">
                             <button class="btn btn-amazon" id="btn-amazon" onclick="redirect('amazon')">AMAZON</button>
                             <button class="btn btn-wa btn-full" onclick="sendWa()">WHATSAPP</button>
                             <button class="btn btn-full" onclick="location.reload()">HOME</button>
                           </div></div>`;
            } else {
                let html = `<div class="slide-header"><span class="header-title">${s.title}</span></div><div class="carousel-viewport">`;
                s.items.forEach((item, i) => {
                    html += `<div class="sub-slide ${i===0?'opt-active':'opt-hidden'}" data-val="${item.name}">
                             <div class="role-label">OPTION</div><h1>${item.name}</h1>
                             <div class="nav-hint"><span>SKIP</span><span style="color:var(--accent-go)">SELECT</span></div></div>`;
                });
                html += `</div>`;
                el.innerHTML = html;
            }
            container.appendChild(el);
            slideElements.push(el);
        });
        
        goToSlide(2); 
    }

    /* =========================================
       UX PHYSICS ENGINE (DELEGATED EVENTS)
       ========================================= */
    let touchStartX = 0, touchStartY = 0;

    function initSwipeSystem() {
        const doc = document;
        
        doc.addEventListener('touchstart', e => {
            const view = e.target.closest('.carousel-viewport');
            if(!view) return;
            touchStartX = e.touches[0].clientX; 
            touchStartY = e.touches[0].clientY;
        }, {passive: true});

        doc.addEventListener('touchmove', e => {
            const view = e.target.closest('.carousel-viewport');
            if(!view) return;
            const dy = e.touches[0].clientY - touchStartY;
            if(dy > 0 && Math.abs(dy) > Math.abs(e.touches[0].clientX - touchStartX)) {
                if (e.cancelable) e.preventDefault(); 
                document.getElementById('depth-fill').style.height = Math.min((dy/150)*100, 100) + '%';
            }
        }, {passive: false});

        doc.addEventListener('touchend', e => {
            const view = e.target.closest('.carousel-viewport');
            if(!view) return;
            
            const dx = e.changedTouches[0].clientX - touchStartX;
            const dy = e.changedTouches[0].clientY - touchStartY;
            document.getElementById('depth-fill').style.height = '0%';
            
            const mainSlide = view.closest('.main-slide');
            const mode = mainSlide.dataset.mode;
            const catType = mainSlide.dataset.catType;

            // ðŸŸ¢ SWIPE DOWN
            if(Math.abs(dy) > 80 && dy > 0) { 
                const activeSub = view.querySelector('.sub-slide.opt-active') || view.querySelector('.sub-slide.static');
                if(!activeSub) return;
                
                const val = activeSub.dataset.val;
                
                if(mode === "research" && val) {
                    document.getElementById('search-input').value = val;
                    executeSearch(); 
                } else if (val) {
                    ENGINE_STATE.items_detected[val] = {qty:1};
                    if(catType && CATEGORY_VECTORS[catType]) {
                        const vec = CATEGORY_VECTORS[catType];
                        for(let k in vec) ENGINE_STATE.session_weights[k] = (ENGINE_STATE.session_weights[k]||0) + vec[k];
                    }
                    showToast("SELECTED");
                    goToSlide(currentIdx + 1);
                } else {
                    goToSlide(currentIdx + 1);
                }
            } 
            // ðŸ”´ SWIPE UP
            else if (dy < -80) {
                if(mode === "research") {
                    showToast("BACK");
                    goToSlide(currentIdx - 1);
                } else {
                    goToSlide(currentIdx - 1);
                }
            }
            // ðŸŸ¡ SWIPE SIDE
            else if(Math.abs(dx) > 60) { 
                const slides = Array.from(view.querySelectorAll('.sub-slide'));
                if(slides.length <= 1) return;
                
                const currIdx = slides.findIndex(s => s.classList.contains('opt-active'));
                if(currIdx === -1) return;

                slides[currIdx].classList.replace('opt-active', 'opt-hidden');
                const nextIdx = (currIdx + (dx < 0 ? 1 : -1) + slides.length) % slides.length;
                slides[nextIdx].classList.replace('opt-hidden', 'opt-active');
            }
        });
    }

    function goToSlide(idx) {
        if(idx < 0) return;
        slideElements[currentIdx].classList.replace('active', idx>currentIdx?'prev':'next');
        currentIdx = idx;
        slideElements[currentIdx].className = "main-slide active";
        if(slideElements[currentIdx].querySelector('#final-list')) updateFinal();
    }

    function calculateVerdict() {
        const domain = ENGINE_STATE.cuisines_detected[0];
        if(domain === "research") return null;
        
        let DB = (domain === 'smartphones') ? PHONE_DATABASE : AUDIO_DATABASE;
        let scores = [];
        
        for (let name in DB) {
            let item = DB[name];
            let score = 0;
            for(let attr in item.attr) {
                let w = ENGINE_STATE.session_weights[attr] || 0;
                score += item.attr[attr] * w;
            }
            if(ENGINE_STATE.items_detected[name]) score += 10;
            scores.push({name, score, price: item.price});
        }
        scores.sort((a, b) => b.score - a.score);
        return scores[0]; 
    }

    function updateFinal() {
        const list = document.getElementById('final-list');
        const winner = calculateVerdict();
        
        if (winner) {
            list.innerHTML = `
            <div class="biz-card" style="border-color:var(--accent-go)">
                <span class="biz-tagline">TOP RECOMMENDATION</span>
                <div style="font-size:1.5rem; font-weight:800; margin:10px 0">${winner.name}</div>
                <p style="color:#aaa">Est. Price: â‚¹${winner.price}</p>
            </div>`;
            ENGINE_STATE.items_detected = {};
            ENGINE_STATE.items_detected[winner.name] = {qty:1};
        } else {
            let html = "";
            for(let k in ENGINE_STATE.items_detected) html+=`<div class="input-row"><span class="input-key">${k}</span><span class="input-val">READY</span></div>`;
            list.innerHTML = html || "Nothing Selected";
        }
    }

    // ðŸŸ¢ BULLETPROOF CLIPBOARD FIX
    function forceCopy(text) {
        if (navigator.clipboard && navigator.clipboard.writeText) {
            navigator.clipboard.writeText(text).catch(err => fallbackCopy(text));
        } else {
            fallbackCopy(text);
        }
    }

    function fallbackCopy(text) {
        const textArea = document.createElement("textarea");
        textArea.value = text;
        textArea.style.position = "fixed"; textArea.style.left = "-9999px";
        document.body.appendChild(textArea);
        textArea.focus(); textArea.select();
        try { document.execCommand('copy'); } catch (err) {}
        document.body.removeChild(textArea);
    }

    function redirect(type) {
        const item = Object.keys(ENGINE_STATE.items_detected)[0];
        if(!item) return showToast("NOTHING SELECTED");
        
        forceCopy(item); 
        showToast("LINK COPIED");

        const target = ECOM_DEEP_LINKS.amazon;
        const q = encodeURIComponent(item);

        const start = Date.now();
        window.location.href = target.app(q);
        setTimeout(() => {
            if (Date.now() - start < 2500) window.location.href = target.web(q);
        }, 2000);
    }

    function sendWa() {
        const items = Object.keys(ENGINE_STATE.items_detected).join(', ');
        const text = encodeURIComponent(`DECISION: ${items}`);
        window.open(`https://wa.me/916351537770?text=${text}`);
    }

    function showToast(m) { const t=document.getElementById('toast'); t.innerText=m; t.classList.add('visible'); setTimeout(()=>t.classList.remove('visible'),2000); }
    function initVoice() { /* Basic setup kept */ }

    boot();
</script>
</body>
</html>
