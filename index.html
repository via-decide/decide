<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>| decide.engine v67.3 |</title>

    <link rel="manifest" href="manifest.json">
    <meta name="theme-color" content="#0a0a0a">
    <meta name="background-color" content="#0a0a0a">
    
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>

    <style>
        /* =========================================
           CORE SYSTEM | KUTCH AUTOMATION
           ========================================= */
        :root {
            --brand-orange: #ff671f;
            --brand-bg: #0a0a0a;
            --text-main: #f0f0f0;
            --accent-go: #00e676; 
            --accent-skip: #ff3333;
            --accent-yt: #FF0000;
            --font-tech: 'Courier New', monospace;
            --font-ui: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
        }

        html, body {
            margin: 0; padding: 0; height: 100%; width: 100%;
            background-color: var(--brand-bg);
            color: var(--text-main);
            font-family: var(--font-ui);
            overflow: hidden;
            touch-action: none; user-select: none;
        }

        #master-container { height: 100vh; width: 100vw; position: relative; overflow: hidden; }

        .main-slide {
            height: 100vh; width: 100vw; position: absolute; top: 0; left: 0;
            display: flex; flex-direction: column; background: var(--brand-bg);
            transition: transform 0.5s cubic-bezier(0.2, 0.8, 0.2, 1);
            will-change: transform;
        }

        .main-slide.prev { transform: translateY(-100%); }
        .main-slide.active { transform: translateY(0); z-index: 10; }
        .main-slide.next { transform: translateY(100%); z-index: 20; }

        .slide-header {
            padding: 20px; border-left: 3px solid var(--brand-orange); height: 70px;
            flex-shrink: 0; z-index: 10; display: flex; align-items: center; justify-content: space-between;
            background: var(--brand-bg); position: absolute; top: 0; left: 0; right: 0;
        }

        .header-title {
            font-family: var(--font-tech); font-size: 0.75rem; color: var(--brand-orange);
            letter-spacing: 1px; font-weight: 700; text-transform: uppercase;
        }

        .video-bg {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            object-fit: cover; z-index: -1; opacity: 0.3;
        }
        
        .winner-container {
            flex-grow: 1; display: flex; flex-direction: column; 
            justify-content: flex-end; padding: 30px; 
            background: linear-gradient(to top, #000 95%, transparent);
        }

        .carousel-viewport { position: relative; flex-grow: 1; width: 100%; height: 100%; margin-top: 70px; }

        .sub-slide {
            position: absolute; inset: 0; padding: 25px; display: flex; flex-direction: column;
            justify-content: center; opacity: 0; pointer-events: none; transform: translateX(20px);
            transition: transform 0.3s ease, opacity 0.3s ease;
        }

        .sub-slide.opt-active { z-index: 30; opacity: 1; pointer-events: auto; transform: translateX(0); }
        .sub-slide.opt-hidden { z-index: 0; opacity: 0; pointer-events: none; }
        .sub-slide.static { z-index: 30; opacity: 1; pointer-events: auto; transform: none; }

        h1 { font-size: 1.8rem; margin: 0 0 15px 0; line-height: 1; letter-spacing: -1px; color: var(--brand-orange); }
        .wiki-summary { font-size: 0.9rem; color: #aaa; line-height: 1.6; max-height: 180px; overflow-y: auto; margin-bottom: 20px; }

        .resources-section { margin-top: 15px; padding-top: 15px; border-top: 1px dashed #333; }
        .book-btn {
            background: #232f3e; color: #FF9900; border: 1px solid #FF9900; 
            padding: 12px; width: 100%; border-radius: 8px; font-weight: bold; 
            margin-bottom: 10px; display: flex; align-items: center; justify-content: center; gap: 10px;
            text-transform: uppercase; font-size: 0.8rem; letter-spacing: 1px;
        }
        .support-link {
            text-align: center; font-size: 0.7rem; color: #666; text-decoration: none; 
            display: block; margin-top: 10px; font-family: var(--font-tech); opacity: 0.7;
        }
        .pdf-btn { background: #222; color: #fff; border: 1px solid #444; padding: 5px 10px; border-radius: 4px; font-size: 0.7rem; cursor: pointer; }

        .role-label {
            font-family: var(--font-tech); font-size: 0.6rem; color: #000;
            background: var(--accent-go); padding: 4px 8px; border-radius: 4px;
            width: fit-content; margin-bottom: 15px; font-weight: bold;
        }

        .nav-hint {
            margin-top: 20px; padding-top: 15px; border-top: 1px solid #333;
            font-family: var(--font-tech); font-size: 0.7rem; color: #666;
            display: flex; justify-content: space-between;
        }
        
        .final-actions { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-top: 10px; }
        .btn { background: #222; color: #fff; border: 1px solid #333; padding: 15px; border-radius: 8px; font-weight: 600; text-align: center; font-size: 0.8rem; cursor: pointer; width: 100%; }
        .btn-full { grid-column: span 2; }
        
        .lobby-container { 
            display: flex; flex-direction: column; gap: 15px; padding: 30px; height: 100%; 
            overflow-y: auto; justify-content: flex-start; 
            padding-top: 80px; padding-bottom: 120px; 
            -webkit-overflow-scrolling: touch; 
        }
        .cuisine-btn { background: #222; border: 1px solid #444; color: #888; padding: 20px; font-size: 1.1rem; font-weight: bold; text-transform: uppercase; border-radius: 12px; transition: all 0.2s; flex-shrink: 0; }
        .cuisine-btn.selected { background: var(--brand-orange); color: #000; border-color: var(--brand-orange); }

        .toast-msg { position: fixed; bottom: 100px; left: 50%; transform: translateX(-50%); background: #222; color: #00e676; padding: 10px 20px; border: 1px solid #00e676; border-radius: 20px; font-size: 0.8rem; opacity: 0; pointer-events: none; transition: opacity 0.3s; z-index: 3000; font-family: var(--font-tech); }
        .toast-msg.visible { opacity: 1; }

        #mic-toggle { position: fixed; bottom: 20px; left: 20px; width: 50px; height: 50px; background: #111; border-radius: 50%; display: flex; align-items: center; justify-content: center; border: 1px solid #444; z-index: 2000; cursor: pointer; }
        #mic-toggle.listening { border-color: var(--accent-go); box-shadow: 0 0 15px rgba(0,230,118,0.3); }
        #mic-toggle svg { fill: #666; width: 24px; }
        #depth-fill { position: fixed; right: 0; top: 0; bottom: 0; width: 4px; background: #333; z-index: 900; height: 0%; transition: height 0.05s linear; }
        iframe { width: 100%; height: 100%; border: none; background: #000; }
        .close-iframe { position: fixed; top: 20px; right: 20px; z-index: 100; background: #000; border: 1px solid #333; color: #fff; padding: 10px 20px; border-radius: 20px; font-family: var(--font-tech); font-weight: bold; }
    </style>
</head>
<body>

<div id="master-container"></div>
<div id="depth-fill"></div>
<div id="toast" class="toast-msg"></div>

<script>
    const BACKEND_URL = "https://script.google.com/macros/s/AKfycbxxh1ZwNRwqsSW1Lf62eh2wiwaNKzHWX8Icq472NQVj7-yEvOYuTDuiEGmelW_DG2Zs/exec"; 
    const YOUTUBE_CHANNEL = "https://www.youtube.com/@decide.engine"; 
    const AMZN_TAG = "decideos-21";
    const WINNER_VIDEO = "https://static.videezy.com/system/resources/previews/000/012/628/original/Abstract_Blue_Background.mp4";

    const PHONE_DB = {
      "Poco F7": { attr: { camera: 6.0, gaming: 10.0, battery: 9.0, ui: 4.0 }, tags: ["heavy", "bloatware", "performance"], price: 29999 },
      "iQOO Neo 10R": { attr: { camera: 7.0, gaming: 9.5, battery: 9.0, ui: 6.0 }, tags: ["balanced", "value", "144hz"], price: 30999 },
      "Nothing 3a Pro": { attr: { camera: 8.5, gaming: 7.0, battery: 7.5, ui: 10.0 }, tags: ["clean_ui", "no_charger"], price: 27999 },
      "Xiaomi 14 Civi": { attr: { camera: 9.5, gaming: 6.0, battery: 6.5, ui: 6.0 }, tags: ["camera_king", "compact"], price: 32999 },
      "Vivo V60e": { attr: { camera: 10.0, gaming: 5.0, battery: 7.5, ui: 7.0 }, tags: ["camera_king"], price: 28999 },
      "Samsung A55": { attr: { camera: 8.0, gaming: 4.0, battery: 7.0, ui: 9.5 }, tags: ["trust", "updates"], price: 33999 },
      "Realme GT 7T": { attr: { camera: 6.0, gaming: 9.0, battery: 10.0, ui: 5.0 }, tags: ["battery_king"], price: 31999 },
      "Samsung Galaxy F07": { attr: { camera: 6.0, gaming: 3.0, battery: 9.0, ui: 7.0 }, tags: ["budget"], price: 7499 },
      "Realme Note 60": { attr: { camera: 5.0, gaming: 4.0, battery: 8.0, ui: 6.0 }, tags: ["budget"], price: 7999 }
    };

    const AUDIO_DB = {
      "Technics AZ100": { attr: { anc: 9.0, sound: 9.9 }, price: 22990 },
      "Sony WF-1000XM6": { attr: { anc: 10.0, sound: 9.5 }, price: 24990 },
      "SteelSeries Arctis": { attr: { anc: 7.0, latency: 10.0 }, price: 17999 },
      "OnePlus Nord Buds 3": { attr: { anc: 9.5, sound: 8.0 }, price: 3299 }
    };

    const MODULES = {
        smartphones: { label: "SMARTPHONES", database: PHONE_DB, init: () => renderEcosystemGate(), categories: [{ label: "CAMERA-FIRST", type: "camera" }, { label: "PRO GAMER", type: "gaming" }, { label: "CLEAN UI", type: "ui" }] },
        earbuds: { label: "EARBUDS", database: AUDIO_DB, init: () => { ENGINE_STATE.active_filters=[]; renderSubLobby('earbuds'); }, categories: [{ label: "AUDIOPHILE", type: "sound" }, { label: "ZERO LATENCY", type: "latency" }] },
        food: { label: "DINING", init: () => renderExternalModule("https://via-decide.github.io/food.decider/") },
        research: { label: "RESEARCH", init: () => renderSearchSlide() },
        review: { label: "ENGINE REVIEW â†—", init: () => window.open(YOUTUBE_CHANNEL, '_blank') }
    };

    const WIKI_ENGINE = {
        source: "wiki",
        endpoints: { wiki: "https://en.wikipedia.org/w/api.php" },
        async search(query) {
            const url = `${this.endpoints.wiki}?origin=*&action=opensearch&search=${encodeURIComponent(query)}&limit=1&format=json`;
            const res = await fetch(url);
            const data = await res.json();
            return data[1][0] || null;
        },
        async getContext(title) {
            const url = `${this.endpoints.wiki}?origin=*&action=query&prop=extracts|links&titles=${encodeURIComponent(title)}&exintro=1&explaintext=1&format=json`;
            const res = await fetch(url);
            const data = await res.json();
            const page = Object.values(data.query.pages)[0];
            return { title: page.title, summary: page.extract || "No data.", links: page.links ? page.links.map(l => ({name: l.title})) : [] };
        }
    };

    let ENGINE_STATE = { currentDomain: null, items_detected: {}, active_filters: [], researchPath: [] };
    let slideElements = [];
    let currentIdx = 0;

    async function boot() { renderLobby(); initSwipeSystem(); }

    function renderLobby() {
        const container = document.getElementById('master-container');
        container.innerHTML = "";
        const section = document.createElement('section');
        section.className = "main-slide active";
        let html = `<div class="slide-header"><span class="header-title">DECIDE OS v67.3</span></div><div class="lobby-container"><h1 style="text-align:center">SELECT DOMAIN</h1>`;
        for(let key in MODULES) {
            const isSelected = ENGINE_STATE.currentDomain === key ? "selected" : "";
            html += `<button class="cuisine-btn ${isSelected}" onclick="toggleDomain('${key}', this)">${MODULES[key].label}</button>`;
        }
        html += `<button class="btn btn-auto btn-full" style="margin-top:30px" onclick="handleStart()">NEXT &rarr;</button></div>`;
        section.innerHTML = html;
        container.appendChild(section);
        slideElements = [section];
        currentIdx = 0;
    }

    function toggleDomain(id, btn) {
        ENGINE_STATE.currentDomain = id;
        document.querySelectorAll('.cuisine-btn').forEach(b => b.classList.remove('selected'));
        btn.classList.add('selected');
    }

    function handleStart() {
        if(!ENGINE_STATE.currentDomain) return showToast("SELECT DOMAIN");
        const container = document.getElementById('master-container');
        while(container.children.length > 1) container.removeChild(container.lastChild);
        slideElements = [slideElements[0]];
        MODULES[ENGINE_STATE.currentDomain].init();
    }

    function renderSearchSlide() {
        const container = document.getElementById('master-container');
        const section = document.createElement('section');
        section.className = "main-slide next";
        section.innerHTML = `<div class="slide-header"><span class="header-title">KNOWLEDGE ENGINE</span></div><div class="lobby-container"><h1>TOPIC?</h1><input type="text" id="search-input" placeholder="e.g. AI..."><button class="btn btn-auto btn-full" onclick="executeSearch()">START RESEARCH</button></div>`;
        container.appendChild(section);
        slideElements.push(section);
        goToSlide(1);
    }

    async function executeSearch() {
        const q = document.getElementById('search-input').value;
        if(!q) return showToast("ENTER TOPIC");
        showToast("EXTRACTING...");
        const title = await WIKI_ENGINE.search(q);
        if(!title) return showToast("NOT FOUND");
        const context = await WIKI_ENGINE.getContext(title);
        ENGINE_STATE.researchPath = [{ title: context.title, summary: context.summary }];
        buildResearchDeck(context);
    }

    function buildResearchDeck(ctx) {
        const container = document.getElementById('master-container');
        while(container.children.length > 2) container.removeChild(container.lastChild);
        slideElements = slideElements.slice(0, 2);
        
        const sumSlide = document.createElement('section');
        sumSlide.className = "main-slide next"; sumSlide.dataset.mode = "research";
        sumSlide.innerHTML = `<div class="slide-header"><span class="header-title">DEPTH: ${ENGINE_STATE.researchPath.length}</span><button class="pdf-btn" onclick="generateStoryPDF()">SAVE JOURNEY ðŸ’¾</button></div><div class="carousel-viewport"><div class="sub-slide static"><h1>${ctx.title}</h1><div class="wiki-summary">${ctx.summary}</div><div class="nav-hint"><span>DOWN: BACK</span><span style="color:var(--accent-go)">UP: DIG DEEPER</span></div></div></div>`;
        container.appendChild(sumSlide);
        slideElements.push(sumSlide);

        const linkSlide = document.createElement('section');
        linkSlide.className = "main-slide next"; linkSlide.dataset.mode = "research";
        let html = `<div class="slide-header"><span class="header-title">RELATED</span></div><div class="carousel-viewport">`;
        if(ctx.links.length > 0) {
            ctx.links.slice(0,5).forEach((l, i) => {
                const safe = l.name.replace(/'/g, "\\'");
                html += `<div class="sub-slide ${i===0?'opt-active':'opt-hidden'}" data-val="${safe}"><h1>${l.name}</h1><div class="nav-hint"><span>NEXT</span><span style="color:var(--accent-go)">SELECT &uarr;</span></div></div>`;
            });
        } else { html += `<div class="sub-slide opt-active"><h1>No links.</h1></div>`; }
        html += `</div>`;
        linkSlide.innerHTML = html;
        container.appendChild(linkSlide);
        slideElements.push(linkSlide);
        goToSlide(2);
    }

    async function diveDeeper(t) {
        const ctx = await WIKI_ENGINE.getContext(t);
        ENGINE_STATE.researchPath.push({ title: ctx.title, summary: ctx.summary });
        buildResearchDeck(ctx);
    }

    async function generateStoryPDF() {
        const sessionID = "SES_" + Math.random().toString(36).substr(2, 6).toUpperCase();
        fetch(BACKEND_URL, { method: "POST", mode: "no-cors", body: JSON.stringify({ session_id: sessionID, syllabus: JSON.stringify(ENGINE_STATE.researchPath) })});
        const { jsPDF } = window.jspdf;
        const doc = new jsPDF();
        ENGINE_STATE.researchPath.forEach((item, i) => {
            if(i>0) doc.addPage();
            doc.text(item.title, 20, 20);
            doc.text(doc.splitTextToSize(item.summary, 170), 20, 40);
            doc.text(`Search ID: ${sessionID}`, 20, 280);
        });
        doc.save(`Research_${sessionID}.pdf`);
        showToast("PDF SAVED");
    }

    let touchStartY = 0, touchStartX = 0;
    function initSwipeSystem() {
        document.addEventListener('touchstart', e => { touchStartY = e.touches[0].clientY; touchStartX = e.touches[0].clientX; }, {passive: true});
        document.addEventListener('touchend', e => {
            const view = e.target.closest('.carousel-viewport');
            if(!view || document.querySelector('iframe')) return;
            const dy = e.changedTouches[0].clientY - touchStartY;
            const dx = e.changedTouches[0].clientX - touchStartX;
            const mode = view.closest('.main-slide').dataset.mode;

            if(dy < -80) { // UP -> FORWARD
                const active = view.querySelector('.sub-slide.opt-active') || view.querySelector('.sub-slide.static');
                const val = active ? active.dataset.val : null;
                if(mode === "research" && val) diveDeeper(val);
                else goToSlide(currentIdx + 1);
            } else if (dy > 80) { // DOWN -> BACK
                if(mode === "research" && ENGINE_STATE.researchPath.length > 1) {
                    ENGINE_STATE.researchPath.pop();
                    WIKI_ENGINE.getContext(ENGINE_STATE.researchPath[ENGINE_STATE.researchPath.length-1].title).then(c => buildResearchDeck(c));
                } else goToSlide(currentIdx - 1);
            } else if(Math.abs(dx) > 60) {
                const slides = Array.from(view.querySelectorAll('.sub-slide'));
                const currIdx = slides.findIndex(s => s.classList.contains('opt-active'));
                if(currIdx === -1) return;
                slides[currIdx].classList.replace('opt-active', 'opt-hidden');
                slides[(currIdx + (dx < 0 ? 1 : -1) + slides.length) % slides.length].classList.replace('opt-hidden', 'opt-active');
            }
        });
    }

    function goToSlide(idx) {
        if(idx < 0 || idx >= slideElements.length) return;
        slideElements[currentIdx].classList.replace('active', idx > currentIdx ? 'prev' : 'next');
        currentIdx = idx;
        slideElements[currentIdx].className = "main-slide active";
    }

    function renderExternalModule(url) {
        const container = document.getElementById('master-container');
        container.innerHTML = `<iframe src="${url}"></iframe><button class="close-iframe" onclick="location.reload()">EXIT</button>`;
    }

    function showToast(m) { const t=document.getElementById('toast'); t.innerText=m; t.classList.add('visible'); setTimeout(()=>t.classList.remove('visible'),2000); }
    boot();
</script>
</body>
</html>
